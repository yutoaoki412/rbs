<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理画面 - RBS陸上教室</title>
  <meta name="description" content="RBS陸上教室の管理画面">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="stylesheet" href="./css/components.css">
  <!-- 管理画面専用CSS（モジュラー版） -->
  <link rel="stylesheet" href="./css/admin/admin-core.css">
  <link rel="stylesheet" href="./css/admin/admin-components.css">
  <link rel="stylesheet" href="./css/admin/admin-features.css">
  <link rel="stylesheet" href="./css/admin/admin-responsive.css">
  <link rel="stylesheet" href="./css/admin/admin-preview.css">
  <link rel="stylesheet" href="./css/utilities/style-utils.css">
  <link rel="stylesheet" href="./css/news.css">
  <link rel="stylesheet" href="./css/components/lesson-status-admin.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./assets/images/rds-logo.png">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase統合設定 -->
  <script src="./js/config/supabase-config.js"></script>
</head>
<body class="page-admin">
  <!-- ヘッダー -->
  <header class="admin-header">
    <div class="header-left">
      <i class="fas fa-running admin-logo-icon"></i>
      <span class="admin-logo-text">RBS陸上教室 管理画面</span>
    </div>
    <div class="header-right">
      <div class="notification-settings">
        <button class="notification-toggle-btn" id="notification-toggle" 
                title="通知設定を切り替え" 
                data-action="toggle-notification-mode">
          <i class="fas fa-bell-slash"></i>
          <span class="toggle-text">通知OFF</span>
        </button>
      </div>
      <div class="session-info" id="session-info">
        <i class="fas fa-clock"></i>
        <span id="session-remaining">初期化中...</span>
      </div>
      <button class="logout-btn" data-action="logout" title="ログアウト">
        <i class="fas fa-sign-out-alt"></i>
        ログアウト
      </button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <div class="admin-container">
    <!-- サイドバー -->
    <aside class="admin-sidebar">
      <nav class="sidebar-nav">
        <div class="nav-item active" data-tab="dashboard" data-action="switch-admin-tab">
          <i class="fas fa-chart-line"></i>
          <span>ダッシュボード</span>
        </div>
        <div class="nav-item" data-tab="news-management" data-action="switch-admin-tab">
          <i class="fas fa-newspaper"></i>
          <span>記事管理</span>
        </div>
        <div class="nav-item" data-tab="lesson-status" data-action="switch-admin-tab">
          <i class="fas fa-calendar-check"></i>
          <span>レッスン状況</span>
        </div>
        <div class="nav-item" data-tab="instagram-management" data-action="switch-admin-tab">
          <i class="fab fa-instagram"></i>
          <span>Instagram管理</span>
        </div>
        <div class="nav-item" data-tab="settings" data-action="switch-admin-tab">
          <i class="fas fa-cog"></i>
          <span>設定</span>
        </div>
      </nav>
    </aside>

    <!-- メインエリア -->
    <main class="admin-main dashboard-optimized" id="admin-main">
      <!-- ダッシュボードタブ -->
      <div class="admin-section active" id="dashboard">
        <div class="section-header">
          <h1><i class="fas fa-chart-line"></i> ダッシュボード</h1>
        </div>

        <!-- 統計カード -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon published">
              <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="stat-published">0</div>
              <div class="stat-label">公開記事</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon draft">
              <i class="fas fa-edit"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="stat-drafts">0</div>
              <div class="stat-label">下書き</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon instagram-visible">
              <i class="fab fa-instagram"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="stat-instagram-visible">0</div>
              <div class="stat-label">表示中投稿</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon instagram-hidden">
              <i class="fas fa-eye-slash"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="stat-instagram-hidden">0</div>
              <div class="stat-label">非表示投稿</div>
            </div>
          </div>
        </div>

        <!-- ダッシュボードウィジェット -->
        <div class="dashboard-widgets">
          <div class="widget recent-articles-widget">
            <div class="widget-header">
              <h2><i class="fas fa-newspaper"></i> 最近の記事</h2>
              <div class="widget-header-actions">
                <button class="btn-icon" data-action="refresh-recent-articles" title="更新">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
            <div class="widget-content">
              <div id="recent-articles" class="admin-news-container">
                <div class="loading-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  記事を読み込み中...
                </div>
              </div>
            </div>
          </div>

          <!-- クイックアクション -->
          <div class="widget quick-actions">
            <div class="widget-header">
              <h2><i class="fas fa-bolt"></i> クイックアクション</h2>
            </div>
            <div class="widget-content">
              <div class="action-buttons-grid">
                <!-- 新規記事作成 -->
                <button class="action-btn compact success" data-action="new-news-article">
                  <div class="action-icon">
                    <i class="fas fa-plus"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">新規記事作成</span>
                  </div>
                </button>

                <!-- データエクスポート -->
                <button class="action-btn compact info" data-action="export-data">
                  <div class="action-icon">
                    <i class="fas fa-download"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">統合データエクスポート</span>
                  </div>
                </button>

                <!-- エクスポート履歴 -->
                <button class="action-btn compact warning" data-action="show-export-history">
                  <div class="action-icon">
                    <i class="fas fa-history"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">エクスポート履歴</span>
                  </div>
                </button>

                <!-- データ完全性チェック -->
                <button class="action-btn compact secondary" data-action="show-data-integrity-report">
                  <div class="action-icon">
                    <i class="fas fa-shield-alt"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">データ完全性チェック</span>
                  </div>
                </button>

                <!-- レッスン状況更新 -->
                <button class="action-btn compact warning" data-action="update-lesson-status">
                  <div class="action-icon">
                    <i class="fas fa-calendar-check"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">レッスン状況</span>
                  </div>
                </button>

                <!-- 設定ページへのリンク -->
                <button class="action-btn compact secondary" data-action="switch-admin-tab" data-tab="settings">
                  <div class="action-icon">
                    <i class="fas fa-cog"></i>
                  </div>
                  <div class="action-content">
                    <span class="action-title">システム設定</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 記事管理タブ -->
      <div class="admin-section" id="news-management">
        <div class="section-header">
          <h1><i class="fas fa-newspaper"></i> 記事管理</h1>
        </div>
        
        <!-- 記事管理用のタブナビゲーション -->
        <div class="sub-nav">
          <div class="sub-nav-item active" data-action="switch-news-tab" data-tab="editor">
            <i class="fas fa-edit"></i>
            新規記事作成
          </div>
          <div class="sub-nav-item" data-action="switch-news-tab" data-tab="list">
            <i class="fas fa-list"></i>
            記事一覧
          </div>
        </div>
        
        <!-- エディタータブ -->
        <div id="news-editor-tab" class="news-tab-content active">
          <div class="editor-panel">
            <div class="panel-header">
              <h2><i class="fas fa-edit"></i> <span id="editor-title">新規記事作成</span></h2>
              <div class="panel-actions">
                <button class="btn-editor btn-clear" data-action="clear-news-editor">
                  <i class="fas fa-undo"></i>
                  クリア
                </button>
                <button class="btn-editor btn-preview" data-action="preview-news">
                  <i class="fas fa-eye"></i>
                  プレビュー
                </button>
                <button class="btn-editor btn-save" data-action="save-news">
                  <i class="fas fa-save"></i>
                  下書き保存
                </button>
                <button class="btn-editor btn-publish" data-action="publish-news">
                  <i class="fas fa-globe"></i>
                  公開
                </button>
              </div>
            </div>
            
            <form class="editor-form">
              <input type="hidden" id="news-id">
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="news-title">
                    タイトル <span class="required">*</span>
                  </label>
                  <input type="text" id="news-title" class="form-input" placeholder="記事のタイトルを入力してください" required>
                </div>
                <div class="form-group">
                  <label for="news-category">
                    カテゴリー
                  </label>
                  <select id="news-category" class="form-select">
                    <option value="announcement">お知らせ</option>
                    <option value="event">体験会</option>
                    <option value="media">メディア</option>
                    <option value="important">重要</option>
                  </select>
                </div>
              </div>
              

              
              <div class="form-group">
                <label for="news-summary">
                  概要
                </label>
                <textarea id="news-summary" class="form-textarea" rows="3" placeholder="記事の概要を入力してください（記事一覧で表示されます）"></textarea>
              </div>
              
              <div class="form-group">
                <label for="news-content">
                  本文 <span class="required">*</span>
                </label>
                <div class="editor-toolbar">
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="**" data-end="**" title="太字">
                    <strong>B</strong>
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="*" data-end="*" title="イタリック">
                    <em>I</em>
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="## " data-end="" title="見出し H2">
                    H2
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="### " data-end="" title="見出し H3">
                    H3
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="#### " data-end="" title="見出し H4">
                    H4
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="> " data-end="" title="引用">
                    <i class="fas fa-quote-left"></i>
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="- " data-end="" title="リスト">
                    <i class="fas fa-list-ul"></i>
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="[" data-end="](URL)" title="リンク">
                    <i class="fas fa-link"></i>
                  </button>
                  <button type="button" class="toolbar-btn help-btn" data-action="show-writing-guide" title="記事作成ガイド">
                    <i class="fas fa-book-open"></i>
                    ガイド
                  </button>
                </div>
                <textarea id="news-content" class="form-textarea editor-content" placeholder="記事の本文をMarkdown形式で入力してください" required></textarea>
                <div class="form-help">
                  <small>Markdown記法: **太字**、*イタリック*、## 見出し、### 小見出し、> 引用、- リスト、[リンク](URL)</small>
                </div>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="news-featured"> 注目記事として表示する
                </label>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 記事一覧タブ -->
        <div id="news-list-tab" class="news-tab-content">
          <div class="list-panel full-width">
            <div class="panel-header">
              <h2><i class="fas fa-list"></i> 記事一覧</h2>
              <div class="panel-filters">
                <select id="news-filter" class="form-select" data-action="filter-news-list" data-target="news-filter">
                  <option value="all">すべて</option>
                  <option value="published">公開中</option>
                  <option value="draft">下書き</option>
                </select>
                <button class="btn btn-outline" data-action="refresh-news-list">
                  更新
                </button>
              </div>
            </div>
            <div id="news-list" class="list-content admin-news-container">
              <!-- 記事一覧がここに表示される -->
              <div class="loading-state">
                記事を読み込み中...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- レッスン状況タブ -->
      <div class="admin-section" id="lesson-status">
        <div class="section-header">
          <h1><i class="fas fa-calendar-check"></i> レッスン状況管理</h1>
        </div>

        <!-- 現在の状況表示 -->
        <div class="current-status-card">
          <div class="status-header">
            <h3><i class="fas fa-info-circle"></i> 現在の状況</h3>
            <span class="status-date" id="current-status-date">今日</span>
          </div>
          <div class="status-display" id="current-status-display">
            <div class="status-indicator">
              <i class="fas fa-check-circle status-icon"></i>
              <span class="status-text">通常開催</span>
            </div>
            <div class="status-updated">
              最終更新: <span id="last-updated">-</span>
            </div>
          </div>
        </div>

        <!-- 設定フォーム -->
        <div class="lesson-form-container">
          <div class="form-header">
            <h3><i class="fas fa-edit"></i> レッスン状況を設定</h3>
            <div class="form-controls">
              <input type="date" id="lesson-date" class="date-input">
              <button class="btn btn-outline" data-action="load-lesson-status" id="load-btn">
                <i class="fas fa-download"></i> 読み込み
              </button>
            </div>
          </div>

          <form class="lesson-form" id="lesson-form">
            <!-- 全体ステータス -->
            <div class="form-section">
              <label class="section-label">
                <i class="fas fa-bullhorn"></i>
                全体開催ステータス
              </label>
              <div class="status-options">
                <label class="status-option">
                  <input type="radio" name="global-status" value="scheduled" checked>
                  <div class="option-card scheduled">
                    <i class="fas fa-check-circle"></i>
                    <span>通常開催</span>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="global-status" value="cancelled">
                  <div class="option-card cancelled">
                    <i class="fas fa-times-circle"></i>
                    <span>中止</span>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="global-status" value="indoor">
                  <div class="option-card indoor">
                    <i class="fas fa-home"></i>
                    <span>室内開催</span>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="global-status" value="postponed">
                  <div class="option-card postponed">
                    <i class="fas fa-clock"></i>
                    <span>延期</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- 全体メッセージ -->
            <div class="form-section">
              <label for="global-message" class="section-label">
                <i class="fas fa-comment"></i>
                全体向けメッセージ（任意）
              </label>
              <textarea id="global-message" placeholder="保護者向けの追加メッセージがあれば入力してください" rows="3"></textarea>
            </div>

            <!-- コース別設定 -->
            <div class="form-section">
              <label class="section-label">
                <i class="fas fa-users"></i>
                コース別設定
              </label>
              
              <div class="course-settings">
                <!-- ベーシックコース -->
                <div class="course-card">
                  <div class="course-header">
                    <h4>ベーシックコース</h4>
                    <span class="course-time">17:00 - 17:50</span>
                  </div>
                  <div class="course-options">
                    <label class="course-option">
                      <input type="radio" name="basic-status" value="scheduled" checked>
                      <span class="option-text scheduled">
                        <i class="fas fa-check-circle"></i>
                        通常開催
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="basic-status" value="cancelled">
                      <span class="option-text cancelled">
                        <i class="fas fa-times-circle"></i>
                        中止
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="basic-status" value="indoor">
                      <span class="option-text indoor">
                        <i class="fas fa-home"></i>
                        室内開催
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="basic-status" value="postponed">
                      <span class="option-text postponed">
                        <i class="fas fa-clock"></i>
                        延期
                      </span>
                    </label>
                  </div>
                </div>

                <!-- アドバンスコース -->
                <div class="course-card">
                  <div class="course-header">
                    <h4>アドバンスコース</h4>
                    <span class="course-time">18:00 - 18:50</span>
                  </div>
                  <div class="course-options">
                    <label class="course-option">
                      <input type="radio" name="advance-status" value="scheduled" checked>
                      <span class="option-text scheduled">
                        <i class="fas fa-check-circle"></i>
                        通常開催
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="advance-status" value="cancelled">
                      <span class="option-text cancelled">
                        <i class="fas fa-times-circle"></i>
                        中止
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="advance-status" value="indoor">
                      <span class="option-text indoor">
                        <i class="fas fa-home"></i>
                        室内開催
                      </span>
                    </label>
                    <label class="course-option">
                      <input type="radio" name="advance-status" value="postponed">
                      <span class="option-text postponed">
                        <i class="fas fa-clock"></i>
                        延期
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- アクションボタン -->
            <div class="form-actions panel-actions">
              <button type="button" class="btn-editor btn-preview" data-action="preview-lesson-status">
                <i class="fas fa-eye"></i>
                プレビュー
              </button>
              <button type="button" class="btn-editor btn-save" data-action="save-draft-lesson-status">
                <i class="fas fa-save"></i>
                下書き保存
              </button>
              <button type="button" class="btn-editor btn-publish" data-action="update-lesson-status">
                <i class="fas fa-upload"></i>
                保存して公開
              </button>
            </div>
          </form>
        </div>

        <!-- プレビューエリア -->
        <div class="preview-container preview-hidden" id="preview-container">
          <div class="preview-header">
            <h3><i class="fas fa-eye"></i> プレビュー</h3>
            <button class="btn btn-sm" onclick="this.closest('.preview-container').classList.add('preview-hidden'); this.closest('.preview-container').classList.remove('preview-visible');">
              <i class="fas fa-times"></i> 閉じる
            </button>
          </div>
          <div class="preview-content" id="preview-content">
            <!-- プレビュー内容 -->
          </div>
        </div>
      </div>

      <!-- Instagram管理タブ -->
      <div class="admin-section" id="instagram-management">
        <div class="section-header">
          <h1><i class="fab fa-instagram"></i> Instagram管理</h1>
        </div>
        
        <!-- Instagram管理用のタブナビゲーション -->
        <div class="sub-nav">
          <div class="sub-nav-item active" data-action="switch-instagram-tab" data-tab="posts">
            <i class="fas fa-images"></i>
            投稿管理
          </div>
          <div class="sub-nav-item" data-action="switch-instagram-tab" data-tab="settings">
            <i class="fas fa-cog"></i>
            Instagram設定
          </div>
        </div>
        
        <!-- 投稿管理タブ -->
        <div id="instagram-posts-tab" class="instagram-tab-content active">
          <div class="instagram-simple-layout">
            <!-- 投稿追加フォーム -->
            <div class="instagram-add-form">
              <div class="form-header">
                <h2><i class="fab fa-instagram"></i> Instagram投稿を追加</h2>
              </div>
              
              <form class="simple-form" id="instagram-post-form">
                <input type="hidden" id="instagram-post-id">
                
                <div class="embed-input-group">
                  <textarea id="instagram-embed-code" 
                           class="embed-textarea" 
                           placeholder="" 
                           rows="8"
                           required></textarea>
                  <div class="embed-hint">
                    <i class="fas fa-info-circle"></i>
                    Instagram投稿ページで「埋め込み」を選択してコードをコピーし、上記に貼り付けてください
                  </div>
                  <button type="button" class="add-btn" data-action="save-instagram-post">
                    <i class="fas fa-plus"></i>
                    追加
                  </button>
                </div>
                
                <div class="settings-row">
                  <label class="toggle-switch">
                    <input type="checkbox" id="instagram-status" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">表示する</span>
                  </label>
                  
                  <label class="featured-checkbox">
                    <input type="checkbox" id="instagram-featured">
                    <span class="checkmark"></span>
                    <span class="featured-label">
                      <i class="fas fa-star"></i>
                      注目投稿
                    </span>
                  </label>
                </div>
              </form>
            </div>

            <!-- 投稿一覧 -->
            <div class="instagram-posts-container">
              <div class="posts-header">
                <h3><i class="fas fa-images"></i> 登録済み投稿</h3>
                <div class="posts-actions">
                  <select id="instagram-filter" class="filter-select" data-action="filter-instagram-list">
                    <option value="all">すべて</option>
                    <option value="active">表示中</option>
                    <option value="inactive">非表示</option>
                    <option value="featured">注目投稿</option>
                  </select>
                </div>
              </div>
              
              <div id="instagram-posts-list" class="posts-grid">
                <div class="loading-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  Instagram投稿を読み込み中...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Instagram設定タブ -->
        <div id="instagram-settings-tab" class="instagram-tab-content">
          <div class="instagram-simple-layout">
            
            <!-- 統計情報 -->
            <div class="stats-overview">
              <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Instagram投稿統計</h2>
                <div class="header-actions">
                  <button class="btn-icon" data-action="refresh-instagram-posts" title="統計を更新">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon total">
                    <i class="fab fa-instagram"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-number" id="total-posts">0</div>
                    <div class="stat-label">総投稿数</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon instagram-visible">
                    <i class="fas fa-eye"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-number" id="active-posts">0</div>
                    <div class="stat-label">表示中</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon featured">
                    <i class="fas fa-star"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-number" id="featured-posts">0</div>
                    <div class="stat-label">注目投稿</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon instagram-hidden">
                    <i class="fas fa-eye-slash"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-number" id="inactive-posts">0</div>
                    <div class="stat-label">非表示</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 表示設定 -->
            <div class="widget display-settings">
              <div class="widget-header">
                <h2><i class="fas fa-cog"></i> Instagram表示設定</h2>
                <div class="widget-header-actions">
                  <button class="btn-icon" data-action="reset-instagram-settings" title="デフォルトに戻す">
                    <i class="fas fa-undo"></i>
                  </button>
                </div>
              </div>
              <div class="widget-content">
                <form class="settings-form" id="instagram-settings-form">
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="max-posts-display" class="form-label">
                        <i class="fas fa-list-ol"></i>
                        最大表示件数
                      </label>
                      <select id="max-posts-display" class="form-select">
                        <!-- 動的に生成される -->
                      </select>
                      <small class="form-help">フロントページに表示するInstagram投稿の最大件数</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-external-link-alt"></i>
                        リンク動作
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="open-new-tab" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">新しいタブで開く</span>
                      </label>
                      <small class="form-help">Instagram投稿をクリックした際の動作を設定</small>
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="button" class="btn btn-primary" data-action="save-instagram-settings">
                      <i class="fas fa-save"></i>
                      設定を保存
                    </button>
                    <button type="button" class="btn btn-outline" data-action="test-instagram-settings">
                      <i class="fas fa-eye"></i>
                      プレビュー
                    </button>
                  </div>
                </form>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- 設定タブ -->
      <div class="admin-section" id="settings">
        <div class="section-header">
          <h1><i class="fas fa-cog"></i> 設定</h1>
        </div>

        <!-- 設定用のタブナビゲーション -->
        <div class="sub-nav">
          <div class="sub-nav-item active" data-action="switch-settings-tab" data-tab="basic">
            <i class="fas fa-sliders-h"></i>
            基本設定
          </div>
          <div class="sub-nav-item" data-action="switch-settings-tab" data-tab="data">
            <i class="fas fa-database"></i>
            データ管理
          </div>
        </div>

        <!-- 基本設定タブ -->
        <div id="settings-basic-tab" class="settings-tab-content active">
          <div class="dashboard-widgets">
            <!-- 管理画面設定ウィジェット -->
            <div class="widget">
              <div class="widget-header">
                <h2><i class="fas fa-sliders-h"></i> 管理画面設定</h2>
              </div>
              <div class="widget-content">
                <form class="settings-form" id="admin-settings-form" data-auto-load="true">
                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-bell"></i>
                        通知設定
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="notifications-enabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">通知を有効にする</span>
                      </label>
                      <small class="form-help">操作の完了やエラーの通知を表示します</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-save"></i>
                        自動保存
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="auto-save-enabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">自動保存を有効にする</span>
                      </label>
                      <small class="form-help">記事編集時に自動で下書きを保存します</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-clock"></i>
                        自動保存間隔
                      </label>
                      <select id="auto-save-interval" class="form-select">
                        <option value="30">30秒</option>
                        <option value="60" selected>1分</option>
                        <option value="120">2分</option>
                        <option value="300">5分</option>
                      </select>
                      <small class="form-help">記事編集時の自動保存間隔を設定できます</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-palette"></i>
                        テーマ設定
                      </label>
                      <select id="admin-theme" class="form-select">
                        <option value="light" selected>ライトテーマ</option>
                        <option value="dark">ダークテーマ</option>
                        <option value="auto">システム設定に従う</option>
                      </select>
                      <small class="form-help">管理画面の外観テーマを選択できます</small>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- 動作設定 -->
            <div class="widget">
              <div class="widget-header">
                <h2><i class="fas fa-cogs"></i> 動作設定</h2>
              </div>
              <div class="widget-content">
                <form class="settings-form">
                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-trash"></i>
                        削除時の確認
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="confirm-before-delete" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">削除前に確認ダイアログを表示</span>
                      </label>
                      <small class="form-help">記事や投稿を削除する前に確認を求めます</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-eye"></i>
                        公開前プレビュー
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="preview-before-publish" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">公開前にプレビューを表示</span>
                      </label>
                      <small class="form-help">記事公開前にプレビューを自動表示します</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label">
                        <i class="fas fa-database"></i>
                        自動バックアップ
                      </label>
                      <label class="toggle-switch">
                        <input type="checkbox" id="auto-backup-enabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">定期的な自動バックアップ</span>
                      </label>
                      <small class="form-help">データの自動バックアップを有効にします</small>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- 設定操作 -->
            <div class="widget">
              <div class="widget-header">
                <h2><i class="fas fa-tools"></i> 設定操作</h2>
              </div>
              <div class="widget-content">
                <div class="action-buttons-grid">
                  <button class="action-btn compact success" data-action="save-admin-settings">
                    <div class="action-icon">
                      <i class="fas fa-save"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">設定を保存</span>
                    </div>
                  </button>

                  <button class="action-btn compact warning" data-action="reset-admin-settings">
                    <div class="action-icon">
                      <i class="fas fa-undo"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">設定をリセット</span>
                    </div>
                  </button>

                  <button class="action-btn compact secondary" data-action="test-site-connection">
                    <div class="action-icon">
                      <i class="fas fa-link"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">サイト連携テスト</span>
                    </div>
                  </button>

                  <button class="action-btn compact info" data-action="open-external" data-url="./index.html">
                    <div class="action-icon">
                      <i class="fas fa-external-link-alt"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">サイトを確認</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- データ管理タブ -->
        <div id="settings-data-tab" class="settings-tab-content">
          <!-- システム統計 -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon published">
                <i class="fas fa-newspaper"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="total-articles">0</div>
                <div class="stat-label">記事総数</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon instagram-visible">
                <i class="fab fa-instagram"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="total-instagram">0</div>
                <div class="stat-label">Instagram投稿</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon draft">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="total-lessons">0</div>
                <div class="stat-label">レッスン記録</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon total">
                <i class="fas fa-hdd"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="storage-usage">-</div>
                <div class="stat-label">ストレージ使用量</div>
              </div>
            </div>
          </div>

          <!-- データ管理アクション -->
          <div class="dashboard-widgets">
            <div class="widget quick-actions">
              <div class="widget-header">
                <h2><i class="fas fa-database"></i> データ操作</h2>
                <div class="widget-header-actions">
                  <button class="btn-icon" data-action="refresh-data-stats" title="統計を更新">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
              <div class="widget-content">
                <div class="action-buttons-grid">
                  <button class="action-btn compact data-action" data-action="export-data" data-color="success">
                    <div class="action-icon">
                      <i class="fas fa-download"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">統合データエクスポート</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="import-data" data-color="info">
                    <div class="action-icon">
                      <i class="fas fa-upload"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">統合データインポート</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="export-data-by-category" data-category="articles" data-color="gray">
                    <div class="action-icon">
                      <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">記事データのみ</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="export-data-by-category" data-category="instagram" data-color="purple">
                    <div class="action-icon">
                      <i class="fab fa-instagram"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">Instagramデータのみ</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="export-data-by-category" data-category="lessons" data-color="orange">
                    <div class="action-icon">
                      <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">レッスンデータのみ</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="show-data-integrity-report" data-color="secondary">
                    <div class="action-icon">
                      <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">データ完全性チェック</span>
                    </div>
                  </button>
                  
                  <button class="action-btn compact data-action" data-action="clear-all-data" data-color="warning">
                    <div class="action-icon">
                      <i class="fas fa-trash"></i>
                    </div>
                    <div class="action-content">
                      <span class="action-title">全データクリア</span>
                    </div>
                  </button>
                </div>
                
                <div class="widget-info">
                  <i class="fas fa-info-circle"></i>
                  <p>統合エクスポート機能では記事、Instagram投稿、レッスンステータス、設定データなど全ての Local Storage データを包括的にバックアップできます。カテゴリ別エクスポートでは特定のデータタイプのみを選択してダウンロードできます。</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- モーダル -->
  <div id="modal" class="modal modal-hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button class="modal-close" data-action="close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- プレビュー内容がここに表示される -->
      </div>
    </div>
  </div>

  <!-- 通知エリア（改善された位置とスタイル） -->
  <div id="notification-container" class="notification-container fixed-top-right">
    <!-- 通知がここに表示される -->
  </div>

  <!-- Supabase設定 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase設定
    window.SUPABASE_URL = 'https://ppmlieqwarnfdlsqqxoc.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWxpZXF3YXJuZmRsc3FxeG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODA1NzksImV4cCI6MjA2NTM1NjU3OX0.MxsDqZcpgRanYDLYwy9cuFvPzQkMH2_xdC2t5TxcnPg';
    
    // 開発環境の場合は実際の値を設定してください
    if (window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
      console.log('🔧 開発環境: 統合設定を使用');
    }
  </script>

  <!-- 完全内蔵型SimpleAdminCore - ファイルプロトコル完全対応版 -->
  <script>
    /**
     * 完全内蔵型SimpleAdminCore - v4.2.0
     * ES Modules importを一切使わず、ファイルプロトコルで完全動作
     */
    class InlineSimpleAdminCore {
      constructor() {
        this.state = {
          initialized: false,
          currentTab: 'dashboard',
          supabaseConnected: false,
          authenticated: false,
          currentUser: null,
          services: new Map(),
          modules: new Map()
        };
        
        this.config = {
          autoSave: true,
          notifications: true,
          debugMode: true
        };
        
        this.supabase = null;
      }

      async init() {
        if (this.state.initialized) return this;
        
        try {
          console.log('🚀 内蔵SimpleAdminCore初期化開始');
          
          await this.initializeSupabase();
          this.initializeBasicServices();
          this.setupEventHandlers();
          this.activateInitialTab();
          
          // 認証UI更新
          this.updateAuthenticationUI();
          
          this.state.initialized = true;
          this.showNotification('管理画面が初期化されました', 'success');
          
          console.log('✅ 内蔵SimpleAdminCore初期化完了');
          return this;
        } catch (error) {
          console.error('内蔵SimpleAdminCore初期化エラー:', error);
          this.state.initialized = true; // エラーでも基本機能は提供
          this.showNotification('フォールバックモードで動作中', 'warning');
          return this;
        }
      }

            async initializeSupabase() {
        try {
          console.log('🔐 認証システム初期化開始');
          
          // Supabaseクライアント初期化
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            this.supabase = window.supabase.createClient(
              window.SUPABASE_URL,
              window.SUPABASE_ANON_KEY
            );
            console.log('✅ Supabaseクライアント初期化完了');
          } else {
            throw new Error('Supabase設定が見つかりません');
          }
          
          this.state.supabaseConnected = true;
          
          // 認証状態確認
          const { data: { session }, error } = await this.supabase.auth.getSession();
          
          if (error || !session || !this.isAdminUser(session.user)) {
            console.log('🔐 認証が必要です → ログイン画面にリダイレクト');
            this.redirectToLogin();
            return;
          }
          
          // 認証成功
          this.state.authenticated = true;
          this.state.currentUser = session.user;
          console.log('✅ 認証確認完了:', session.user.email);
          
        } catch (error) {
          console.error('❌ 認証システム初期化エラー:', error);
          this.showNotification('認証システムの初期化に失敗しました', 'error');
          this.redirectToLogin();
          return;
        }
      }

      // 管理者権限確認
      isAdminUser(user) {
        if (!user) return false;
        
        // 1. メタデータのroleをチェック（優先）
        if (user.user_metadata && user.user_metadata.role === 'admin') {
          return true;
        }
        
        // 2. フォールバック: 管理者メールアドレスの確認
        const adminEmails = ['yaoki412rad@gmail.com'];
        return adminEmails.includes(user.email);
      }



      // ログイン画面へのリダイレクト
      redirectToLogin() {
        console.log('🔐 ログイン画面にリダイレクト中...');
        this.showNotification('認証が必要です。ログイン画面に移動します...', 'warning');
        
        setTimeout(() => {
          window.location.href = 'admin-login.html?from=admin';
        }, 1500);
              }









      initializeBasicServices() {
        // 通知サービス
        this.state.services.set('notification', {
          show: (message, type) => this.showNotification(message, type)
        });

        // 設定サービス（メモリベース）
        this.state.services.set('settings', {
          saveAdminTab: async (tabName) => {
            try {
              // メモリベースのタブ状態管理
              this.state.currentTab = tabName;
              console.log(`タブ設定保存（メモリ）: ${tabName}`);
            } catch (error) {
              console.warn('タブ保存エラー:', error.message);
            }
          },
          getAdminTab: async () => {
            try {
              // メモリから取得
              return this.state.currentTab || 'dashboard';
            } catch (error) {
              return 'dashboard';
            }
          }
        });

        console.log('✅ 基本サービス初期化完了');
      }

      setupEventHandlers() {
        // 統一されたアクションベースのイベント委譲システム
        document.addEventListener('click', (e) => {
          const actionElement = e.target.closest('[data-action]');
          if (!actionElement) return;
          
          const action = actionElement.dataset.action;
          e.preventDefault();
          
          try {
            // アクションごとの処理
            switch (action) {
              case 'switch-admin-tab':
                const tabName = actionElement.dataset.tab;
                if (tabName) {
                  this.switchTab(tabName);
                } else {
                  console.warn('タブ名が指定されていません:', actionElement);
                }
                break;
                
              case 'switch-news-tab':
                this.switchNewsTab(actionElement.dataset.tab);
                break;
                
              case 'switch-instagram-tab':
                this.switchInstagramTab(actionElement.dataset.tab);
                break;
                
              case 'switch-settings-tab':
                this.switchSettingsTab(actionElement.dataset.tab);
                break;
                
              case 'logout':
                this.handleLogout();
                break;
                
              case 'close-modal':
                this.closeModal();
                break;
                
              // 記事管理アクション
              case 'save-news':
                this.saveNewsArticle(false);
                break;
                
              case 'publish-news':
                this.publishNewsArticle();
                break;
                
              case 'preview-news':
                this.previewNewsArticle();
                break;
                
              case 'clear-news-editor':
                this.clearNewsEditor();
                break;
                
              case 'new-news-article':
                this.createNewNewsArticle();
                break;
                
              case 'refresh-news-list':
                this.refreshNewsList();
                break;
                
                             case 'filter-news-list':
                 this.filterNewsList(actionElement.value);
                 break;
                 
               case 'edit-article':
                 this.editArticle(actionElement.dataset.id);
                 break;
                 
               case 'delete-article':
                 this.confirmDeleteArticle(actionElement.dataset.id);
                 break;
                 
                             case 'preview-article':
                this.previewArticleById(actionElement.dataset.id);
                break;
                
              // Instagram管理アクション
              case 'save-instagram-post':
                this.saveInstagramPost();
                break;
                
              case 'refresh-instagram-posts':
                this.refreshInstagramPosts();
                break;
                
              case 'filter-instagram-list':
                this.filterInstagramList(actionElement.value);
                break;
                
              case 'edit-instagram-post':
                this.editInstagramPost(actionElement.dataset.id);
                break;
                
              case 'delete-instagram-post':
                this.confirmDeleteInstagramPost(actionElement.dataset.id);
                break;
                
              case 'toggle-instagram-visibility':
                this.toggleInstagramVisibility(actionElement.dataset.id);
                break;
                
              default:
                console.log(`アクションを実行: ${action}`, actionElement);
                this.executeAction(action, actionElement);
                break;
            }
          } catch (error) {
            console.error(`アクション実行エラー [${action}]:`, error);
            this.showNotification(`操作の実行に失敗しました: ${action}`, 'error');
          }
        });

        // フォーム自動保存
        if (this.config.autoSave) {
          document.addEventListener('input', this.debounce((e) => {
            if (e.target.matches('.auto-save, input, textarea')) {
              this.autoSave(e.target);
            }
          }, 2000));
        }

        console.log('✅ 統一イベントハンドラシステム設定完了');
      }

      switchTab(tabName) {
        if (!tabName) {
          console.error('タブ名が指定されていません');
          this.showNotification('タブ名が指定されていません', 'error');
          return;
        }
        
        if (this.state.currentTab === tabName) {
          console.log(`既に${tabName}タブが選択されています`);
          return;
        }
        
        try {
          console.log(`タブ切り替え: ${this.state.currentTab} → ${tabName}`);
          
          // 対象要素の事前チェック
          const section = document.getElementById(tabName);
          const navItem = document.querySelector(`[data-tab="${tabName}"]`);
          
          if (!section) {
            throw new Error(`セクション要素が見つかりません: #${tabName}`);
          }
          
          // すべてのタブを非アクティブ化
          document.querySelectorAll('.admin-section').forEach(el => {
            el.classList.remove('active');
          });
          
          document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('active');
          });

          // 選択されたタブをアクティブ化
          section.classList.add('active');
          if (navItem) {
            navItem.classList.add('active');
          } else {
            console.warn(`ナビゲーション要素が見つかりません: [data-tab="${tabName}"]`);
          }
          
          // 状態更新
          const previousTab = this.state.currentTab;
          this.state.currentTab = tabName;
          
          // 成功通知
          const tabLabel = this.getTabLabel(tabName);
          this.showNotification(`${tabLabel}に切り替えました`, 'success');
          
          // タブ状態を保存
          const settingsService = this.state.services.get('settings');
          if (settingsService) {
            settingsService.saveAdminTab(tabName);
          }
          
          // タブ切り替え後の処理
          this.onTabSwitched(tabName, previousTab);
          
          console.log(`✅ タブ切り替え完了: ${tabName}`);
          
        } catch (error) {
          console.error('タブ切り替えエラー:', error);
          this.showNotification(`タブの切り替えに失敗しました: ${error.message}`, 'error');
          
          // エラー時のフォールバック
          if (this.state.currentTab !== 'dashboard') {
            console.log('ダッシュボードにフォールバック');
            this.switchTab('dashboard');
          }
        }
      }

      // タブ切り替え後の追加処理
      onTabSwitched(newTab, previousTab) {
        try {
          // タブごとの初期化処理
          switch (newTab) {
            case 'dashboard':
              this.initializeDashboard();
              break;
            case 'news-management':
              this.initializeNewsManagement();
              break;
            case 'lesson-status':
              this.initializeLessonStatus();
              break;
            case 'instagram-management':
              this.initializeInstagramManagement();
              break;
            case 'settings':
              this.initializeSettings();
              break;
          }
        } catch (error) {
          console.warn(`タブ初期化エラー [${newTab}]:`, error);
        }
      }

      // サブタブ切り替えメソッド群
      switchNewsTab(tabName) {
        this.switchSubTab('news', tabName, '.news-tab-content');
      }

      switchInstagramTab(tabName) {
        this.switchSubTab('instagram', tabName, '.instagram-tab-content');
      }

      switchSettingsTab(tabName) {
        this.switchSubTab('settings', tabName, '.settings-tab-content');
      }

      switchSubTab(parentTab, tabName, contentSelector) {
        try {
          if (!tabName) {
            console.warn(`${parentTab}サブタブ名が指定されていません`);
            return;
          }

          // サブナビゲーションの更新
          document.querySelectorAll(`#${parentTab}-management .sub-nav-item, #${parentTab} .sub-nav-item`).forEach(item => {
            item.classList.remove('active');
          });

          // サブコンテンツの更新
          document.querySelectorAll(contentSelector).forEach(content => {
            content.classList.remove('active');
          });

          // 対象要素をアクティブ化
          const navItem = document.querySelector(`[data-action="switch-${parentTab}-tab"][data-tab="${tabName}"]`);
          const content = document.getElementById(`${parentTab}-${tabName}-tab`);

          if (navItem) navItem.classList.add('active');
          if (content) content.classList.add('active');

          console.log(`${parentTab}サブタブ切り替え: ${tabName}`);

        } catch (error) {
          console.error(`${parentTab}サブタブ切り替えエラー:`, error);
          this.showNotification(`サブタブの切り替えに失敗しました`, 'error');
        }
      }

      // 各タブの初期化メソッド群
      initializeDashboard() {
        console.log('ダッシュボード初期化');
        // ダッシュボード固有の初期化処理
      }

      async initializeNewsManagement() {
        console.log('記事管理初期化');
        
        try {
          // 記事一覧を読み込み
          await this.refreshNewsList();
          
        } catch (error) {
          console.error('記事管理初期化エラー:', error);
        }
      }

      initializeLessonStatus() {
        console.log('レッスン状況初期化');
        // レッスン状況固有の初期化処理
      }

      initializeInstagramManagement() {
        console.log('Instagram管理初期化');
        // Instagram投稿一覧を読み込み
        this.refreshInstagramPosts();
      }

      initializeSettings() {
        console.log('設定初期化');
        // 設定固有の初期化処理
      }

      // ===========================================
      // 記事管理機能の実装
      // ===========================================

      // フォームデータ取得（統一化・改善版）
      getNewsFormData() {
        try {
          const formData = {
            id: document.getElementById('news-id')?.value || null,
            title: document.getElementById('news-title')?.value?.trim() || '',
            category: this.mapCategoryToSchema(document.getElementById('news-category')?.value || 'announcement'),
            summary: document.getElementById('news-summary')?.value?.trim() || '',
            content: document.getElementById('news-content')?.value?.trim() || '',
            featured: document.getElementById('news-featured')?.checked || false,
          };

          console.log('フォームデータ取得:', formData);
          return formData;
        } catch (error) {
          console.error('フォームデータ取得エラー:', error);
          this.showNotification('フォームデータの取得に失敗しました', 'error');
          return null;
        }
      }

      // カテゴリーをスキーマ準拠形式にマッピング
      mapCategoryToSchema(oldCategory) {
        const categoryMap = {
          'announcement': 'notice',
          'event': 'event',
          'media': 'general',
          'important': 'notice'
        };
        return categoryMap[oldCategory] || 'general';
      }

      // フォームバリデーション（スキーマ制約準拠）
      validateNewsForm(formData) {
        const errors = [];

        // title: NOT NULL制約
        if (!formData.title || formData.title.length === 0) {
          errors.push('タイトルは必須項目です');
        }

        // title長さ制限（実用的制限）
        if (formData.title && formData.title.length > 200) {
          errors.push('タイトルは200文字以内で入力してください');
        }

        // content: 実用的バリデーション
        if (!formData.content || formData.content.length === 0) {
          errors.push('記事本文は必須項目です');
        }

        // summary長さ制限
        if (formData.summary && formData.summary.length > 500) {
          errors.push('要約は500文字以内で入力してください');
        }

        // category: CHECK制約準拠
        const validCategories = ['general', 'event', 'notice', 'lesson', 'other'];
        if (formData.category && !validCategories.includes(formData.category)) {
          console.warn('無効なカテゴリー:', formData.category, '-> general に変更');
          formData.category = 'general';
        }

        if (errors.length > 0) {
          console.warn('バリデーションエラー:', errors);
          this.showNotification(`入力エラー: ${errors[0]}`, 'warning');
          return false;
        }

        return true;
      }

      // 統一された記事保存処理
      async saveNewsArticle(isDraft = true) {
        try {
          console.log('記事保存開始 (下書き:', isDraft, ')');
          
          // UI状態更新
          const saveButton = document.querySelector('[data-action="save-news"]');
          const originalText = saveButton?.innerHTML;
          if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
          }
          
          this.showNotification('記事を保存しています...', 'info');

          const formData = this.getNewsFormData();
          if (!formData) {
            this.resetButton(saveButton, originalText);
            return;
          }

          if (!this.validateNewsForm(formData)) {
            this.resetButton(saveButton, originalText);
            return;
          }

          // 保存実行
          const result = await this.saveArticleData(formData, isDraft);
          
          if (result.success) {
            const message = isDraft ? '記事を下書き保存しました' : '記事を保存しました';
            this.showNotification(message, 'success');
            
            // フォームのIDフィールドを更新（新規作成の場合）
            if (!formData.id && result.data?.id) {
              document.getElementById('news-id').value = result.data.id;
            }
            
            this.updateEditorTitle(formData.title);
            console.log('✅ 記事保存完了:', result.data);
          } else {
            throw new Error(result.error || '保存に失敗しました');
          }

        } catch (error) {
          console.error('記事保存エラー:', error);
          this.showNotification(`記事の保存に失敗しました: ${error.message}`, 'error');
        } finally {
          // UI状態リセット
          const saveButton = document.querySelector('[data-action="save-news"]');
          const originalText = '<i class="fas fa-save"></i> 下書き保存';
          this.resetButton(saveButton, originalText);
        }
      }

      // 統一された記事公開処理
      async publishNewsArticle() {
        try {
          console.log('記事公開開始');

          // UI状態更新
          const publishButton = document.querySelector('[data-action="publish-news"]');
          const originalText = publishButton?.innerHTML;
          if (publishButton) {
            publishButton.disabled = true;
            publishButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 公開中...';
          }

          const formData = this.getNewsFormData();
          if (!formData) {
            this.resetButton(publishButton, originalText);
            return;
          }

          if (!this.validateNewsForm(formData)) {
            this.resetButton(publishButton, originalText);
            return;
          }

          // 公開前確認
          if (!confirm('記事を公開しますか？公開後は一般ユーザーに表示されます。')) {
            this.resetButton(publishButton, originalText);
            return;
          }

          this.showNotification('記事を公開しています...', 'info');

          // 公開実行
          const result = await this.saveArticleData(formData, false);
          
          if (result.success) {
            this.showNotification('記事を公開しました！', 'success');
            
            // フォームのIDフィールドを更新（新規作成の場合）
            if (!formData.id && result.data?.id) {
              document.getElementById('news-id').value = result.data.id;
            }
            
            this.updateEditorTitle(formData.title);
            console.log('✅ 記事公開完了:', result.data);
          } else {
            throw new Error(result.error || '公開に失敗しました');
          }

        } catch (error) {
          console.error('記事公開エラー:', error);
          this.showNotification(`記事の公開に失敗しました: ${error.message}`, 'error');
        } finally {
          // UI状態リセット
          const publishButton = document.querySelector('[data-action="publish-news"]');
          const originalText = '<i class="fas fa-globe"></i> 公開';
          this.resetButton(publishButton, originalText);
        }
      }

      // スキーマ準拠のデータ保存処理（統合版）
      async saveArticleData(formData, isDraft = true) {
        // 認証チェック
        await this.ensureAuthenticated();
        
        if (!this.state.supabaseConnected || !this.supabase) {
          return {
            success: false,
            error: 'データベースに接続されていません'
          };
        }

        try {
          console.log('📝 記事をSupabaseに保存中...', formData);

          // スキーマ準拠のデータ構造
          const articleData = {
            title: formData.title,
            content: formData.content,
            summary: formData.summary || '',
            category: formData.category,
            status: isDraft ? 'draft' : 'published',
            featured: formData.featured,
            published_at: isDraft ? null : new Date().toISOString()
          };

          let result;
          
          if (formData.id) {
            // 既存記事の更新
            console.log('既存記事を更新:', formData.id);
            const { data, error } = await this.supabase
              .from('articles')
              .update(articleData)
              .eq('id', formData.id)
              .select();

            if (error) {
              console.error('Supabase更新エラー:', error);
              return {
                success: false,
                error: `更新に失敗しました: ${error.message}`
              };
            }
            
            if (!data || data.length === 0) {
              return {
                success: false,
                error: '更新対象の記事が見つかりません'
              };
            }
            
            result = data[0]; // 配列の最初の要素を取得
          } else {
            // 新規記事の作成（UUIDは自動生成）
            console.log('新規記事を作成');
            const { data, error } = await this.supabase
              .from('articles')
              .insert(articleData)
              .select();

            if (error) {
              console.error('Supabase作成エラー:', error);
              return {
                success: false,
                error: `作成に失敗しました: ${error.message}`
              };
            }
            
            if (!data || data.length === 0) {
              return {
                success: false,
                error: '記事の作成に失敗しました'
              };
            }
            
            result = data[0]; // 配列の最初の要素を取得
          }

          console.log('✅ Supabase保存成功:', result);
          return {
            success: true,
            data: result
          };

        } catch (error) {
          console.error('❌ 記事保存処理エラー:', error);
          return {
            success: false,
            error: `保存中にエラーが発生しました: ${error.message}`
          };
        }
      }

      // ===========================================
      // Instagram管理機能の実装
      // ===========================================

      // Instagram投稿フォームデータ取得
      getInstagramFormData() {
        try {
          const formData = {
            id: document.getElementById('instagram-post-id')?.value || null,
            embed_code: document.getElementById('instagram-embed-code')?.value?.trim() || '',
            visible: document.getElementById('instagram-status')?.checked || false,
            featured: document.getElementById('instagram-featured')?.checked || false,
          };

          console.log('Instagram投稿フォームデータ取得:', formData);
          return formData;
        } catch (error) {
          console.error('Instagram投稿フォームデータ取得エラー:', error);
          this.showNotification('フォームデータの取得に失敗しました', 'error');
          return null;
        }
      }

      // Instagram投稿バリデーション
      validateInstagramForm(formData) {
        const errors = [];

        if (!formData.embed_code || formData.embed_code.length === 0) {
          errors.push('埋め込みコードは必須です');
        }

        // Instagram埋め込みコードの基本チェック
        if (formData.embed_code && !formData.embed_code.includes('instagram-media')) {
          errors.push('有効なInstagram埋め込みコードを入力してください');
        }

        if (formData.embed_code && formData.embed_code.length > 15000) {
          errors.push('埋め込みコードが長すぎます（15000文字以内）');
        }

        if (errors.length > 0) {
          console.warn('Instagram投稿バリデーションエラー:', errors);
          this.showNotification(`入力エラー: ${errors[0]}`, 'warning');
          return false;
        }

        return true;
      }

      // Instagram投稿保存
      async saveInstagramPost() {
        try {
          console.log('Instagram投稿保存開始');
          
          // UI状態更新
          const saveButton = document.querySelector('[data-action="save-instagram-post"]');
          const originalText = saveButton?.innerHTML;
          if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
          }
          
          this.showNotification('Instagram投稿を保存しています...', 'info');

          const formData = this.getInstagramFormData();
          if (!formData) {
            this.resetButton(saveButton, originalText);
            return;
          }

          if (!this.validateInstagramForm(formData)) {
            this.resetButton(saveButton, originalText);
            return;
          }

          // 保存実行
          const result = await this.saveInstagramData(formData);
          
          if (result.success) {
            this.showNotification('Instagram投稿を保存しました', 'success');
            
            // フォームクリア
            this.clearInstagramForm();
            
            // 投稿リスト更新
            await this.refreshInstagramPosts();
            
            console.log('✅ Instagram投稿保存完了:', result.data);
          } else {
            throw new Error(result.error || '保存に失敗しました');
          }

        } catch (error) {
          console.error('Instagram投稿保存エラー:', error);
          this.showNotification(`Instagram投稿の保存に失敗しました: ${error.message}`, 'error');
        } finally {
          // UI状態リセット
          const saveButton = document.querySelector('[data-action="save-instagram-post"]');
          const originalText = '<i class="fas fa-plus"></i> 追加';
          this.resetButton(saveButton, originalText);
        }
      }

      // Instagram投稿データ保存処理
      async saveInstagramData(formData) {
        // 認証チェック
        await this.ensureAuthenticated();
        
        if (!this.state.supabaseConnected || !this.supabase) {
          return {
            success: false,
            error: 'データベースに接続されていません'
          };
        }

        try {
          console.log('📝 Instagram投稿をSupabaseに保存中...', formData);

          // URLを埋め込みコードから抽出
          const url = this.extractInstagramUrl(formData.embed_code);
          
          // スキーマ準拠のデータ構造
          const postData = {
            url: url,
            embed_code: formData.embed_code,
            caption: '', // 将来的に追加予定
            visible: formData.visible,
            display_order: 0 // デフォルト値
          };

          let result;
          
          if (formData.id) {
            // 既存投稿の更新
            console.log('既存Instagram投稿を更新:', formData.id);
            const { data, error } = await this.supabase
              .from('instagram_posts')
              .update(postData)
              .eq('id', formData.id)
              .select();

            if (error) {
              console.error('Supabase更新エラー:', error);
              return {
                success: false,
                error: `更新に失敗しました: ${error.message}`
              };
            }
            
            if (!data || data.length === 0) {
              return {
                success: false,
                error: '更新対象の投稿が見つかりません'
              };
            }
            
            result = data[0]; // 配列の最初の要素を取得
          } else {
            // 新規投稿の作成（UUIDは自動生成）
            console.log('新規Instagram投稿を作成');
            const { data, error } = await this.supabase
              .from('instagram_posts')
              .insert(postData)
              .select();

            if (error) {
              console.error('Supabase作成エラー:', error);
              return {
                success: false,
                error: `作成に失敗しました: ${error.message}`
              };
            }
            
            if (!data || data.length === 0) {
              return {
                success: false,
                error: 'Instagram投稿の作成に失敗しました'
              };
            }
            
            result = data[0]; // 配列の最初の要素を取得
          }

          console.log('✅ Supabase保存成功:', result);
          return {
            success: true,
            data: result
          };

        } catch (error) {
          console.error('❌ Instagram投稿保存処理エラー:', error);
          return {
            success: false,
            error: `保存中にエラーが発生しました: ${error.message}`
          };
        }
      }

      // 埋め込みコードからInstagram URLを抽出
      extractInstagramUrl(embedCode) {
        try {
          // data-instgrm-permalink属性からURLを抽出
          const match = embedCode.match(/data-instgrm-permalink="([^"]+)"/);
          if (match && match[1]) {
            return match[1];
          }
          
          // hrefからURLを抽出（フォールバック）
          const hrefMatch = embedCode.match(/href="([^"]*instagram\.com[^"]+)"/);
          if (hrefMatch && hrefMatch[1]) {
            return hrefMatch[1];
          }
          
          // デフォルト値
          return 'https://www.instagram.com/';
        } catch (error) {
          console.warn('Instagram URL抽出エラー:', error);
          return 'https://www.instagram.com/';
        }
      }

      // Instagram投稿フォームクリア
      clearInstagramForm() {
        try {
          document.getElementById('instagram-post-id').value = '';
          document.getElementById('instagram-embed-code').value = '';
          document.getElementById('instagram-status').checked = true;
          document.getElementById('instagram-featured').checked = false;
          console.log('Instagram投稿フォームをクリア');
        } catch (error) {
          console.error('Instagram投稿フォームクリアエラー:', error);
        }
      }

      // Instagram投稿一覧更新
      async refreshInstagramPosts() {
        try {
          console.log('Instagram投稿一覧を更新中...');
          this.showNotification('Instagram投稿一覧を更新しています...', 'info');
          
          const posts = await this.loadInstagramPosts();
          this.displayInstagramPostsList(posts);
          
          this.showNotification(`Instagram投稿一覧を更新しました (${posts.length}件)`, 'success');
          
        } catch (error) {
          console.error('Instagram投稿一覧更新エラー:', error);
          this.showNotification('Instagram投稿一覧の更新に失敗しました', 'error');
        }
      }

      // Instagram投稿データ読み込み
      async loadInstagramPosts() {
        if (!this.state.supabaseConnected || !this.supabase) {
          console.warn('Supabaseに接続されていません');
          return [];
        }

        try {
          const { data, error } = await this.supabase
            .from('instagram_posts')
            .select('*')
            .order('display_order', { ascending: true })
            .order('created_at', { ascending: false });

          if (error) {
            throw new Error(`Instagram投稿の読み込みに失敗しました: ${error.message}`);
          }

          return data || [];
        } catch (error) {
          console.error('Instagram投稿読み込みエラー:', error);
          return [];
        }
      }

      // Instagram投稿一覧表示
      displayInstagramPostsList(posts) {
        const listContainer = document.getElementById('instagram-posts-list');
        if (!listContainer) {
          console.warn('Instagram投稿一覧コンテナが見つかりません');
          return;
        }

        if (posts.length === 0) {
          listContainer.innerHTML = `
            <div class="no-posts">
              <i class="fab fa-instagram fa-3x"></i>
              <h3>Instagram投稿がありません</h3>
              <p>上記のフォームから投稿を追加してください</p>
            </div>
          `;
          return;
        }

        const postsHTML = posts.map(post => `
          <div class="instagram-post-item" data-id="${post.id}">
            <div class="post-embed">
              ${post.embed_code}
            </div>
            <div class="post-controls">
              <div class="post-status">
                <span class="status-badge ${post.visible ? 'status-visible' : 'status-hidden'}">
                  ${post.visible ? '表示中' : '非表示'}
                </span>
              </div>
              <div class="post-actions">
                <button class="btn-icon" data-action="toggle-instagram-visibility" data-id="${post.id}" title="${post.visible ? '非表示にする' : '表示する'}">
                  <i class="fas ${post.visible ? 'fa-eye-slash' : 'fa-eye'}"></i>
                </button>
                <button class="btn-icon" data-action="edit-instagram-post" data-id="${post.id}" title="編集">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" data-action="delete-instagram-post" data-id="${post.id}" title="削除">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('');

        listContainer.innerHTML = postsHTML;
      }

      // Instagram投稿表示状態切り替え
      async toggleInstagramVisibility(postId) {
        if (!postId) return;

        try {
          const { data, error } = await this.supabase
            .from('instagram_posts')
            .select('visible')
            .eq('id', postId);

          if (error) throw new Error(error.message);
          
          if (!data || data.length === 0) {
            throw new Error('投稿が見つかりません');
          }

          const newVisibility = !data[0].visible;
          
          const { error: updateError } = await this.supabase
            .from('instagram_posts')
            .update({ visible: newVisibility })
            .eq('id', postId);

          if (updateError) throw new Error(updateError.message);

          this.showNotification(`投稿を${newVisibility ? '表示' : '非表示'}に設定しました`, 'success');
          await this.refreshInstagramPosts();

        } catch (error) {
          console.error('Instagram投稿表示状態切り替えエラー:', error);
          this.showNotification('表示状態の変更に失敗しました', 'error');
        }
      }

      // Instagram投稿削除確認
      async confirmDeleteInstagramPost(postId) {
        if (!postId) return;

        if (confirm('この投稿を削除しますか？この操作は取り消せません。')) {
          try {
            const { error } = await this.supabase
              .from('instagram_posts')
              .delete()
              .eq('id', postId);

            if (error) throw new Error(error.message);

            this.showNotification('Instagram投稿を削除しました', 'success');
            await this.refreshInstagramPosts();

          } catch (error) {
            console.error('Instagram投稿削除エラー:', error);
            this.showNotification('投稿の削除に失敗しました', 'error');
          }
        }
      }

      // Instagram投稿リストフィルタ
      filterInstagramList(filterValue) {
        const items = document.querySelectorAll('.instagram-post-item');
        items.forEach(item => {
          const postElement = item.querySelector('.status-badge');
          if (!postElement) return;

          const isVisible = postElement.classList.contains('status-visible');
          let shouldShow = true;

          switch (filterValue) {
            case 'active':
              shouldShow = isVisible;
              break;
            case 'inactive':
              shouldShow = !isVisible;
              break;
            case 'all':
            default:
              shouldShow = true;
              break;
          }

          item.style.display = shouldShow ? 'block' : 'none';
        });
      }

      // Instagram投稿編集（プレースホルダー）
      editInstagramPost(postId) {
        console.log('Instagram投稿編集:', postId);
        this.showNotification('編集機能は今後実装予定です', 'info');
      }

      // プレビュー表示
      previewNewsArticle() {
        try {
          console.log('記事プレビュー開始');

          const formData = this.getNewsFormData();
          if (!formData) return;

          if (!formData.title && !formData.content) {
            this.showNotification('プレビューするコンテンツがありません', 'warning');
            return;
          }

          // プレビューHTMLの生成
          const previewHTML = this.generatePreviewHTML(formData);

          // モーダルでプレビューを表示
          this.showModal('記事プレビュー', previewHTML);

          this.showNotification('プレビューを表示しました', 'info');

        } catch (error) {
          console.error('プレビューエラー:', error);
          this.showNotification('プレビューの表示に失敗しました', 'error');
        }
      }

      // プレビューHTML生成
      generatePreviewHTML(formData) {
        const categoryLabels = {
          'general': '一般',
          'event': 'イベント',
          'notice': 'お知らせ',
          'lesson': 'レッスン',
          'other': 'その他',
          // 旧形式との互換性
          'announcement': 'お知らせ',
          'media': 'メディア',
          'important': '重要'
        };

        return `
          <div class="news-preview">
            <div class="news-header">
              <span class="news-category category-${formData.category}">
                ${categoryLabels[formData.category] || formData.category}
              </span>
              <span class="news-date">${new Date().toLocaleDateString('ja-JP')}</span>
              ${formData.featured ? '<span class="featured-badge">注目</span>' : ''}
            </div>
            <h1 class="news-title">${formData.title || '(タイトルなし)'}</h1>
            ${formData.summary ? `<div class="news-summary">${formData.summary}</div>` : ''}
            <div class="news-content">
              ${this.markdownToHTML(formData.content) || '(本文なし)'}
            </div>
          </div>
          <style>
            .news-preview { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
            .news-header { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
            .news-category { background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
            .category-important { background: #dc3545; }
            .category-event { background: #28a745; }
            .category-media { background: #6f42c1; }
            .news-date { color: #666; font-size: 0.9rem; }
            .featured-badge { background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; }
            .news-title { color: #333; margin: 0 0 15px 0; font-size: 1.5rem; }
            .news-summary { background: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin-bottom: 20px; }
            .news-content { line-height: 1.6; color: #333; }
          </style>
        `;
      }

      // 簡単なMarkdown変換（基本的な変換のみ）
      markdownToHTML(markdown) {
        if (!markdown) return '';
        
        return markdown
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
          .replace(/\*(.*)\*/gim, '<em>$1</em>')
          .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
          .replace(/^- (.*$)/gim, '<li>$1</li>')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
          .replace(/\n/gim, '<br>');
      }

      // エディターをクリア
      clearNewsEditor() {
        if (confirm('エディターの内容をクリアしますか？未保存の内容は失われます。')) {
          document.getElementById('news-id').value = '';
          document.getElementById('news-title').value = '';
          document.getElementById('news-category').value = 'announcement';

          document.getElementById('news-summary').value = '';
          document.getElementById('news-content').value = '';
          document.getElementById('news-featured').checked = false;

          this.updateEditorTitle('新規記事作成');
          this.showNotification('エディターをクリアしました', 'info');

          console.log('エディターをクリアしました');
        }
      }

      // 新規記事作成
      createNewNewsArticle() {
        this.clearNewsEditor();
        this.switchTab('news-management');
        this.switchNewsTab('editor');
      }

      // 記事一覧の更新
      async refreshNewsList() {
        try {
          console.log('記事一覧を更新中...');
          this.showNotification('記事一覧を更新しています...', 'info');
          
          // 記事一覧を読み込み
          const articles = await this.loadArticles();
          
          // 記事一覧を表示
          this.displayArticlesList(articles);
          
          this.showNotification(`記事一覧を更新しました (${articles.length}件)`, 'success');
          
        } catch (error) {
          console.error('記事一覧更新エラー:', error);
          this.showNotification('記事一覧の更新に失敗しました', 'error');
        }
      }

      // 記事一覧の表示
      displayArticlesList(articles) {
        const listContainer = document.getElementById('news-list');
        if (!listContainer) {
          console.warn('記事一覧コンテナが見つかりません');
          return;
        }

        if (articles.length === 0) {
          listContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-newspaper"></i>
              <h3>記事がありません</h3>
              <p>新しい記事を作成してください</p>
              <button class="btn btn-primary" data-action="new-news-article">
                <i class="fas fa-plus"></i> 新規記事作成
              </button>
            </div>
          `;
          return;
        }

        const articlesHTML = articles.map(article => `
          <div class="news-item" data-id="${article.id}">
            <div class="news-item-header">
              <h3 class="news-item-title">${article.title}</h3>
              <span class="news-item-status status-${article.status}">
                ${article.status === 'published' ? '公開' : '下書き'}
              </span>
            </div>
            <div class="news-item-meta">
              <span class="news-item-category">${this.getCategoryLabel(article.category)}</span>
              <span class="news-item-date">${this.formatDate(article.created_at)}</span>
              ${article.featured ? '<span class="news-item-featured">注目</span>' : ''}
            </div>
            <div class="news-item-summary">
              ${article.summary || '(概要なし)'}
            </div>
            <div class="news-item-actions">
              <button class="btn btn-sm btn-outline" data-action="edit-article" data-id="${article.id}">
                <i class="fas fa-edit"></i> 編集
              </button>
              <button class="btn btn-sm btn-outline" data-action="preview-article" data-id="${article.id}">
                <i class="fas fa-eye"></i> プレビュー
              </button>
              <button class="btn btn-sm btn-danger" data-action="delete-article" data-id="${article.id}">
                <i class="fas fa-trash"></i> 削除
              </button>
            </div>
          </div>
        `).join('');

        listContainer.innerHTML = articlesHTML;
      }

      // カテゴリラベルの取得
      getCategoryLabel(category) {
        const labels = {
          'announcement': 'お知らせ',
          'event': '体験会',
          'media': 'メディア',
          'important': '重要'
        };
        return labels[category] || category;
      }

      // 日付のフォーマット
      formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }

      // 記事一覧のフィルタリング
      async filterNewsList(filter) {
        try {
          console.log('記事一覧をフィルタリング:', filter);
          this.showNotification(`フィルター適用中...`, 'info');
          
          const filters = {};
          if (filter !== 'all') {
            filters.status = filter;
          }
          
          const articles = await this.loadArticles(filters);
          this.displayArticlesList(articles);
          
          this.showNotification(`フィルター適用完了 (${articles.length}件)`, 'success');
          
        } catch (error) {
          console.error('フィルタリングエラー:', error);
          this.showNotification('フィルタリングに失敗しました', 'error');
        }
      }

      // 記事を編集
      async editArticle(articleId) {
        if (!articleId) {
          console.warn('記事IDが指定されていません');
          return;
        }

        try {
          console.log('記事を編集モードで読み込み:', articleId);
          
          const { data, error } = await this.supabase
            .from('articles')
            .select('*')
            .eq('id', articleId);

          if (error) {
            throw new Error(`記事の読み込みに失敗しました: ${error.message}`);
          }
          
          if (!data || data.length === 0) {
            throw new Error('記事が見つかりません');
          }

          // フォームに記事データを設定
          this.loadArticleToEditor(data[0]);
          
          // 編集タブに切り替え
          this.switchTab('news-management');
          this.switchNewsTab('editor');
          
          this.showNotification('記事を編集モードで読み込みました', 'success');

        } catch (error) {
          console.error('記事編集エラー:', error);
          this.showNotification(error.message, 'error');
        }
      }

      // 記事データをエディターに読み込み
      loadArticleToEditor(article) {
        document.getElementById('news-id').value = article.id || '';
        document.getElementById('news-title').value = article.title || '';
        document.getElementById('news-category').value = article.category || 'announcement';
        
        document.getElementById('news-summary').value = article.summary || '';
        document.getElementById('news-content').value = article.content || '';
        document.getElementById('news-featured').checked = article.featured || false;

        this.updateEditorTitle(article.title);
      }

      // 記事削除の確認
      async confirmDeleteArticle(articleId) {
        if (!articleId) {
          console.warn('記事IDが指定されていません');
          return;
        }

        if (confirm('この記事を削除しますか？この操作は取り消せません。')) {
          const success = await this.deleteArticle(articleId);
          if (success) {
            // 記事一覧を更新
            await this.refreshNewsList();
          }
        }
      }

      // IDによる記事プレビュー
      async previewArticleById(articleId) {
        if (!articleId) {
          console.warn('記事IDが指定されていません');
          return;
        }

        try {
          const { data, error } = await this.supabase
            .from('articles')
            .select('*')
            .eq('id', articleId);

          if (error) {
            throw new Error(`記事の読み込みに失敗しました: ${error.message}`);
          }
          
          if (!data || data.length === 0) {
            throw new Error('記事が見つかりません');
          }

          // プレビューHTML生成
          const previewHTML = this.generatePreviewHTML(data[0]);
          
          // モーダルでプレビュー表示
          this.showModal(`記事プレビュー: ${data[0].title}`, previewHTML);

        } catch (error) {
          console.error('記事プレビューエラー:', error);
          this.showNotification(error.message, 'error');
        }
      }

      // エディターのタイトルを更新
      updateEditorTitle(title) {
        const titleElement = document.getElementById('editor-title');
        if (titleElement) {
          titleElement.textContent = title ? `記事編集: ${title}` : '新規記事作成';
        }
      }

      // モーダル表示
      showModal(title, content) {
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        if (modal && modalTitle && modalBody) {
          modalTitle.textContent = title;
          modalBody.innerHTML = content;
          modal.classList.remove('modal-hidden');
          modal.classList.add('modal-visible');
        }
      }

      // その他のアクション実行
      executeAction(action, element) {
        console.log(`カスタムアクション実行: ${action}`, element);
        // 追加のアクション処理をここに実装
      }

      // ログアウト処理
      async handleLogout() {
        if (confirm('ログアウトしますか？')) {
          try {
            console.log('🔐 ログアウト実行中...');
            
            // Supabaseログアウト
            if (this.supabase) {
              await this.supabase.auth.signOut();
              console.log('✅ Supabaseログアウト完了');
            }
            
            // 状態クリア
            this.state.authenticated = false;
            this.state.currentUser = null;
            this.state.currentTab = 'dashboard';
            
            console.log('✅ ログアウト完了');
            this.showNotification('ログアウトしました', 'info');
            
            // ログインページにリダイレクト
            setTimeout(() => {
              window.location.href = 'admin-login.html';
            }, 1000);
            
          } catch (error) {
            console.error('ログアウト処理エラー:', error);
            this.showNotification('ログアウト処理中にエラーが発生しました', 'error');
          }
        }
      }

      // ボタンの状態をリセット
      resetButton(button, originalText) {
        if (button && originalText) {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      // 保存状態の視覚的フィードバック
      showSaveProgress(message = '保存中...') {
        // 既存の保存中表示を削除
        const existingProgress = document.querySelector('.save-progress');
        if (existingProgress) {
          existingProgress.remove();
        }

        // 新しい保存中表示を作成
        const progressIndicator = document.createElement('div');
        progressIndicator.className = 'save-progress';
        progressIndicator.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px 30px;
          border-radius: 8px;
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 1rem;
        `;
        progressIndicator.innerHTML = `
          <i class="fas fa-spinner fa-spin"></i>
          <span>${message}</span>
        `;

        document.body.appendChild(progressIndicator);

        return progressIndicator;
      }

      // 保存状態表示を削除
      hideSaveProgress() {
        const progressIndicator = document.querySelector('.save-progress');
        if (progressIndicator) {
          progressIndicator.remove();
        }
      }

      // エラー時の詳細表示
      showDetailedError(error, context = '操作') {
        console.error(`${context}エラー詳細:`, error);
        
        let errorMessage = `${context}に失敗しました`;
        
        if (error.message) {
          errorMessage += `: ${error.message}`;
        }
        
        // 開発環境では詳細なエラー情報を表示
        if (window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
          errorMessage += ` (詳細: コンソールを確認してください)`;
        }
        
        this.showNotification(errorMessage, 'error');
      }

      // 接続状態の確認
      checkSupabaseConnection() {
        if (!this.state.supabaseConnected) {
          this.showNotification('データベースに接続されていません', 'warning');
          return false;
        }
        return true;
      }

      // 記事データの読み込み
      async loadArticles(filters = {}) {
        if (!this.checkSupabaseConnection()) return [];

        try {
          console.log('📖 記事一覧を読み込み中...');
          
          let query = this.supabase
            .from('articles')
            .select('*')
            .order('created_at', { ascending: false });

          // フィルターの適用
          if (filters.status) {
            query = query.eq('status', filters.status);
          }
          if (filters.category) {
            query = query.eq('category', filters.category);
          }
          if (filters.featured !== undefined) {
            query = query.eq('featured', filters.featured);
          }

          const { data, error } = await query;

          if (error) {
            throw new Error(`記事の読み込みに失敗しました: ${error.message}`);
          }

          console.log('✅ 記事読み込み完了:', data?.length || 0, '件');
          return data || [];

        } catch (error) {
          console.error('❌ 記事読み込みエラー:', error);
          this.showNotification(error.message, 'error');
          return [];
        }
      }

      // 記事の削除
      async deleteArticle(articleId) {
        if (!this.checkSupabaseConnection()) return false;

        try {
          console.log('🗑️ 記事を削除中...', articleId);

          const { error } = await this.supabase
            .from('articles')
            .delete()
            .eq('id', articleId);

          if (error) {
            throw new Error(`記事の削除に失敗しました: ${error.message}`);
          }

          console.log('✅ 記事削除完了:', articleId);
          this.showNotification('記事を削除しました', 'success');
          return true;

        } catch (error) {
          console.error('❌ 記事削除エラー:', error);
          this.showNotification(error.message, 'error');
          return false;
        }
      }

      // モーダルを閉じる
      closeModal() {
        const modal = document.getElementById('modal');
        if (modal) {
          modal.classList.add('modal-hidden');
          modal.classList.remove('modal-visible');
        }
      }

      activateInitialTab() {
        // DOM要素の準備を確認してからタブを切り替え
        const checkAndActivate = () => {
          const dashboardSection = document.getElementById('dashboard');
          if (dashboardSection) {
            this.switchTab('dashboard');
            console.log('✅ 初期タブ（ダッシュボード）を活性化しました');
            
            // データベース接続状態の確認
            if (this.state.supabaseConnected) {
              console.log('🗄️ Supabaseデータベース接続済み');
            } else {
              console.log('⚠️ データベース未接続 - 開発モードで動作中');
            }
            
          } else {
            console.warn('ダッシュボード要素が見つかりません。再試行します...');
            setTimeout(checkAndActivate, 100);
          }
        };
        
        // 少し遅延させてDOM要素の準備を待つ
        setTimeout(checkAndActivate, 10);
      }

      async getModule(name) {
        if (this.state.modules.has(name)) {
          return this.state.modules.get(name);
        }

        // シンプルなモジュール実装
        const simpleModule = {
          name,
          initialized: true,
          saveData: async (data) => {
            try {
              if (this.supabase) {
                const tableName = this.getTableName(name);
                await this.supabase.from(tableName).insert(data);
                this.showNotification(`${name}データを保存しました`, 'success');
              } else {
                sessionStorage.setItem(`rbs_${name}_data`, JSON.stringify(data));
                this.showNotification(`${name}データを一時保存しました`, 'info');
              }
            } catch (error) {
              console.error(`${name}保存エラー:`, error);
              this.showNotification(`${name}の保存に失敗しました`, 'error');
            }
          },
          loadData: async () => {
            try {
              if (this.supabase) {
                const tableName = this.getTableName(name);
                const { data } = await this.supabase.from(tableName).select('*');
                return data || [];
              } else {
                const stored = sessionStorage.getItem(`rbs_${name}_data`);
                return stored ? JSON.parse(stored) : [];
              }
            } catch (error) {
              console.error(`${name}読み込みエラー:`, error);
              return [];
            }
          }
        };

        this.state.modules.set(name, simpleModule);
        return simpleModule;
      }

      getService(name) {
        return this.state.services.get(name);
      }

      showNotification(message, type = 'info') {
        // 既存の通知コンテナを確認
        let container = document.getElementById('notification-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'notification-container';
          container.style.cssText = `
            position: fixed;
            top: 80px; /* ヘッダーの下に配置 */
            right: 20px;
            z-index: 10000; /* より高いz-index */
            max-width: 400px;
            pointer-events: none; /* 通知以外のクリックを妨げない */
          `;
          document.body.appendChild(container);
        }

        // 通知要素作成
        const notification = document.createElement('div');
        const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
        const colors = { 
          success: '#4caf50', 
          error: '#f44336', 
          warning: '#ff9800', 
          info: '#2196f3' 
        };
        
        notification.style.cssText = `
          background: ${colors[type] || colors.info};
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          transition: all 0.3s ease;
          pointer-events: auto; /* 通知自体はクリック可能 */
          animation: slideInRight 0.3s ease-out;
          backdrop-filter: blur(5px);
        `;
        
        notification.innerHTML = `${icons[type] || icons.info} ${message}`;
        container.appendChild(notification);

        // 自動削除
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 3000);

        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      async autoSave(element) {
        try {
          // 統合DraftSupabaseServiceを使用
          const { getDraftSupabaseService } = await import('./js/shared/services/DraftSupabaseService.js');
          const draftService = getDraftSupabaseService();
          await draftService.init();

          const form = element.closest('form');
          if (!form) return;

          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          
          await draftService.saveDraft(form.dataset.type || 'general', data);
        } catch (error) {
          console.warn('自動保存エラー:', error);
          // フォールバック：従来方式
          const draftService = this.getService('draft');
          if (draftService) {
            const form = element.closest('form');
            if (form) {
              const formData = new FormData(form);
              const data = Object.fromEntries(formData.entries());
              await draftService.saveDraft(form.dataset.type || 'general', data);
            }
          }
        }
      }

      getTabLabel(tabName) {
        const labels = {
          'dashboard': 'ダッシュボード',
          'news-management': '記事管理', 
          'lesson-status': 'レッスン状況',
          'instagram-management': 'Instagram管理',
          'settings': '設定'
        };
        return labels[tabName] || tabName;
      }

      getTableName(moduleName) {
        const tables = {
          'news': 'articles',
          'lesson': 'lesson_status',
          'instagram': 'instagram_posts'
        };
        return tables[moduleName] || moduleName;
      }

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        console.log('設定を更新しました:', newConfig);
      }

      getDebugInfo() {
        return {
          state: this.state,
          config: this.config,
          services: Array.from(this.state.services.keys()),
          modules: Array.from(this.state.modules.keys()),
          supabaseConnected: !!this.supabase
        };
      }

      // データ操作前の認証チェック
      async ensureAuthenticated() {
        if (!this.state.authenticated || !this.state.currentUser) {
          this.showNotification('操作には認証が必要です', 'warning');
          this.redirectToLogin();
          throw new Error('認証が必要です');
        }
        
        return true;
      }

      // 認証状態表示の更新
      updateAuthenticationUI() {
        try {
          // ヘッダーにユーザー情報を表示
          const headerUser = document.querySelector('.header-user');
          if (headerUser) {
            if (this.state.authenticated && this.state.currentUser) {
              headerUser.innerHTML = `
                <span class="user-email">${this.state.currentUser.email}</span>
                <button class="btn-logout" data-action="logout">
                  <i class="fas fa-sign-out-alt"></i> ログアウト
                </button>
              `;
            } else {
              headerUser.innerHTML = `
                <span class="auth-status">未認証</span>
              `;
            }
          }
          
          // 認証状態に応じたタブの有効/無効化
          const tabElements = document.querySelectorAll('[data-action="switch-admin-tab"]');
          tabElements.forEach(tab => {
            if (this.state.authenticated) {
              tab.classList.remove('disabled');
            } else {
              tab.classList.add('disabled');
            }
          });

        } catch (error) {
          console.warn('認証UI更新エラー:', error);
        }
      }
    }

    // グローバル初期化関数
    window.initInlineSimpleAdmin = async function() {
      const core = new InlineSimpleAdminCore();
      const result = await core.init();
      
      // グローバルアクセス設定
      window.adminCore = result;
      
      // 開発ツール設定
      if (window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
        window.adminDevTools = {
          getCore: () => result,
          getDebugInfo: () => result.getDebugInfo(),
          getModule: async (name) => await result.getModule(name),
          getService: (name) => result.getService(name),
          updateConfig: (config) => result.updateConfig(config),
          switchTab: (tab) => result.switchTab(tab),
          log: (message) => console.log(`[AdminDevTools] ${message}`),
          testNotification: () => {
            result.showNotification('テスト通知', 'info');
          },
          testSupabase: async () => {
            if (result.supabase) {
              try {
                // articlesテーブルでテスト（admin_settingsは認証が必要なため）
                const { data, error } = await result.supabase.from('articles').select('id').limit(1);
                if (error) throw error;
                console.log('Supabase接続テスト成功:', data);
                result.showNotification('Supabase接続成功', 'success');
              } catch (error) {
                console.error('Supabase接続テスト失敗:', error);
                result.showNotification(`Supabase接続失敗: ${error.message}`, 'error');
              }
            } else {
              console.warn('Supabaseクライアントが初期化されていません');
              result.showNotification('Supabase未接続', 'warning');
            }
          }
        };
        
        console.log('🔧 Admin開発ツールが利用可能です: window.adminDevTools');
      }
      
      return result;
    };
  </script>

  <!-- シンプル統一管理画面システム v4.2.0 - 完全内蔵型 -->
  <script>
    console.log('🚀 RBS陸上教室管理画面 - 完全内蔵型 v4.2.0 開始');
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('📦 完全内蔵型システムで初期化中...');
        
        // ES Modules importを一切使わない初期化
        const adminCore = await window.initInlineSimpleAdmin();
        
        console.log('✅ 完全内蔵型管理画面初期化完了');
        console.log('📊 利用可能なサービス:', Array.from(adminCore.state.services.keys()));
        console.log('🔧 開発ツール: window.adminCore, window.adminDevTools');
        
        // 統計の更新
        updateDashboardStats(adminCore);
        
      } catch (error) {
        console.error('❌ 管理画面初期化エラー:', error);
        
        // エラー時フォールバック表示
        showErrorFallback(error);
      }
    });

    // ダッシュボード統計更新
    function updateDashboardStats(adminCore) {
      try {
        // 統計要素の安全な更新
        const updateElement = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        };
        
        updateElement('article-count', '0');
        updateElement('lesson-count', '0');
        updateElement('instagram-count', '0');
        updateElement('system-status', '✅');
        updateElement('last-update', new Date().toLocaleString('ja-JP'));
        
        // 総記事数、レッスン数、ストレージ使用量の更新
        updateElement('total-articles', '0');
        updateElement('total-lessons', '0');
        updateElement('storage-usage', '0.0MB');
        
        console.log('📊 ダッシュボード統計を更新しました');
      } catch (error) {
        console.warn('ダッシュボード統計更新エラー:', error);
      }
    }

    // エラー時のフォールバック表示
    function showErrorFallback(error) {
      // メインエリアを複数の方法で取得
      const mainArea = document.querySelector('#admin-main') || 
                      document.querySelector('main') || 
                      document.querySelector('.admin-content') ||
                      document.body;
      
      if (mainArea) {
        mainArea.innerHTML = `
          <div class="error-fallback" style="
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 60vh; 
            text-align: center;
            background: #fff;
            border-radius: 8px;
            margin: 20px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          ">
            <div style="font-size: 4rem; margin-bottom: 20px;">⚠️</div>
            <h2 style="color: #e74c3c; margin-bottom: 10px;">初期化エラー</h2>
            <p style="color: #666; margin-bottom: 20px;">管理画面の初期化に失敗しました。</p>
            <button onclick="location.reload()" style="
              background: #3498db;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 1rem;
              margin-bottom: 20px;
            ">🔄 再試行</button>
            <details style="margin-top: 20px; text-align: left; max-width: 600px;">
              <summary style="cursor: pointer; color: #666;">エラー詳細を表示</summary>
              <pre style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 4px;
                overflow: auto;
                margin-top: 10px;
                font-size: 0.8rem;
                color: #d63384;
              ">${error.stack || error.message}</pre>
            </details>
          </div>
        `;
      }
    }
      </script>
  </body>
</html>
