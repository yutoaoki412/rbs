/**
 * 管理画面アクションサービス
 * ボタンクリックやフォーム送信などのユーザーアクションを処理
 * @version 3.0.0 - 統合アクション管理システム
 */

import { actionManager } from '../../../core/ActionManager.js';
import { EventBus } from '../../../shared/services/EventBus.js';
import { getArticleDataService } from './ArticleDataService.js';
import { getLessonStatusStorageService } from '../../../shared/services/LessonStatusStorageService.js';
import { CONFIG } from '../../../shared/constants/config.js';
import { dataExportService } from '../../../shared/services/DataExportService.js';
import { uiManagerService } from './UIManagerService.js';
import { getUnifiedNotificationService } from '../../../shared/services/UnifiedNotificationService.js';

export class AdminActionService {
  // プライベートフィールド宣言
  #validTabNames = ['dashboard', 'news', 'lesson-status', 'instagram', 'settings'];
  
  constructor() {
    this.componentName = 'AdminActionService';
    this.actionEventPrefix = 'admin-action';
    
    // サービス参照
    this.articleDataService = null;
    this.articleStorageService = null;
    this.lessonStatusService = null;
    this.instagramDataService = null;
    this.authService = null;
    this.uiManagerService = null;
    this.dataExportService = null;
    
    // 統一ストレージキー（CONFIG.storage.keysから完全統一）
    this.storageKeys = {
      // LP側と共有
      articles: CONFIG.storage.keys.articles,
      content: CONFIG.storage.keys.content,
      config: CONFIG.storage.keys.config,
      auth: CONFIG.storage.keys.auth,
      lessonStatus: CONFIG.storage.keys.lessonStatus,
      settings: CONFIG.storage.keys.settings,
      
      // 管理画面専用（修正済み）
      adminAuth: CONFIG.storage.keys.adminAuth,
      adminTab: CONFIG.storage.keys.adminTab,
      adminLogs: CONFIG.storage.keys.adminLogs,
      debugMode: CONFIG.storage.keys.debugMode,
      sessionStart: CONFIG.storage.keys.sessionStart,
      
      // 機能別
      newsDraft: CONFIG.storage.keys.newsDraft,
      
      // データ管理
      exportHistory: CONFIG.storage.keys.exportHistory,
      
      // Instagram連携
      instagram: CONFIG.storage.keys.instagram,
      
      // 認証関連
      authAttempts: CONFIG.storage.keys.authAttempts,
      authLastAttempt: CONFIG.storage.keys.authLastAttempt
    };
    
    // アクション定義（プロパティ用・デバッグ用）
    this.actionsList = [
      'switch-admin-tab', 'switch-news-tab', 'clear-news-editor', 'new-news-article',
      'preview-news', 'save-news', 'publish-news', 'test-article-service',
      'filter-news-list', 'refresh-news-list', 'refresh-recent-articles',
      'insert-markdown', 'show-writing-guide', 'edit-article', 'delete-article',
      'preview-article', 'duplicate-article', 'load-lesson-status', 'update-lesson-status',
      'wizard-prev', 'wizard-next',
      'toggle-notification-mode', 'export-data', 'clear-all-data', 'test-site-connection',
      'reset-local-storage', 'show-debug-info', 'show-news-debug', 'close-modal',
      'open-external', 'toggle-mobile-menu', 'logout',
      'switch-instagram-tab', 'add-instagram-post', 'save-instagram-post', 'refresh-instagram-posts', 'save-instagram-settings', 'close-instagram-modal', 'edit-instagram-post', 'toggle-instagram-post', 'delete-instagram-post'
    ];
  }

  /**
   * 初期化
   */
  async init() {
    try {
      console.log('👨‍💼 AdminActionService 初期化開始');
      
      // ActionManagerの確実な初期化を待機
      if (!actionManager.initialized) {
        actionManager.init();
        console.log('🔧 ActionManager を初期化しました');
      }
      
      // 認証サービスの初期化
      if (!this.authService) {
        const { authService } = await import('../../auth/services/AuthService.js');
        this.authService = authService;
      }

      // 認証サービスが初期化されていない場合は初期化
      if (!this.authService.initialized) {
        await this.authService.init();
      }

      // サービス依存関係を初期化
      await this.initializeServices();
      
      // UI設定
      await this.setupAdminUI();
      
      // セッション情報更新のコールバックを登録
      this.authService.onSessionInfoUpdate((sessionInfo) => {
        this.updateSessionInfoDisplay(sessionInfo);
      });

      // ログアウトコールバックを登録
      this.authService.onLogout(() => {
        this.handleAuthLogout();
      });
      
      this.initialized = true;
      console.log('✅ AdminActionService 初期化完了');
      
    } catch (error) {
      this.error('AdminActionService 初期化エラー:', error);
      throw error;
    }
  }

  /**
   * 通知システムのテスト
   * @private
   */
  testNotificationSystem() {
    if (!this.uiManagerService) {
      console.warn('通知システムが利用できません');
      return;
    }
    
    // 3秒後にテスト通知を表示
    setTimeout(() => {
      this.info('通知システムが正常に動作しています');
    }, 3000);
    
    console.log('📢 通知システムのテストを開始しました');
  }

  /**
   * サービス初期化
   * @private
   */
  async initializeServices() {
    // アクションマネージャーを設定（既にファイル冒頭でインポート済み）
    this.actionManager = actionManager;
    
    // サービス依存関係の取得
    const { getArticleDataService } = await import('./ArticleDataService.js');
    const { getLessonStatusStorageService } = await import('../../../shared/services/LessonStatusStorageService.js');
    
    this.articleDataService = getArticleDataService();
    this.lessonStatusService = getLessonStatusStorageService();
     
    // InstagramDataServiceのインポートと初期化
    const { instagramDataService } = await import('./InstagramDataService.js');
    this.instagramDataService = instagramDataService;
    
    // UIManagerServiceのインポートと初期化
    const { uiManagerService } = await import('./UIManagerService.js');
    this.uiManagerService = uiManagerService;
    
    // NewsFormManagerのインポートと初期化
    const { newsFormManager } = await import('../components/NewsFormManager.js');
    this.newsFormManager = newsFormManager;
    
    // サービスの初期化確認
    if (!this.articleDataService.initialized) {
      await this.articleDataService.init();
    }
     
    if (!this.lessonStatusService.initialized) {
      await this.lessonStatusService.init();
    }
    
    if (!this.instagramDataService.initialized) {
      this.instagramDataService.init();
    }
    
    if (!this.uiManagerService.initialized) {
      this.uiManagerService.init();
    }
    
    if (!this.newsFormManager.initialized) {
      this.newsFormManager.init();
    }
    
    this.log('全サービス初期化完了');
  }

  /**
   * データエクスポートサービスのセットアップ
   * @private
   */
  async setupDataExportService() {
    try {
      const { DataExportService } = await import('../../../shared/services/DataExportService.js');
      
      this.dataExportService = new DataExportService();
      await this.dataExportService.init();
      
      this.debug('DataExportService設定完了');
    } catch (error) {
      this.error('DataExportServiceの設定に失敗しました:', error);
    }
  }

  /**
   * 管理画面アクションを登録
   * @private
   */
  #showFeedback(message, type = 'success', duration = 5000) {
    console.log(`${type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '✅'} ${message}`);
    
    if (this.uiManagerService?.showNotification) {
      this.uiManagerService.showNotification(type, message);
    } else if (typeof window.showFeedback === 'function') {
      window.showFeedback(message, type);
    } else {
      // fallback to console
      console.log(`Feedback: ${message} (${type})`);
    }
  }
  #registerAdminActions() {
    console.log('🔧 管理画面アクション登録開始');
    
    if (!this.actionManager) {
      this.error('ActionManagerが初期化されていません');
      return;
    }

    // ActionManagerの状態確認
    console.log('🔍 ActionManager状態:', {
      initialized: this.actionManager.initialized,
      actionsCount: this.actionManager._actions?.size || 0
    });

    const adminActions = {
      // 認証関連はAuthServiceで処理（責任の分離）
      
      // タブ切り替え（優先度高） - HTMLのdata-action="switch-admin-tab"に対応
      'switch-admin-tab': async (element, params) => {
        console.log('🎯 switch-admin-tabアクション実行:', { element, params });
        
        const tabName = params?.tab || element?.dataset?.tab;
        console.log('🔍 取得したタブ名:', tabName);
        
        if (!tabName) {
          console.error('❌ タブ名が取得できません:', { params, dataset: element?.dataset });
          this.#showFeedback('タブ名が指定されていません', 'error');
          return;
        }
        
        if (this.#isValidTabName(tabName)) {
          console.log(`🚀 タブ切り替え実行: ${tabName}`);
          await this.switchAdminTab(tabName);
        } else {
          console.error(`❌ 無効なタブ名: ${tabName}`);
          this.#showFeedback(`無効なタブ名: ${tabName}`, 'error');
        }
      },

      // 記事管理
      'clear-news-editor': () => {
        if (confirm('記事エディターの内容をクリアしますか？')) {
          this.clearNewsEditor();
        }
      },
      'new-news-article': () => this.startNewArticle(),
      'preview-news': () => this.previewNews(),
      'save-news': () => this.saveNews(),
      'publish-news': () => this.publishNews(),
      'test-article-service': () => this.testArticleService(),
      'filter-news-list': (element, params) => this.filterNewsList(element, params),
      'refresh-news-list': () => this.refreshNewsList(),
      'refresh-recent-articles': () => this.refreshRecentArticles(),
      'insert-markdown': (element, params) => this.insertMarkdown(element, params),
      'switch-news-tab': (element, params) => this.switchNewsTab(params.tab),
      'show-writing-guide': () => this.#showWritingGuide(),
      
      // 記事編集関連（新しく追加）
      'edit-article': (element, params) => {
        const articleId = params.articleId || element.dataset.articleId;
        if (articleId) {
          this.editArticle(articleId);
        } else {
          this.#showFeedback('記事IDが見つかりません', 'error');
        }
      },
      'delete-article': async (element, params) => {
        const articleId = params.articleId || element.dataset.articleId;
        if (articleId) {
          await this.deleteArticle(articleId);
        } else {
          this.#showFeedback('記事IDが見つかりません', 'error');
        }
      },
      'preview-article': (element, params) => {
        const articleId = params.articleId || element.dataset.articleId;
        if (articleId) {
          this.previewArticleById(articleId);
        } else {
          this.#showFeedback('記事IDが見つかりません', 'error');
        }
      },
      'duplicate-article': async (element, params) => {
        const articleId = params.articleId || element.dataset.articleId;
        if (articleId) {
          await this.duplicateArticle(articleId);
        } else {
          this.#showFeedback('記事IDが見つかりません', 'error');
        }
      },

      // レッスン状況
      'load-lesson-status': () => this.loadLessonStatus(),
      'update-lesson-status': () => this.updateLessonStatus(),
      
      // レッスン状況（モダンシステム）
      'loadLessonStatusModern': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.loadLessonStatusModern();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'updateLessonStatusModern': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.updateLessonStatusModern();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'copyPreviousDay': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.copyPreviousDay();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'previewLessonStatus': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.previewLessonStatus();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'saveDraftLessonStatus': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.saveDraftLessonStatus();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'resetLessonStatus': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.resetLessonStatus();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      'copyToTemplate': () => {
        if (this.lessonStatusModernService) {
          this.lessonStatusModernService.copyToTemplate();
        } else {
          this.warn('LessonStatusModernService が初期化されていません');
        }
      },
      
      'wizard-prev': () => this.wizardPrevStep(),
      'wizard-next': () => this.wizardNextStep(),

      // 通知設定
      'toggle-notification-mode': () => this.toggleNotificationMode(),

      // データ管理
      'export-data': () => {
        if (confirm('データをエクスポートしますか？')) {
          this.exportData();
        }
      },
      'clear-all-data': () => {
        if (confirm('本当にすべてのデータを削除しますか？この操作は取り消せません。')) {
          this.clearAllData();
        }
      },

      // システム管理
      'test-site-connection': () => this.testSiteConnection(),
      'reset-local-storage': () => {
        if (confirm('LocalStorageをリセットしますか？')) {
          this.resetLocalStorage();
        }
      },
      'show-debug-info': () => this.showDebugInfo(),
      'show-news-debug': () => this.showNewsDebug(),
      'close-modal': () => this.closeModal(),
      'open-external': (element, params) => this.openExternalUrl(params.url),

      // 認証関連
      'logout': () => this.handleAuthLogout(),

      // UIイベント
      'toggle-mobile-menu': (element) => this.toggleMobileMenu(element),

      // Instagram管理
      'switch-instagram-tab': (element, params) => this.switchInstagramTab(params.tab),
      'add-instagram-post': () => this.addInstagramPost(),
      'save-instagram-post': () => this.saveInstagramPost(),
      'refresh-instagram-posts': () => this.refreshInstagramPosts(),
      'save-instagram-settings': () => this.saveInstagramSettings(),
      'close-instagram-modal': () => this.closeInstagramModal(),
      'edit-instagram-post': (element, params) => {
        const postId = params.postId || element.dataset.postId;
        if (postId) {
          this.editInstagramPost(postId);
        } else {
          this.#showFeedback('投稿IDが見つかりません', 'error');
        }
      },
      'toggle-instagram-post': (element, params) => {
        const postId = params.postId || element.dataset.postId;
        if (postId) {
          this.toggleInstagramPostStatus(postId);
        } else {
          this.#showFeedback('投稿IDが見つかりません', 'error');
        }
      },
      'delete-instagram-post': async (element, params) => {
        const postId = params.postId || element.dataset.postId;
        if (postId && confirm('この投稿を削除しますか？')) {
          await this.deleteInstagramPost(postId);
        }
      }
    };

    // アクションを登録
    try {
      this.actionManager.registerMultiple(adminActions);
      console.log('✅ 管理画面アクション登録完了');
      console.log('🔍 登録されたアクション数:', Object.keys(adminActions).length);
      
      // 登録確認
      const registeredActions = Array.from(this.actionManager._actions?.keys() || []);
      console.log('🔍 ActionManagerに登録済みのアクション:', registeredActions);
      
    } catch (error) {
      console.error('❌ 管理画面アクション登録エラー:', error);
      this.error('管理画面アクション登録に失敗しました:', error);
    }
  }

  /**
   * UIイベントの設定
   * @private
   */
  setupUIEvents() {
    // レガシーEventBusイベントのマッピング（必要に応じて）
    EventBus.on('admin:needsRefresh', () => {
      this.refreshNewsList();
      this.refreshRecentArticles();
    });
    
    EventBus.on('admin:dataChanged', () => {
      this.refreshNewsList();
    });
    
    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.closeModal();
      }
    });
    
    // モーダル背景クリックで閉じる
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal') && e.target.classList.contains('show')) {
        this.closeModal();
      }
    });
    
    this.log('UIイベント設定完了');
  }

  /**
   * 管理画面固有の初期化
   * @private
   */
  async setupAdminUI() {
    try {
      this.debug('🎯 管理画面UI設定開始');
      
      // アクション登録
      this.#registerAdminActions();
      
      // UIイベント設定
      this.setupUIEvents();
      
      // タブナビゲーション設定
      this.setupTabNavigation();
      
      // レッスン状況モダンサービス初期化
      await this.initializeLessonStatusModern();
      
      // ニュース管理初期化
      await this.initializeNewsManagement();
      
      // 初期タブを強制的にダッシュボードに設定
      await this.forceTabSwitch('dashboard');

      // 最新統計の更新
      this.updateDashboardStats();
      this.updateAdminStats();
      
      // 初期データ読み込み
      await this.loadInitialData();
      
      this.debug('🎯 管理画面UI設定完了');
    } catch (error) {
      this.error('管理画面UI設定エラー:', error);
    }
  }

  /**
   * レッスン状況モダンサービス初期化
   * @private
   */
  async initializeLessonStatusModern() {
    try {
      this.debug('📅 レッスン状況モダンサービス初期化開始');
      
      // モダンサービスのインポートと初期化
      const { LessonStatusModernService } = await import('./LessonStatusModernService.js');
      this.lessonStatusModernService = new LessonStatusModernService();
      
      // 初期化実行（エラーが発生した場合は適切にハンドリング）
      await this.lessonStatusModernService.init();
      
      // グローバル参照設定
      window.lessonStatusModernService = this.lessonStatusModernService;
      
      this.debug('📅 レッスン状況モダンサービス初期化完了');
      
      // 初期化成功の通知
      if (this.uiManagerService) {
        this.uiManagerService.showNotification('success', 'レッスン状況管理機能が利用可能です', 3000);
      }
      
    } catch (error) {
      this.error('レッスン状況モダンサービス初期化エラー:', error);
      
      // ユーザーに分かりやすいエラー通知
      if (this.uiManagerService) {
        this.uiManagerService.showNotification('error', 'レッスン状況管理機能の初期化に失敗しました。ページを再読み込みしてください。', 5000);
      }
      
      // fallback として旧システムを使用
      this.warn('レッスン状況機能はレガシーモードで動作します');
    }
  }

  /**
   * ニュース管理初期化
   * @private
   */
  async initializeNewsManagement() {
    try {
      this.debug('📰 ニュース管理初期化開始');
      
      // 最近の記事を読み込み
      await this.refreshRecentArticles();
      
      this.debug('📰 ニュース管理初期化完了');
    } catch (error) {
      this.error('ニュース管理初期化エラー:', error);
    }
  }

  /**
   * 初期データ読み込み
   * @private
   */
  async loadInitialData() {
    try {
      this.debug('💾 初期データ読み込み開始');
      
      // レッスン状況の初期読み込み（旧システム互換性のため）
      await this.loadLessonStatus();
      
      this.debug('💾 初期データ読み込み完了');
    } catch (error) {
      this.error('初期データ読み込みエラー:', error);
    }
  }

  /**
   * サービスの初期化完了を待機
   * @private
   */
  async #waitForServicesReady() {
    const maxRetries = 10;
    const retryDelay = 100;
    
    for (let i = 0; i < maxRetries; i++) {
      if (this.articleDataService?.initialized && 
          this.lessonStatusService?.initialized &&
          this.uiManagerService?.initialized) {
        return true;
      }
      
      this.debug(`サービス初期化待機中... (${i + 1}/${maxRetries})`);
      await new Promise(resolve => setTimeout(resolve, retryDelay));
    }
    
    this.warn('一部のサービスの初期化が完了していません');
    return false;
  }

  /**
   * 管理画面タブ切り替え
   * @param {string} tabName - タブ名
   */
  async switchAdminTab(tabName) {
    console.log(`🔄 管理画面タブ切り替え開始: ${tabName}`);
    
    // バリデーション
    if (!this.#isValidTabName(tabName)) {
      console.error(`❌ 無効なタブ名: ${tabName}`);
      this.#showFeedback(`無効なタブ名: ${tabName}`, 'error');
      return;
    }

    try {
      // 現在のアクティブタブを取得
      const currentActiveTab = document.querySelector('.admin-section.active');
      const currentActiveNavItem = document.querySelector('.nav-item.active');
      
      console.log('🔍 現在のアクティブ要素:', {
        tab: currentActiveTab?.id,
        nav: currentActiveNavItem?.dataset?.tab
      });
      
      // アクティブ状態をクリア
      if (currentActiveTab) {
        currentActiveTab.classList.remove('active');
        console.log(`📤 旧タブ非アクティブ: ${currentActiveTab.id}`);
      }
      if (currentActiveNavItem) {
        currentActiveNavItem.classList.remove('active');
        console.log(`📤 旧ナビ非アクティブ: ${currentActiveNavItem.dataset.tab}`);
      }
      
      // 新しいタブとナビアイテムを取得
      const newActiveTab = document.getElementById(tabName);
      const newActiveNavItem = document.querySelector(`[data-tab="${tabName}"]`);
      
      console.log('🔍 新しいアクティブ要素:', {
        tab: newActiveTab?.id,
        nav: newActiveNavItem?.dataset?.tab,
        tabExists: !!newActiveTab,
        navExists: !!newActiveNavItem
      });
      
      // 要素の存在確認
      if (!newActiveTab) {
        console.error(`❌ タブセクションが見つかりません: #${tabName}`);
        this.#showFeedback(`タブセクション "${tabName}" が見つかりません`, 'error');
        return;
      }
      
      if (!newActiveNavItem) {
        console.error(`❌ ナビゲーションアイテムが見つかりません: [data-tab="${tabName}"]`);
        this.#showFeedback(`ナビゲーションアイテム "${tabName}" が見つかりません`, 'error');
        return;
      }
      
      // アクティブ状態を設定
      newActiveTab.classList.add('active');
      newActiveNavItem.classList.add('active');
      
      console.log(`📥 新タブアクティブ: ${newActiveTab.id}`);
      console.log(`📥 新ナビアクティブ: ${newActiveNavItem.dataset.tab}`);
      
      // 記事管理タブの場合は全体スクロール用のクラスを追加
      const adminMain = document.querySelector('.admin-main');
      if (adminMain) {
        if (tabName === 'news-management') {
          adminMain.classList.add('news-management-active');
          console.log('📄 記事管理タブ: 全体スクロールモード有効');
        } else {
          adminMain.classList.remove('news-management-active');
          console.log('📱 他のタブ: 固定高さモード');
        }
      }
      
      // タブ状態を統一ストレージキーで保存
      localStorage.setItem(this.storageKeys.adminTab, tabName);
      console.log(`💾 タブ状態保存: ${tabName}`);
      
      // タブ固有の初期化処理（非同期）
      await this.initializeTabContent(tabName);
      this.currentTab = tabName;
      
      // 成功通知
      const tabDisplayName = this.#getTabDisplayName(tabName);
      console.log(`✅ ${tabDisplayName}に切り替え完了`);
      this.#showFeedback(`${tabDisplayName}に切り替えました`, 'info', 2000);
      
    } catch (error) {
      console.error(`❌ タブ切り替えエラー (${tabName}):`, error);
      this.#showFeedback(`タブの切り替えに失敗しました: ${error.message}`, 'error');
    }
  }

  /**
   * タブ初期化（コンテンツ読み込み）
   * @private
   * @param {string} tabName - タブ名
   */
  async initializeTabContent(tabName) {
    console.log(`📋 タブコンテンツ初期化: ${tabName}`);
    
    try {
      switch (tabName) {
        case 'dashboard':
          // ダッシュボード統計の更新
          this.updateDashboardStats();
          
          // 最近の記事を読み込み
          await this.refreshRecentArticles();
          break;
          
        case 'news-management':
          // 記事管理の初期化
          await this.refreshRecentArticles();
          this.refreshNewsList();
          break;
          
        case 'lesson-status':
          // レッスン状況の初期化
          this.initializeWizard();
          await this.loadLessonStatus();
          break;
          
        case 'settings':
          // 設定タブの初期化（必要に応じて）
          break;
          
        default:
          console.warn(`未知のタブ: ${tabName}`);
      }
      
      console.log(`✅ タブコンテンツ初期化完了: ${tabName}`);
      
    } catch (error) {
      console.error(`❌ タブコンテンツ初期化エラー [${tabName}]:`, error);
      this.#showFeedback(`${tabName}タブの初期化に失敗しました`, 'error');
    }
  }

  /**
   * 有効なタブ名かチェック
   * @private
   * @param {string} tabName - タブ名
   * @returns {boolean}
   */
  #isValidTabName(tabName) {
    return ['dashboard', 'news-management', 'lesson-status', 'settings'].includes(tabName);
  }

  /**
   * タブ表示名を取得
   * @private
   * @param {string} tabName - タブ名
   * @returns {string}
   */
  #getTabDisplayName(tabName) {
    const tabNames = {
      'dashboard': 'ダッシュボード',
      'news-management': '記事管理',
      'lesson-status': 'レッスン状況',
      'settings': '設定'
    };
    return tabNames[tabName] || tabName;
  }

  /**
   * ダッシュボードの初期化
   * @private
   */
  async #initializeDashboard() {
    try {
      this.debug('🏠 ダッシュボード初期化開始');
      
      // 記事データサービスの初期化を確認
      await this.#ensureArticleDataReady();
      
      // 最近の記事と統計情報の読み込み
      await Promise.all([
        this.#loadRecentArticlesWithRetry(),
        this.#updateStats()
      ]);
      
      this.debug('✅ ダッシュボード初期化完了');
      
    } catch (error) {
      this.error('❌ ダッシュボード初期化エラー:', error);
      // エラーが発生してもアプリケーション全体は停止させない
    }
  }

  /**
   * 記事データの準備状態を確保
   * @private
   */
  async #ensureArticleDataReady() {
    const maxRetries = 5;
    const retryDelay = 200;
    
    for (let i = 0; i < maxRetries; i++) {
      if (this.articleDataService?.initialized) {
        return true;
      }
      
      this.debug(`記事データサービス準備待機中... (${i + 1}/${maxRetries})`);
      
      // 初期化されていない場合は再初期化を試行
      if (this.articleDataService && !this.articleDataService.initialized) {
        try {
          await this.articleDataService.init();
        } catch (error) {
          this.warn('記事データサービス再初期化失敗:', error);
        }
      }
      
      await new Promise(resolve => setTimeout(resolve, retryDelay));
    }
    
    throw new Error('記事データサービスの初期化がタイムアウトしました');
  }

  /**
   * 最近の記事をリトライ付きで読み込み
   * @private
   */
  async #loadRecentArticlesWithRetry() {
    const maxRetries = 3;
    const retryDelay = 500;
    
    for (let i = 0; i < maxRetries; i++) {
      try {
        await this.refreshRecentArticles();
        this.debug('最近の記事読み込み成功');
        return;
      } catch (error) {
        this.warn(`最近の記事読み込み試行 ${i + 1}/${maxRetries} 失敗:`, error);
        
        if (i < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
      }
    }
    
    // 最終的に失敗した場合はエラー状態を表示
    this.#showRecentArticlesError();
  }

  /**
   * 最近の記事のエラー状態を表示
   * @private
   */
  #showRecentArticlesError() {
    const recentContainer = document.getElementById('recent-articles');
    if (recentContainer) {
      recentContainer.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>記事の読み込みでエラーが発生しました</p>
          <button class="btn btn-sm btn-outline" data-action="refresh-recent-articles">
            <i class="fas fa-sync-alt"></i> 再試行
          </button>
        </div>
      `;
    }
  }

  /**
   * レッスン状況初期化
   * @private
   */
  async #initializeLessonStatus() {
    try {
      this.debug('📅 レッスン状況初期化開始');
      
      // ウィザードステップを初期化
      this.initializeWizard();
      
      // 今日の日付を自動設定
      const today = new Date().toISOString().slice(0, 10);
      const dateField = document.getElementById('lesson-date');
      if (dateField && !dateField.value) {
        dateField.value = today;
      }
      
      // 自動的に今日のレッスン状況を読み込み
      await this.loadLessonStatus();
      
      this.debug('📅 レッスン状況初期化完了');
    } catch (error) {
      this.error('レッスン状況初期化エラー:', error);
    }
  }

  /**
   * ウィザードを初期化
   */
  initializeWizard() {
    // 今日の日付を設定
    const today = new Date().toISOString().slice(0, 10);
    const dateField = document.getElementById('lesson-date');
    if (dateField && !dateField.value) {
      dateField.value = today;
    }
    
    // ボタンの初期状態を設定
    this.updateWizardButtons();
    
    console.log('✅ レッスン状況ウィザードを初期化しました');
  }

  /**
   * ウィザードステップを設定
   * @private
   * @param {number} step ステップ番号
   */
  #setWizardStep(step) {
    try {
      console.log(`🔮 ウィザードステップ設定: ${step}`);
      
      // 現在のステップを保存
      this.currentWizardStep = step;
      
      // すべてのステップからactiveクラスを削除
      document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active', 'completed');
      });
      
      // すべてのステップコンテンツを非表示
      document.querySelectorAll('.wizard-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // 現在のステップと以前のステップにクラスを設定
      for (let i = 1; i <= 2; i++) {
        const stepEl = document.querySelector(`.step[data-step="${i}"]`);
        const contentEl = document.querySelector(`.wizard-content.step-${i}`);
        
        if (i < step) {
          // 完了したステップ
          if (stepEl) stepEl.classList.add('completed');
        } else if (i === step) {
          // 現在のステップ
          if (stepEl) stepEl.classList.add('active');
          if (contentEl) contentEl.classList.add('active');
        }
      }
      
      console.log(`✅ ウィザードステップ ${step} に設定完了`);
      
    } catch (error) {
      console.error('❌ ウィザードステップ設定エラー:', error);
    }
  }

  /**
   * ウィザードボタンの状態を更新
   */
  updateWizardButtons() {
    try {
      const prevBtn = document.querySelector('.wizard-prev');
      const nextBtn = document.querySelector('.wizard-next');
      
      if (!prevBtn || !nextBtn) {
        // ウィザードボタンが存在しない場合は静かに返す（警告なし）
        return;
      }
      
      // 現在のステップに基づいてボタンの状態を設定
      const currentStep = this.currentWizardStep || 1;
      
      // 前へボタンの表示と状態設定
      prevBtn.style.display = 'flex';
      prevBtn.style.visibility = 'visible';
      prevBtn.style.opacity = '1';
      
      if (currentStep <= 1) {
        prevBtn.disabled = true;
        prevBtn.classList.add('disabled');
      } else {
        prevBtn.disabled = false;
        prevBtn.classList.remove('disabled');
      }
      
      // 次へボタンの表示と状態設定
      nextBtn.style.display = 'flex';
      nextBtn.style.visibility = 'visible';
      nextBtn.style.opacity = '1';
      
      if (currentStep >= 2) {
        nextBtn.disabled = true;
        nextBtn.classList.add('disabled');
        nextBtn.innerHTML = '<i class="fas fa-check"></i> 完了';
      } else {
        nextBtn.disabled = false;
        nextBtn.classList.remove('disabled');
        nextBtn.innerHTML = '次へ <i class="fas fa-chevron-right"></i>';
      }
      
      console.log(`✅ ウィザードボタン状態更新: ステップ${currentStep}`, {
        'prevBtn-display': prevBtn.style.display,
        'nextBtn-display': nextBtn.style.display,
        'prevBtn-disabled': prevBtn.disabled,
        'nextBtn-disabled': nextBtn.disabled
      });
      
    } catch (error) {
      console.error('❌ ウィザードボタン状態更新エラー:', error);
    }
  }

  /**
   * 設定初期化
   * @private
   */
  async #initializeSettings() {
    try {
      this.debug('⚙️ 設定タブ初期化開始');
      
      // データエクスポートサービスのセットアップ（まだでなければ）
      if (!this.dataExportService) {
        await this.setupDataExportService();
      }
      
      this.debug('⚙️ 設定タブ初期化完了');
    } catch (error) {
      this.error('設定初期化エラー:', error);
    }
  }

  /**
   * Instagram管理初期化
   * @private
   */
  async #initializeInstagramManagement() {
    try {
      this.debug('📸 Instagram管理初期化開始');
      
      // Instagram管理セクションが存在することを確認
      const instagramSection = document.getElementById('instagram-management');
      if (!instagramSection) {
        console.warn('⚠️ Instagram管理セクションが見つかりません');
        return;
      }
      
      // Instagram管理セクションがアクティブかどうか確認
      if (!instagramSection.classList.contains('active')) {
        console.warn('⚠️ Instagram管理セクションがアクティブではありません');
        return;
      }
      
      console.log('✅ Instagram管理セクションを確認しました');
      
      // Instagram管理タブの設定と表示を確実に行う
      this.#setupInstagramTabs();
      
      // DOM要素の存在確認後にタブ切り替えと投稿読み込みを実行
      setTimeout(() => {
        // デフォルトで投稿管理タブを表示
        this.switchInstagramTab('posts');
        
        // Instagram投稿一覧を読み込み
        this.refreshInstagramPosts();
      }, 100);
      
      this.debug('📸 Instagram管理初期化完了');
    } catch (error) {
      this.error('Instagram管理初期化エラー:', error);
    }
  }

  /**
   * Instagramタブの設定
   * @private
   */
  #setupInstagramTabs() {
    console.log('🔧 Instagramタブ設定開始');
    
    try {
      // タブボタンが存在することを確認
      const tabButtons = document.querySelectorAll('.sub-nav-item[data-action="switch-instagram-tab"]');
      console.log('📋 検出されたタブボタン数:', tabButtons.length);
      
      if (tabButtons.length === 0) {
        console.warn('⚠️ Instagramタブボタンが見つかりません');
        return;
      }
      
      // タブコンテンツが存在することを確認
      const tabContents = document.querySelectorAll('.instagram-tab-content');
      console.log('📄 検出されたタブコンテンツ数:', tabContents.length);
      
      if (tabContents.length === 0) {
        console.warn('⚠️ Instagramタブコンテンツが見つかりません');
        return;
      }
      
      // 各タブボタンの状態をチェック
      tabButtons.forEach((button, index) => {
        const tabName = button.dataset.tab;
        console.log(`🏷️ タブ${index + 1}: ${tabName}`);
        
        // data-tab属性が正しく設定されているかチェック
        if (!tabName) {
          console.warn(`⚠️ タブボタン${index + 1}にdata-tab属性がありません`, button);
        }
      });
      
      // 各タブコンテンツの状態をチェック
      tabContents.forEach((content, index) => {
        const contentId = content.id;
        console.log(`📖 コンテンツ${index + 1}: ${contentId}`);
        
        // IDが正しく設定されているかチェック
        if (!contentId || !contentId.includes('instagram-') || !contentId.includes('-tab')) {
          console.warn(`⚠️ タブコンテンツ${index + 1}のIDが不正です:`, contentId);
        }
      });
      
      // 必要なタブが揃っているかチェック
      const expectedTabs = ['posts', 'settings'];
      const availableTabs = Array.from(tabButtons).map(btn => btn.dataset.tab).filter(Boolean);
      
      expectedTabs.forEach(expectedTab => {
        if (!availableTabs.includes(expectedTab)) {
          console.warn(`⚠️ 必要なタブが見つかりません: ${expectedTab}`);
        }
      });
      
      console.log('✅ Instagramタブ設定完了');
      
    } catch (error) {
      console.error('❌ Instagramタブ設定エラー:', error);
    }
  }

  // === 記事管理関連メソッド ===

  /**
   * 記事エディターをクリア
   */
  clearNewsEditor() {
    try {
      // フォームフィールドをクリア
      const titleField = document.getElementById('news-title');
      const categoryField = document.getElementById('news-category');
      const dateField = document.getElementById('news-date');
      const statusField = document.getElementById('news-status');
      const summaryField = document.getElementById('news-summary');
      const contentField = document.getElementById('news-content');
      const featuredField = document.getElementById('news-featured');
      const idField = document.getElementById('news-id');

      if (titleField) titleField.value = '';
      if (categoryField) categoryField.value = 'announcement';
      if (dateField) dateField.value = '';
      if (statusField) statusField.value = 'draft';
      if (summaryField) summaryField.value = '';
      if (contentField) contentField.value = '';
      if (featuredField) featuredField.checked = false;
      if (idField) idField.value = '';

      // エディタータイトルを更新
      const editorTitle = document.getElementById('editor-title');
      if (editorTitle) {
        editorTitle.textContent = '新規記事作成';
      }

      // ユーザーアクションなので通知を表示
      this.#showFeedback('記事エディターをクリアしました');
      console.log('📝 記事エディターをクリア');

    } catch (error) {
      console.error('❌ 記事エディタークリアエラー:', error);
      this.#showFeedback('エディターのクリアに失敗しました', 'error');
    }
  }

  /**
   * 記事プレビュー
   */
  async previewNews() {
    try {
      console.log('👁️ 記事プレビュー開始');
      
      // フォームデータを取得
      const formData = this.#getNewsFormData();
      
      if (!formData.title.trim()) {
        this.#showFeedback('タイトルが入力されていません', 'error');
        return;
      }
      
      if (!formData.content.trim()) {
        this.#showFeedback('本文が入力されていません', 'error');
        return;
      }
      
      // プレビューモーダルを作成・表示
      this.#showNewsPreviewModal(formData);
      
      // ユーザーアクションなので通知を表示
      this.#showFeedback('プレビューを表示しました');
      
    } catch (error) {
      console.error('❌ 記事プレビューエラー:', error);
      this.#showFeedback('プレビューの表示に失敗しました', 'error');
    }
  }

  /**
   * 記事保存
   */
  async saveNews() {
    try {
      const articleData = this.#getArticleDataFromForm();
      
      if (!this.#validateArticleData(articleData)) {
        return;
      }

      const result = await this.articleDataService.saveArticle(articleData, false);
      
      if (result.success) {
        // フォームに記事IDを設定
        const idField = document.getElementById('news-id');
        if (idField && result.id) {
          idField.value = result.id;
        }

        // ボタンアクション用のイベントを発行（通知表示用）
        EventBus.emit('button:article:saved', { 
          title: articleData.title,
          id: result.id 
        });
        
        console.log('💾 記事を保存:', result);
      } else {
        this.#showFeedback(result.message || '保存に失敗しました', 'error');
      }

    } catch (error) {
      console.error('❌ 記事保存エラー:', error);
      this.#showFeedback('記事の保存中にエラーが発生しました', 'error');
    }
  }

  /**
   * 記事公開
   */
  async publishNews() {
    try {
      const articleData = this.#getArticleDataFromForm();
      
      if (!this.#validateArticleData(articleData)) {
        return;
      }

      const result = await this.articleDataService.saveArticle(articleData, true);
      
      if (result.success) {
        // フォームに記事IDを設定
        const idField = document.getElementById('news-id');
        if (idField && result.id) {
          idField.value = result.id;
        }

        // ステータスフィールドを更新
        const statusField = document.getElementById('news-status');
        if (statusField) {
          statusField.value = 'published';
        }

        // ボタンアクション用のイベントを発行（通知表示用）
        EventBus.emit('button:article:published', { 
          title: articleData.title,
          id: result.id 
        });
        
        console.log('📤 記事を公開:', result);
      } else {
        this.#showFeedback(result.message || '公開に失敗しました', 'error');
      }

    } catch (error) {
      console.error('❌ 記事公開エラー:', error);
      this.#showFeedback('記事の公開中にエラーが発生しました', 'error');
    }
  }

  /**
   * ArticleService テスト
   */
  async testArticleService() {
    try {
      console.log('🧪 ArticleService 連携テスト開始');
      
      // サービス状態確認
      const status = this.articleDataService.getStatus();
      console.log('📊 ArticleService ステータス:', status);
      
      // 記事数取得
      const articles = this.articleDataService.loadArticles();
      console.log('📰 記事数:', articles.length);
      
      // 統計情報取得
      const stats = this.articleDataService.getStats();
      console.log('📈 統計情報:', stats);
      
      this.#showFeedback(`連携テスト完了 - 記事数: ${articles.length}件`);
      
    } catch (error) {
      console.error('❌ ArticleService テストエラー:', error);
      this.#showFeedback('連携テストに失敗しました', 'error');
    }
  }

  /**
   * Markdownテキスト挿入
   */
  insertMarkdown(element, params) {
    try {
      const contentField = document.getElementById('news-content');
      if (!contentField) return;

      const start = contentField.selectionStart;
      const end = contentField.selectionEnd;
      const selectedText = contentField.value.substring(start, end);
      
      const beforeText = params.start || '';
      const afterText = params.end || '';
      
      let newText;
      if (selectedText) {
        newText = beforeText + selectedText + afterText;
      } else {
        newText = beforeText + afterText;
      }
      
      const beforeSelection = contentField.value.substring(0, start);
      const afterSelection = contentField.value.substring(end);
      
      contentField.value = beforeSelection + newText + afterSelection;
      
      // カーソル位置を調整
      const newCursorPos = start + beforeText.length + selectedText.length;
      contentField.setSelectionRange(newCursorPos, newCursorPos);
      contentField.focus();
      
      console.log('📝 Markdownテキストを挿入:', { start: beforeText, end: afterText });
      
    } catch (error) {
      console.error('❌ Markdownテキスト挿入エラー:', error);
    }
  }

  // === ニュース一覧管理メソッド ===

  /**
   * ニュース一覧フィルタリング
   */
  filterNewsList(element, params) {
    try {
      const filterValue = element?.value || 'all';
      console.log('🔍 ニュース一覧フィルタリング:', filterValue);
      
      this.#renderNewsList(filterValue);
      
    } catch (error) {
      console.error('❌ ニュース一覧フィルタリングエラー:', error);
    }
  }

  /**
   * ニュース一覧更新
   */
  refreshNewsList() {
    try {
      console.log('🔄 ニュース一覧更新');
      this.#renderNewsList();
      // 内部処理なので通知は表示しない（コンソールログのみ）
      console.log('✅ ニュース一覧更新完了');
      
    } catch (error) {
      console.error('❌ ニュース一覧更新エラー:', error);
      this.#showFeedback('一覧の更新に失敗しました', 'error');
    }
  }

  /**
   * 最近の記事更新表示
   */
  async refreshRecentArticles() {
    try {
      console.log('🔄 最近の記事更新開始');
      
      const recentContainer = document.getElementById('recent-articles');
      if (!recentContainer) {
        console.warn('⚠️ recent-articles コンテナが見つかりません');
        return;
      }
      
      // ローディング表示
      recentContainer.innerHTML = `
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          記事を読み込み中...
        </div>
      `;
      
      // CONFIG.jsで定義されたキーを使用して記事データを取得
      const articlesKey = CONFIG.storage.keys.articles;
      const articlesData = localStorage.getItem(articlesKey);
      
      let articles = [];
      
      if (articlesData) {
        try {
          const parsedArticles = JSON.parse(articlesData);
          if (Array.isArray(parsedArticles)) {
            // 有効な記事のみフィルタリング（Instagram関連を完全除外）
            articles = parsedArticles.filter(article => {
              if (!article || !article.id || !article.title) {
                return false;
              }
              
              // Instagram関連のコンテンツを完全除外
              const title = article.title.toLowerCase();
              const summary = (article.summary || '').toLowerCase();
              const content = (article.content || '').toLowerCase();
              
              const hasInstagram = title.includes('instagram') || 
                                 title.includes('インスタグラム') ||
                                 title.includes('インスタ') ||
                                 summary.includes('instagram') ||
                                 summary.includes('インスタグラム') ||
                                 content.includes('instagram管理') ||
                                 content.includes('投稿リンク');
              
              return !hasInstagram;
            });
            
            console.log(`📄 有効な記事: ${articles.length}件（除外後）`);
          }
        } catch (parseError) {
          console.error('記事データの解析エラー:', parseError);
          articles = [];
        }
      }
      
      // 最近の記事をソートして最大5件表示
      const recentArticles = articles
        .sort((a, b) => {
          const dateA = new Date(a.updatedAt || a.createdAt || 0);
          const dateB = new Date(b.updatedAt || b.createdAt || 0);
          return dateB - dateA;
        })
        .slice(0, 5);
      
      // HTML生成
      let html = '';
      
      if (recentArticles.length === 0) {
        html = `
          <div class="empty-state">
            <i class="fas fa-newspaper"></i>
            <p>記事がまだありません</p>
            <button class="btn btn-primary" data-action="new-news-article">
              <i class="fas fa-plus"></i> 新規記事を作成
            </button>
          </div>
        `;
      } else {
        html = recentArticles.map(article => {
          const title = this.escapeHtml(article.title || '無題の記事');
          const summary = article.summary ? 
            this.escapeHtml(article.summary.length > 60 ? article.summary.substring(0, 60) + '...' : article.summary) : 
            '概要なし';
          const createdDate = new Date(article.createdAt || Date.now());
          const formattedDate = createdDate.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          const statusText = article.status === 'published' ? '公開中' : '下書き';
          const categoryName = this.#getCategoryName(article.category || 'announcement');
          
          return `
            <div class="recent-article-item" data-id="${article.id}">
              <div class="recent-article-content">
                <div class="recent-article-header">
                  <div class="recent-article-main">
                    <h3 class="recent-article-title">${title}</h3>
                    <div class="recent-article-summary">${summary}</div>
                  </div>
                  <div class="recent-article-actions">
                    <button class="action-btn-modern edit-btn" 
                            data-action="edit-article" 
                            data-article-id="${article.id}" 
                            title="記事を編集"
                            aria-label="記事「${title}」を編集">
                      <i class="fas fa-edit"></i>
                      <span class="action-text">編集</span>
                    </button>
                    <button class="action-btn-modern preview-btn" 
                            data-action="preview-article" 
                            data-article-id="${article.id}" 
                            title="記事をプレビュー"
                            aria-label="記事「${title}」をプレビュー">
                      <i class="fas fa-eye"></i>
                      <span class="action-text">プレビュー</span>
                    </button>
                  </div>
                </div>
                <div class="recent-article-meta">
                  <span class="category-badge ${article.category || 'announcement'}">${categoryName}</span>
                  <span class="status-badge ${article.status || 'draft'}">${statusText}</span>
                  <span class="date-info">${formattedDate}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      recentContainer.innerHTML = html;
      console.log(`✅ 最近の記事更新完了 - ${recentArticles.length}件表示`);
      
    } catch (error) {
      console.error('❌ 最近の記事更新エラー:', error);
      
      const recentContainer = document.getElementById('recent-articles');
      if (recentContainer) {
        recentContainer.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>記事の読み込みに失敗しました</p>
            <button class="btn btn-outline" data-action="refresh-recent-articles">
              <i class="fas fa-refresh"></i> 再試行
            </button>
          </div>
        `;
      }
    }
  }

  /**
   * 最近の記事のローディング状態を表示
   * @private
   */
  // このメソッドは削除 - refreshRecentArticles内で直接処理

  // === レッスン状況管理メソッド ===

  /**
   * レッスン状況読み込み
   */
  async loadLessonStatus() {
    try {
      // モダンサービス優先で実行
      if (this.lessonStatusModernService && typeof this.lessonStatusModernService.loadLessonStatusModern === 'function') {
        await this.lessonStatusModernService.loadLessonStatusModern();
        this.log('✅ モダンサービスでレッスン状況を読み込みました');
        return;
      }
      
      // フォールバック: レガシーシステム
      const targetDate = document.getElementById('lesson-date')?.value || this.#getTodayDateString();
      
      // レガシーシステムによる読み込み（モダンサービス未利用時のフォールバック）
      const lessonStatusService = getLessonStatusStorageService();
      const data = lessonStatusService.getStatusByDate(targetDate);
      
      if (data) {
        // UIに反映（適切なメソッドが存在する場合）
        // UIに反映
        this.#populateLessonStatusForm(data);
        
        // フォールバック通知（モダンサービスが無い場合のみ）
        console.log(`✅ ${targetDate} のレッスン状況を読み込みました（レガシーモード）`);
      } else {
        this.warn(`${targetDate} のレッスン状況が見つかりません`);
      }
      
    } catch (error) {
      this.error('レッスン状況読み込みエラー:', error);
      this.#showFeedback('レッスン状況の読み込みに失敗しました', 'error');
    }
  }

  /**
   * レッスン状況をフォームに反映（プライベートメソッド）
   * @private
   * @param {Object} data - レッスン状況データ
   */
  #populateLessonStatusForm(data) {
    try {
      // 日付設定
      if (data.date) {
        const dateField = document.getElementById('lesson-date');
        if (dateField) dateField.value = data.date;
      }
      
      // グローバルメッセージ設定
      if (data.globalMessage) {
        const messageField = document.getElementById('global-message');
        if (messageField) messageField.value = data.globalMessage;
      }
      
      // グローバルステータス設定（英語キーから日本語値にマッピング）
      if (data.globalStatus) {
        const globalJapanese = this.#mapStatusKeyToJapanese(data.globalStatus);
        const globalRadio = document.querySelector(`input[name="global-status"][value="${globalJapanese}"]`);
        if (globalRadio) globalRadio.checked = true;
      }
      
      // ベーシックコース設定
      if (data.courses?.basic?.status) {
        const basicJapanese = this.#mapStatusKeyToJapanese(data.courses.basic.status);
        const basicRadio = document.querySelector(`input[name="basic-lesson"][value="${basicJapanese}"]`);
        if (basicRadio) basicRadio.checked = true;
      }
      
      if (data.courses?.basic?.message) {
        const basicMessageField = document.getElementById('basic-lesson-note');
        if (basicMessageField) basicMessageField.value = data.courses.basic.message;
      }
      
      // アドバンスコース設定
      if (data.courses?.advance?.status) {
        const advanceJapanese = this.#mapStatusKeyToJapanese(data.courses.advance.status);
        const advanceRadio = document.querySelector(`input[name="advance-lesson"][value="${advanceJapanese}"]`);
        if (advanceRadio) advanceRadio.checked = true;
      }
      
      if (data.courses?.advance?.message) {
        const advanceMessageField = document.getElementById('advance-lesson-note');
        if (advanceMessageField) advanceMessageField.value = data.courses.advance.message;
      }
      
      this.debug('レッスン状況フォーム設定完了');
      
    } catch (error) {
      this.error('レッスン状況フォーム設定エラー:', error);
      this.#showFeedback('データの反映中にエラーが発生しました', 'error');
    }
  }

  /**
   * ステータスキーを日本語に変換（プライベートメソッド）
   * @private
   * @param {string} statusKey - ステータスキー
   * @returns {string} 日本語ステータス
   */
  #mapStatusKeyToJapanese(statusKey) {
    const mapping = {
      'scheduled': '通常開催',
      'cancelled': '中止',
      'indoor': '室内開催',
      'postponed': '延期'
    };
    return mapping[statusKey] || '通常開催';
  }

  /**
   * フォームからレッスン状況データを取得（プライベートメソッド）
   * @private
   * @returns {Object} レッスン状況データ
   */
  #getLessonStatusFromForm() {
    const dateField = document.getElementById('lesson-date');
    const globalMessageField = document.getElementById('global-message');
    
    // グローバルステータス取得
    const globalStatusRadio = document.querySelector('input[name="global-status"]:checked');
    const globalStatus = globalStatusRadio ? this.#mapJapaneseToStatusKey(globalStatusRadio.value) : 'scheduled';
    
    // ベーシックコース
    const basicStatusRadio = document.querySelector('input[name="basic-lesson"]:checked');
    const basicStatus = basicStatusRadio ? this.#mapJapaneseToStatusKey(basicStatusRadio.value) : 'scheduled';
    const basicMessageField = document.getElementById('basic-lesson-note');
    
    // アドバンスコース
    const advanceStatusRadio = document.querySelector('input[name="advance-lesson"]:checked');
    const advanceStatus = advanceStatusRadio ? this.#mapJapaneseToStatusKey(advanceStatusRadio.value) : 'scheduled';
    const advanceMessageField = document.getElementById('advance-lesson-note');
    
    return {
      date: dateField?.value || this.#getTodayDateString(),
      globalStatus: globalStatus,
      globalMessage: globalMessageField?.value || '',
      courses: {
        basic: {
          name: 'ベーシックコース（年長〜小3）',
          time: '17:00-17:50',
          status: basicStatus,
          message: basicMessageField?.value || ''
        },
        advance: {
          name: 'アドバンスコース（小4〜小6）',
          time: '18:00-18:50',
          status: advanceStatus,
          message: advanceMessageField?.value || ''
        }
      }
    };
  }

  /**
   * 日本語ステータスをキーに変換（プライベートメソッド）
   * @private
   * @param {string} japanese - 日本語ステータス
   * @returns {string} ステータスキー
   */
  #mapJapaneseToStatusKey(japanese) {
    const mapping = {
      '通常開催': 'scheduled',
      '中止': 'cancelled',
      '室内開催': 'indoor',
      '延期': 'postponed'
    };
    return mapping[japanese] || 'scheduled';
  }

  /**
   * 今日の日付文字列を取得（プライベートメソッド）
   * @private
   * @returns {string} YYYY-MM-DD形式の日付
   */
  #getTodayDateString() {
    return new Date().toISOString().slice(0, 10);
  }

  /**
   * レッスン状況更新
   */
  async updateLessonStatus() {
    try {
      // フォームデータの取得とバリデーション
      const statusData = this.#getLessonStatusFromForm();
      
      if (!this.#validateLessonStatusData(statusData)) {
        return; // バリデーションエラーのメッセージは#validateLessonStatusData内で表示
      }
      
      console.log('📝 レッスン状況更新:', statusData);
      
      // 保存前の確認
      const confirmMessage = `${statusData.date} のレッスン状況を更新しますか？\n\n` +
        `全体ステータス: ${this.#mapStatusKeyToJapanese(statusData.globalStatus)}\n` +
        `ベーシックコース: ${this.#mapStatusKeyToJapanese(statusData.courses.basic.status)}\n` +
        `アドバンスコース: ${this.#mapStatusKeyToJapanese(statusData.courses.advance.status)}`;
      
      if (!confirm(confirmMessage)) {
        this.#showFeedback('更新をキャンセルしました', 'info');
        return;
      }
      
      // 保存処理実行
      const result = await this.lessonStatusService.updateStatus(statusData);
      
      if (result.success) {
        // ボタンアクション用のイベントを発行（通知表示用）
        EventBus.emit('button:lessonStatus:updated', { 
          date: statusData.date 
        });
        
        // LP側のレッスン状況表示も更新
        if (window.lessonStatusDisplay && typeof window.lessonStatusDisplay.refresh === 'function') {
          window.lessonStatusDisplay.refresh();
        }
        
      } else {
        this.#showFeedback(result.error || '更新に失敗しました', 'error');
      }
      
    } catch (error) {
      console.error('❌ レッスン状況更新エラー:', error);
      this.#showFeedback('レッスン状況の更新中にエラーが発生しました', 'error');
    }
  }

  /**
   * レッスン状況データのバリデーション
   * @private
   * @param {Object} statusData - レッスン状況データ
   * @returns {boolean} バリデーション成功時true
   */
  #validateLessonStatusData(statusData) {
    // 日付チェック
    if (!statusData.date) {
      this.#showFeedback('対象日を選択してください', 'error');
      return false;
    }
    
    // 日付形式チェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(statusData.date)) {
      this.#showFeedback('正しい日付形式で入力してください (YYYY-MM-DD)', 'error');
      return false;
    }
    
    // グローバルメッセージ長チェック
    if (statusData.globalMessage && statusData.globalMessage.length > 500) {
      this.#showFeedback('全体メッセージは500文字以内で入力してください', 'error');
      return false;
    }
    
    // ステータス値チェック
    const validStatuses = ['scheduled', 'cancelled', 'indoor', 'postponed'];
    if (!validStatuses.includes(statusData.globalStatus)) {
      this.#showFeedback('無効な全体ステータスが選択されています', 'error');
      return false;
    }
    
    // コースステータスチェック
    for (const [courseKey, courseData] of Object.entries(statusData.courses)) {
      if (!validStatuses.includes(courseData.status)) {
        this.#showFeedback(`無効な${courseKey}コースステータスが選択されています`, 'error');
        return false;
      }
      
      // コースメッセージ長チェックを追加
      if (courseData.message && courseData.message.length > 500) {
        this.#showFeedback(`${courseKey}コースのメッセージは500文字以内で入力してください`, 'error');
        return false;
      }
    }
    
    return true;
  }

  // === データ管理メソッド ===

  /**
   * データエクスポート
   */
  async exportData() {
    try {
      this.info('データエクスポートを開始しています...');
      
      if (!this.dataExportService) {
        throw new Error('DataExportServiceが初期化されていません');
      }
      
      const result = await this.dataExportService.exportAllData();
      if (result.success) {
        this.success(`データエクスポートが完了しました: ${result.filename}`);
      } else {
        this.error(`データエクスポートに失敗しました: ${result.message}`);
      }
      
    } catch (error) {
      this.error('データエクスポート処理中にエラーが発生しました:', error);
    }
  }

  /**
   * 全データクリア
   */
  async clearAllData() {
    console.log('🗑️ 全データクリア開始');
    
    const confirmed = confirm(
      '全てのデータ（記事、レッスン状況、Instagram投稿、設定など）を削除します。\n\nこの操作は元に戻せません。実行しますか？'
    );
    
    if (!confirmed) {
      console.log('❌ ユーザーによってキャンセルされました');
      return;
    }
    
    try {
      // 統合ストレージサービスのクリア
      if (this.articleDataService?.storageService) {
        await this.articleDataService.storageService.clearAllData();
        console.log('✅ 記事データクリア完了');
      }
      
      // レッスン状況データのクリア
      if (this.lessonStatusService) {
        this.lessonStatusService.clearAllData();
        console.log('✅ レッスン状況データクリア完了');
      }
      
      // Instagram関連データのクリア
      const instagramKeys = [
        `${CONFIG.storage.prefix}instagram_posts`,
        `${CONFIG.storage.prefix}instagram_settings`,
        'rbs_instagram_posts',  // 旧形式
        'rbs_instagram_settings'  // 旧形式
      ];
      
      instagramKeys.forEach(key => {
        const had = localStorage.getItem(key) !== null;
        localStorage.removeItem(key);
        if (had) {
          console.log(`✅ Instagram データクリア: ${key}`);
        }
      });
      
      // 管理画面設定のクリア
      Object.values(this.storageKeys).forEach(key => {
        const had = localStorage.getItem(key) !== null;
        localStorage.removeItem(key);
        if (had) {
          console.log(`✅ 管理画面設定クリア: ${key}`);
        }
      });
      
      // 認証データのクリア
      const authKeys = [
        CONFIG.storage.keys.auth,
        CONFIG.storage.keys.session
      ];
      
      authKeys.forEach(key => {
        const had = localStorage.getItem(key) !== null;
        localStorage.removeItem(key);
        if (had) {
          console.log(`✅ 認証データクリア: ${key}`);
        }
      });
      
      console.log('✅ 全データクリア完了');
      this.success('全てのデータを削除しました');
      
      // データ更新を全体に通知
      this.refreshRecentArticles();
      this.updateDashboardStats();
      
      // ダッシュボードタブに強制切り替え
      await this.forceTabSwitch('dashboard');
      
    } catch (error) {
      console.error('❌ 全データクリアエラー:', error);
      this.error(`データ削除中にエラーが発生しました: ${error.message}`);
    }
  }

  // === システム管理メソッド ===

  /**
   * サイト接続テスト
   */
  async testSiteConnection() {
    try {
      console.log('🌐 サイト接続テスト開始');
      
      const testResults = {
        indexPage: false,
        newsPage: false,
        adminPage: true // 現在開いているので確実にtrue
      };
      
      // index.htmlの確認
      try {
        const indexResponse = await fetch('index.html', { method: 'HEAD' });
        testResults.indexPage = indexResponse.ok;
      } catch (e) {
        console.log('Index page test failed:', e.message);
      }
      
      // news.htmlの確認
      try {
        const newsResponse = await fetch('news.html', { method: 'HEAD' });
        testResults.newsPage = newsResponse.ok;
      } catch (e) {
        console.log('News page test failed:', e.message);
      }
      
      // 結果表示
      const resultContainer = document.getElementById('site-connection-test-results');
      if (resultContainer) {
        resultContainer.innerHTML = this.#generateConnectionTestResults(testResults);
      }
      
      const successCount = Object.values(testResults).filter(Boolean).length;
      this.#showFeedback(`接続テスト完了: ${successCount}/3 ページが正常`);
      
    } catch (error) {
      console.error('❌ サイト接続テストエラー:', error);
      this.#showFeedback('接続テストに失敗しました', 'error');
    }
  }

  /**
   * LocalStorage リセット
   */
  resetLocalStorage() {
    try {
      console.log('🔄 LocalStorage リセット');
      
      // RBS関連のキーのみを削除
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('rbs_')) {
          keysToRemove.push(key);
        }
      }
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // UI更新
      this.refreshNewsList();
      this.refreshRecentArticles();
      this.clearNewsEditor();
      
      this.#showFeedback(`LocalStorageをリセットしました (${keysToRemove.length}件削除)`);
      
    } catch (error) {
      console.error('❌ LocalStorageリセットエラー:', error);
      this.#showFeedback('LocalStorageのリセットに失敗しました', 'error');
    }
  }

  /**
   * 外部URLを開く
   */
  openExternalUrl(url) {
    try {
      if (url) {
        // 相対パスの場合は適切なベースURLを設定
        if (url.startsWith('../') || url.startsWith('./') || !url.includes('://')) {
          const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
          const fullUrl = new URL(url, baseUrl).href;
          window.open(fullUrl, '_blank', 'noopener,noreferrer');
        } else {
          window.open(url, '_blank', 'noopener,noreferrer');
        }
      }
    } catch (error) {
      this.error('外部URL開くエラー:', error);
    }
  }

  // === 認証・デバッグメソッド ===

  /**
   * 認証ログアウト時の処理
   * AuthServiceからのコールバックとして実行される
   * @private
   */
  handleAuthLogout() {
    try {
      this.info('認証サービスからログアウトされました');
      
      // セッション監視を停止（既にAuthServiceで停止されているが念のため）
      this.stopSessionMonitoring();
      
      // UIをクリア
      this.clearAdminUI();
      
    } catch (error) {
      this.error('認証ログアウト処理エラー:', error);
    }
  }

  /**
   * セッション情報表示の更新
   * @param {Object} sessionInfo - セッション情報
   * @private
   */
  updateSessionInfoDisplay(sessionInfo) {
    try {
      const sessionInfoElement = document.getElementById('session-remaining');
      if (!sessionInfoElement) return;

      if (sessionInfo && sessionInfo.isAuthenticated) {
        const remainingTime = this.authService.getSessionRemainingTimeFormatted();
        const remainingMs = this.authService.getSessionRemainingTime();
        
        sessionInfoElement.textContent = remainingTime;
        
        // 残り時間に応じてスタイルを変更
        const sessionInfoContainer = document.getElementById('session-info');
        if (sessionInfoContainer) {
          // 2時間未満の場合は警告表示
          if (remainingMs < 2 * 60 * 60 * 1000) {
            sessionInfoContainer.classList.add('warning');
          } else {
            sessionInfoContainer.classList.remove('warning');
          }
        }
        
        this.debug(`セッション残り時間: ${remainingTime}`);
      } else {
        sessionInfoElement.textContent = '未認証';
      }
    } catch (error) {
      this.error('セッション情報表示更新エラー:', error);
      const sessionInfoElement = document.getElementById('session-remaining');
      if (sessionInfoElement) {
        sessionInfoElement.textContent = 'エラー';
      }
    }
  }

  /**
   * 管理画面UIをクリア
   * @private
   */
  clearAdminUI() {
    try {
      // フォームをクリア
      const forms = document.querySelectorAll('form');
      forms.forEach(form => form.reset());
      
      // 編集中のデータをクリア
      this.hasUnsavedChanges = false;
      
      this.debug('管理画面UIクリア完了');
    } catch (error) {
      this.error('管理画面UIクリアエラー:', error);
    }
  }

  /**
   * セッション情報の更新 - DEPRECATED
   * 
   * @deprecated AuthServiceのコールバック機能を使用してください
   */
  updateSessionInfo() {
    this.warn('updateSessionInfo() は非推奨です。AuthServiceのコールバック機能を使用してください。');
    // AuthServiceのコールバック機能によって自動的に更新されるため、何もしない
  }

  /**
   * セッション監視を開始 - DEPRECATED
   * 
   * @deprecated AuthServiceのセッション監視を使用してください
   */
  startSessionMonitoring() {
    this.warn('startSessionMonitoring() は非推奨です。AuthServiceで自動的に開始されます。');
    // AuthServiceで自動的に開始されるため、何もしない
  }

  /**
   * セッション監視を停止
   */
  stopSessionMonitoring() {
    if (this.sessionUpdateInterval) {
      clearInterval(this.sessionUpdateInterval);
      this.sessionUpdateInterval = null;
      this.log('レガシーセッション情報の定期更新を停止しました');
    }
  }

  /**
   * デバッグ情報表示
   */
  showDebugInfo() {
    try {
      console.log('🐛 デバッグ情報表示');
      
      const debugInfo = {
        currentTab: this.currentTab,
        initialized: this.initialized,
        articleService: this.articleDataService?.getStatus(),
        instagramService: this.instagramDataService.getStatus(),
        lessonService: this.lessonStatusService.getStatus(),
        uiManager: this.uiManagerService.getStatus(),
        browser: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled
        },
        storage: {
          localStorageAvailable: !!window.localStorage,
          sessionStorageAvailable: !!window.sessionStorage
        }
      };
      
      console.table(debugInfo);
      
      // デバッグコンテンツHTML生成
      const debugContent = `
        <div class="debug-info">
          <h4>システム情報</h4>
          <table class="debug-table">
            <tr><td>現在のタブ</td><td>${debugInfo.currentTab}</td></tr>
            <tr><td>初期化状態</td><td>${debugInfo.initialized ? '✅' : '❌'}</td></tr>
          </table>
          
          <h4>サービス状態</h4>
          <table class="debug-table">
            <tr><td>記事サービス</td><td>${debugInfo.articleService?.initialized ? '✅' : '❌'}</td></tr>
            <tr><td>レッスンサービス</td><td>${debugInfo.lessonService?.initialized ? '✅' : '❌'}</td></tr>
            <tr><td>UIマネージャー</td><td>${debugInfo.uiManager?.initialized ? '✅' : '❌'}</td></tr>
          </table>
          
          <h4>ブラウザ情報</h4>
          <table class="debug-table">
            <tr><td>言語</td><td>${debugInfo.browser.language}</td></tr>
            <tr><td>Cookie有効</td><td>${debugInfo.browser.cookieEnabled ? '✅' : '❌'}</td></tr>
            <tr><td>LocalStorage</td><td>${debugInfo.storage.localStorageAvailable ? '✅' : '❌'}</td></tr>
          </table>
          
          <style>
            .debug-table { width: 100%; margin-bottom: 1rem; border-collapse: collapse; }
            .debug-table td { padding: 0.5rem; border: 1px solid #ddd; }
            .debug-table td:first-child { font-weight: bold; background: #f5f5f5; }
          </style>
        </div>
      `;
      
      this.#createDebugModal('システムデバッグ情報', debugContent);
      
    } catch (error) {
      console.error('❌ デバッグ情報表示エラー:', error);
      this.#showFeedback('デバッグ情報の表示に失敗しました', 'error');
    }
  }

  /**
   * デバッグモーダルを作成
   * @private
   * @param {string} title - モーダルのタイトル
   * @param {string} content - モーダルの内容
   */
  #createDebugModal(title, content) {
    const modalHTML = `
      <div id="debug-modal" class="modal" style="display: flex;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>${title}</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove(); document.body.classList.remove('modal-open');">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
  }

  /**
   * 接続テスト結果の生成
   * @private
   * @param {Object} testResults - テスト結果
   * @returns {string}
   */
  #generateConnectionTestResults(testResults) {
    return Object.entries(testResults).map(([page, result]) => 
      `<div class="test-result ${result ? 'success' : 'error'}">
        ${page}: ${result ? '✅ 正常' : '❌ エラー'}
      </div>`
    ).join('');
  }

  /**
   * LP ニュースデバッグ
   */
  showNewsDebug() {
    try {
      console.log('🐛 LP ニュースデバッグ');
      
      // ArticleStorageServiceの状態確認
      const articles = this.articleDataService.getPublishedArticles({ limit: 10 });
      
      const debugData = {
        publishedArticles: articles.length,
        articles: articles.map(article => ({
          id: article.id,
          title: article.title,
          status: article.status,
          publishedAt: article.publishedAt,
          category: article.category
        }))
      };
      
      console.log('📰 LP表示用記事データ:', debugData);
      this.#showFeedback(`LP表示用記事: ${articles.length}件`);
      
    } catch (error) {
      console.error('❌ LP ニュースデバッグエラー:', error);
      this.#showFeedback('ニュースデバッグに失敗しました', 'error');
    }
  }

  // === モーダル管理メソッド ===

  /**
   * モーダルを閉じる
   */
  closeModal() {
    try {
      // 標準のモーダルを閉じる
      const modal = document.getElementById('modal');
      if (modal) {
        modal.classList.remove('modal-visible');
        modal.classList.add('modal-hidden');
        modal.classList.remove('active', 'show');
        
        // モーダル内容をクリア
        const modalBody = modal.querySelector('#modal-body, .modal-body');
        if (modalBody) {
          modalBody.innerHTML = '';
        }
        
        this.debug('標準モーダルを閉じました');
      }
      
      // 動的に作成されたモーダルを閉じる
      const dynamicModals = document.querySelectorAll('.modal[id*="preview-modal"], .modal[id*="lesson-preview-modal"]');
      dynamicModals.forEach(dynamicModal => {
        dynamicModal.remove();
        this.debug('動的モーダルを削除しました');
      });
      
      // bodyのmodal-openクラスを削除してスクロールを復旧
      document.body.classList.remove('modal-open');
      
      this.debug('モーダルを閉じてスクロールを復旧しました');
      
    } catch (error) {
      this.error('モーダル閉じる処理エラー:', error);
      
      // エラー時でもスクロールを復旧
      document.body.classList.remove('modal-open');
    }
  }

  /**
   * モバイルメニュートグル
   */
  toggleMobileMenu(element) {
    try {
      const isExpanded = element.getAttribute('aria-expanded') === 'true';
      const navLinks = document.querySelector('.nav-links');
      
      if (navLinks) {
        element.setAttribute('aria-expanded', (!isExpanded).toString());
        element.textContent = isExpanded ? '☰' : '✕';
        
        if (isExpanded) {
          navLinks.classList.remove('active');
          document.body.classList.remove('menu-open');
        } else {
          navLinks.classList.add('active');
          document.body.classList.add('menu-open');
        }
      }
    } catch (error) {
      this.error('モバイルメニュートグルエラー:', error);
    }
  }

  // === プライベートヘルパーメソッド ===

  /**
   * 日本語のステータス値を英語キーにマッピング
   * @private
   * @param {string} japaneseStatus - 日本語のステータス値
   * @returns {string} 英語のステータスキー
   */
  #mapJapaneseStatusToKey(japaneseStatus) {
    const statusMapping = {
      '通常開催': 'scheduled',
      '中止': 'cancelled',
      '室内開催': 'indoor',
      '延期': 'postponed'
    };
    return statusMapping[japaneseStatus] || 'scheduled';
  }

  /**
   * 英語のステータスキーを日本語の値にマッピング
   * @private
   * @param {string} statusKey - 英語のステータスキー
   * @returns {string} 日本語のステータス値
   */
  #mapStatusKeyToJapanese(statusKey) {
    const statusMapping = {
      'scheduled': '通常開催',
      'cancelled': '中止',
      'indoor': '室内開催',
      'postponed': '延期'
    };
    return statusMapping[statusKey] || '通常開催';
  }

  /**
   * フォームから記事データを取得
   * @private
   * @returns {Object}
   */
  #getArticleDataFromForm() {
    return {
      id: document.getElementById('news-id')?.value || '',
      title: document.getElementById('news-title')?.value || '',
      category: document.getElementById('news-category')?.value || 'announcement',
      date: document.getElementById('news-date')?.value || '',
      status: document.getElementById('news-status')?.value || 'draft',
      summary: document.getElementById('news-summary')?.value || '',
      content: document.getElementById('news-content')?.value || '',
      featured: document.getElementById('news-featured')?.checked || false
    };
  }

  /**
   * 記事データのバリデーション
   * @private
   * @param {Object} articleData - 記事データ
   * @returns {boolean}
   */
  #validateArticleData(articleData) {
    if (!articleData.title) {
      this.#showFeedback('タイトルを入力してください', 'error');
      return false;
    }
    
    if (!articleData.content) {
      this.#showFeedback('本文を入力してください', 'error');
      return false;
    }
    
    return true;
  }

  /**
   * 統合された記事一覧HTMLの生成
   * @private
   * @param {Array} articles - 記事配列
   * @param {Object} options - 表示オプション
   * @returns {string}
   */
  #generateArticleListHTML(articles, options = {}) {
    const {
      mode = 'list', // 'recent' | 'list'
      showActions = true,
      showStats = false,
      showMeta = true,
      limit = null,
      emptyMessage = '記事がありません',
      emptyAction = null
    } = options;

    if (articles.length === 0) {
      let emptyHTML = `
        <div class="empty-state">
          <i class="fas fa-newspaper"></i>
          <p>${emptyMessage}</p>
      `;
      
      if (emptyAction) {
        emptyHTML += `
          <button class="btn btn-sm btn-primary" data-action="${emptyAction.action}">
            <i class="fas ${emptyAction.icon}"></i> ${emptyAction.text}
          </button>
        `;
      }
      
      emptyHTML += '</div>';
      return emptyHTML;
    }

    const displayArticles = limit ? articles.slice(0, limit) : articles;
    
    return displayArticles.map((article, index) => {
      const createdDate = new Date(article.createdAt);
      const updatedDate = new Date(article.updatedAt || article.createdAt);
      const isRecent = (Date.now() - updatedDate.getTime()) < (24 * 60 * 60 * 1000); // 24時間以内
      const categoryName = this.#getCategoryName(article.category);
      const summary = article.summary ? 
        (article.summary.length > 80 ? article.summary.substring(0, 80) + '...' : article.summary) : 
        '概要なし';

      // スタイル調整用のクラス
      const containerClass = mode === 'recent' ? 'recent-article-item' : 'recent-article-item list-mode';
      const animationDelay = mode === 'recent' ? `style="animation-delay: ${index * 0.1}s"` : '';

      return `
        <div class="${containerClass}" data-id="${article.id}" ${animationDelay}>
          <div class="recent-article-content">
            <div class="recent-article-header">
              <div class="recent-article-main">
                <h3 class="recent-article-title" title="${this.escapeHtml(article.title)}">
                  ${this.escapeHtml(article.title)}
                  ${isRecent ? '<span class="new-badge">NEW</span>' : ''}
                </h3>
                <div class="recent-article-summary">${this.escapeHtml(summary)}</div>
              </div>
              ${mode === 'recent' && showActions ? `
                <div class="recent-article-actions">
                  <button class="action-btn-modern edit-btn" 
                          data-action="edit-article" 
                          data-article-id="${article.id}" 
                          title="記事を編集"
                          aria-label="記事「${this.escapeHtml(article.title)}」を編集">
                    <i class="fas fa-edit"></i>
                    <span class="action-text">編集</span>
                  </button>
                  <button class="action-btn-modern preview-btn" 
                          data-action="preview-article" 
                          data-article-id="${article.id}" 
                          title="記事をプレビュー"
                          aria-label="記事「${this.escapeHtml(article.title)}」をプレビュー">
                    <i class="fas fa-eye"></i>
                    <span class="action-text">プレビュー</span>
                  </button>
                </div>
              ` : ''}
            </div>
            ${showMeta ? `
              <div class="recent-article-meta">
                <span class="category-badge ${article.category}">${categoryName}</span>
                <span class="status-badge ${article.status}">${article.status === 'published' ? '公開中' : '下書き'}</span>
                <span class="date-info">${createdDate.toLocaleDateString('ja-JP')}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * ニュース一覧のレンダリング
   * @private
   * @param {string} filter - フィルター
   */
  #renderNewsList(filter = 'all') {
    try {
      if (!this.articleDataService?.initialized) {
        console.warn('ArticleDataServiceが初期化されていません');
        return;
      }

      const articles = this.articleDataService.loadArticles();
      const filteredArticles = this.#filterArticles(articles, filter);
      
      const listContainer = document.getElementById('news-list');
      if (listContainer) {
        // 統合されたメソッドを使用
        const html = this.#generateArticleListHTML(filteredArticles, {
          mode: 'list',
          showActions: true,
          showStats: true,
          showMeta: true,
          emptyMessage: '記事がありません',
          emptyAction: {
            action: 'new-news-article',
            icon: 'fa-plus',
            text: '新規記事を作成'
          }
        });
        
        listContainer.innerHTML = html;
        
        // ドロップダウンメニューの初期化
        this.#initializeDropdownMenus(listContainer);
      } else {
        console.warn('news-list要素が見つかりません');
      }
      
      console.log(`📋 記事一覧を表示: ${filteredArticles.length}件 (フィルター: ${filter})`);
      
    } catch (error) {
      console.error('❌ ニュース一覧レンダリングエラー:', error);
      
      // エラー時の安全なフォールバック
      const listContainer = document.getElementById('news-list');
      if (listContainer) {
        listContainer.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>記事一覧の読み込みに失敗しました</p>
            <button class="btn btn-sm btn-outline" data-action="refresh-news-list">
              <i class="fas fa-sync-alt"></i> 再試行
            </button>
          </div>
        `;
      }
    }
  }

  /**
   * 最近の記事のレンダリング
   * @private
   */
  async #renderRecentArticles() {
    try {
      // ArticleDataServiceの初期化状態を再確認
      if (!this.articleDataService?.initialized) {
        throw new Error('ArticleDataServiceが初期化されていません');
      }
      
      const articles = this.articleDataService.loadArticles();
      const recentArticles = articles
        .sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
        .slice(0, 10); // より多くの記事を取得（スクロール用）
      
      const recentContainer = document.getElementById('recent-articles');
      if (recentContainer) {
        // 統合されたメソッドを使用
        const html = this.#generateArticleListHTML(recentArticles, {
          mode: 'recent',
          showActions: true,
          showStats: true,
          showMeta: true,
          emptyMessage: '最近の記事がありません',
          emptyAction: {
            action: 'new-news-article',
            icon: 'fa-plus',
            text: '新規記事を作成'
          }
        });
        
        recentContainer.innerHTML = html;
        
        // ドロップダウンメニューの初期化
        this.#initializeDropdownMenus(recentContainer);
      }
      
      this.debug(`最近の記事を${recentArticles.length}件表示（最初の3件がメイン表示）`);
      
    } catch (error) {
      console.error('❌ 最近の記事レンダリングエラー:', error);
      throw error;
    }
  }

  /**
   * ドロップダウンメニューの初期化
   * @private
   */
  #initializeDropdownMenus(container) {
    const dropdowns = container.querySelectorAll('.dropdown');
    dropdowns.forEach(dropdown => {
      const toggle = dropdown.querySelector('.dropdown-toggle');
      const menu = dropdown.querySelector('.dropdown-menu');
      
      if (toggle && menu) {
        // ドロップダウントグルクリック
        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // 他のドロップダウンを閉じる
          dropdowns.forEach(otherDropdown => {
            if (otherDropdown !== dropdown) {
              otherDropdown.classList.remove('open');
            }
          });
          
          // 現在のドロップダウンをトグル
          dropdown.classList.toggle('open');
        });
        
        // ドキュメントクリックで閉じる
        document.addEventListener('click', () => {
          dropdown.classList.remove('open');
        });
        
        // メニュー項目クリック時に閉じる
        menu.addEventListener('click', () => {
          dropdown.classList.remove('open');
        });
      }
    });
  }

  /**
   * 記事フィルタリング
   * @private
   * @param {Array} articles - 記事配列
   * @param {string} filter - フィルター
   * @returns {Array}
   */
  #filterArticles(articles, filter) {
    switch (filter) {
      case 'published':
        return articles.filter(article => article.status === 'published');
      case 'draft':
        return articles.filter(article => article.status === 'draft');
      default:
        return articles;
    }
  }

  /**
   * ニュース一覧HTMLの生成
   * @private
   * @param {Array} articles - 記事配列
   * @returns {string}
   */
  #generateNewsListHTML(articles) {
    if (articles.length === 0) {
      return '<div class="empty-state">記事がありません</div>';
    }
    
    return articles.map(article => `
      <div class="news-item" data-id="${article.id}">
        <div class="news-item-header">
          <h3>${article.title}</h3>
          <span class="status-badge ${article.status}">${article.status === 'published' ? '公開' : '下書き'}</span>
        </div>
        <div class="news-item-meta">
          <span class="category">${this.#getCategoryName(article.category)}</span>
          <span class="date">${new Date(article.createdAt).toLocaleDateString('ja-JP')}</span>
        </div>
        <div class="news-item-actions">
          <button class="btn btn-sm btn-outline" data-action="edit-article" data-article-id="${article.id}">編集</button>
          <button class="btn btn-sm btn-danger" data-action="delete-article" data-article-id="${article.id}">削除</button>
        </div>
      </div>
    `).join('');
  }

  /**
   * 最近の記事HTMLの生成
   * @private
   * @param {Array} articles - 記事配列
   * @returns {string}
   */
  #generateRecentArticlesHTML(articles) {
    if (articles.length === 0) {
      return `
        <div class="empty-state">
          <i class="fas fa-newspaper"></i>
          <p>最近の記事がありません</p>
          <button class="btn btn-sm btn-primary" data-action="new-news-article">
            <i class="fas fa-plus"></i> 新規記事を作成
          </button>
        </div>
      `;
    }
    
    return articles.map((article, index) => {
      const createdDate = new Date(article.createdAt);
      const updatedDate = new Date(article.updatedAt || article.createdAt);
      const isRecent = (Date.now() - updatedDate.getTime()) < (24 * 60 * 60 * 1000); // 24時間以内
      const categoryName = this.#getCategoryName(article.category);
      const summary = article.summary ? 
        (article.summary.length > 80 ? article.summary.substring(0, 80) + '...' : article.summary) : 
        '概要なし';

      return `
        <div class="recent-article-item" data-id="${article.id}" style="animation-delay: ${index * 0.1}s">
          <div class="recent-article-header">
            <div class="recent-article-main">
              <h3 class="recent-article-title" title="${this.escapeHtml(article.title)}">
                ${this.escapeHtml(article.title)}
                ${isRecent ? '<span class="new-badge">NEW</span>' : ''}
              </h3>
              <div class="recent-article-summary">${this.escapeHtml(summary)}</div>
            </div>
            <div class="recent-article-actions">
              <button class="btn-icon" data-action="edit-article" data-article-id="${article.id}" title="編集">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon" data-action="preview-article" data-article-id="${article.id}" title="プレビュー">
                <i class="fas fa-eye"></i>
              </button>
              <div class="dropdown">
                <button class="btn-icon dropdown-toggle" title="その他">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu">
                  <button class="dropdown-item" data-action="duplicate-article" data-article-id="${article.id}">
                    <i class="fas fa-copy"></i> 複製
                  </button>
                  <button class="dropdown-item danger" data-action="delete-article" data-article-id="${article.id}">
                    <i class="fas fa-trash"></i> 削除
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="recent-article-meta">
            <div class="meta-item">
              <i class="fas fa-tag"></i>
              <span class="category-badge ${article.category}">${categoryName}</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-circle ${article.status === 'published' ? 'published' : 'draft'}"></i>
              <span class="status-text">${article.status === 'published' ? '公開中' : '下書き'}</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-clock"></i>
              <span class="date-text" title="更新: ${updatedDate.toLocaleString('ja-JP')}">
                ${this.#formatRelativeTime(updatedDate)}
              </span>
            </div>
            ${article.featured ? '<div class="meta-item"><i class="fas fa-star featured"></i><span>注目記事</span></div>' : ''}
          </div>
          
          <div class="recent-article-stats">
            <div class="stat-item">
              <i class="fas fa-calendar-plus"></i>
              <span>作成: ${createdDate.toLocaleDateString('ja-JP')}</span>
            </div>
            <div class="stat-item">
              <i class="fas fa-align-left"></i>
              <span>${this.#getWordCount(article)} 文字</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * カテゴリー名の取得
   * @private
   * @param {string} category - カテゴリーキー
   * @returns {string}
   */
  #getCategoryName(category) {
    const categoryNames = {
      'announcement': 'お知らせ',
      'event': '体験会',
      'media': 'メディア',
      'important': '重要'
    };
    return categoryNames[category] || category;
  }

  /**
   * 記事編集
   * @param {string} articleId - 記事ID
   */
  editArticle(articleId) {
    try {
      console.log('🖊️ 記事編集開始:', articleId);
      
      const article = this.articleDataService.getArticleById(articleId);
      if (!article) {
        this.#showFeedback('記事が見つかりません', 'error');
        return;
      }
      
      console.log('📄 編集対象記事:', article);
      
      // 記事管理タブに切り替え
      this.switchAdminTab('news-management');
      
      // エディタータブに切り替え（少し遅延させて確実にタブが切り替わるようにする）
      setTimeout(() => {
        this.switchNewsTab('editor');
        
        // さらに少し遅延させてフォームにデータを読み込み
        setTimeout(() => {
          this.#loadArticleToEditor(article, articleId);
        }, 100);
      }, 100);
      
    } catch (error) {
      console.error('❌ 記事編集エラー:', error);
      this.#showFeedback('記事の編集に失敗しました', 'error');
    }
  }

  /**
   * 記事データをエディターに読み込み
   * @private
   * @param {Object} article - 記事データ
   * @param {string} articleId - 記事ID
   */
  #loadArticleToEditor(article, articleId) {
    try {
      console.log('📝 記事データをエディターに読み込み中...');
      
      // フォーム要素を取得
      const elements = {
        id: document.getElementById('news-id'),
        title: document.getElementById('news-title'),
        category: document.getElementById('news-category'),
        date: document.getElementById('news-date'),
        status: document.getElementById('news-status'),
        summary: document.getElementById('news-summary'),
        content: document.getElementById('news-content'),
        featured: document.getElementById('news-featured')
      };
      
      // 各要素が存在するかチェック
      const missingElements = Object.keys(elements).filter(key => !elements[key]);
      if (missingElements.length > 0) {
        console.warn('⚠️ 一部のフォーム要素が見つかりません:', missingElements);
      }
      
      // フォームに記事データを設定
      if (elements.id) elements.id.value = article.id || '';
      if (elements.title) elements.title.value = article.title || '';
      if (elements.category) elements.category.value = article.category || 'announcement';
      if (elements.date) {
        const dateValue = article.date || article.createdAt || '';
        // 日付形式を正規化（YYYY-MM-DD形式にする）
        if (dateValue) {
          const date = new Date(dateValue);
          if (!isNaN(date.getTime())) {
            elements.date.value = date.toISOString().split('T')[0];
          }
        }
      }
      if (elements.status) elements.status.value = article.status || 'draft';
      if (elements.summary) elements.summary.value = article.summary || article.excerpt || '';
      if (elements.featured) elements.featured.checked = article.featured || false;
      
      // 記事本文を取得して設定
      if (elements.content) {
        const content = this.articleDataService.getArticleContent(articleId);
        elements.content.value = content || '';
        console.log('📄 記事本文を読み込み:', content ? `${content.length}文字` : '本文なし');
      }
      
      // エディタータイトルを更新
      const editorTitle = document.getElementById('editor-title');
      if (editorTitle) {
        editorTitle.textContent = `記事編集: ${article.title}`;
      }
      
      // タイトルフィールドにフォーカス
      if (elements.title) {
        elements.title.focus();
      }
      
      this.#showFeedback(`記事「${article.title}」をエディターに読み込みました`);
      console.log('✅ 記事データの読み込み完了');
      
    } catch (error) {
      console.error('❌ 記事データ読み込みエラー:', error);
      this.#showFeedback('記事データの読み込みに失敗しました', 'error');
    }
  }

  /**
   * 記事削除
   * @param {string} articleId - 記事ID
   */
  async deleteArticle(articleId) {
    try {
      if (!confirm('この記事を削除しますか？この操作は取り消せません。')) {
        return;
      }
      
      const result = await this.articleDataService.deleteArticle(articleId);
      
      if (result.success) {
        // 記事一覧とダッシュボードを更新
        this.refreshRecentArticles();
        this.refreshNewsList();
        this.updateDashboardStats();
        
        this.#showFeedback('記事を削除しました');
      } else {
        this.#showFeedback(result.message || '削除に失敗しました', 'error');
      }
      
    } catch (error) {
      console.error('❌ 記事削除エラー:', error);
      this.#showFeedback('記事の削除中にエラーが発生しました', 'error');
    }
  }

  /**
   * プレビューモーダルの表示
   * @private
   * @param {Object} articleData - 記事データ
   */
  #showNewsPreviewModal(articleData) {
    // 既存のモーダルがあれば削除
    const existingModal = document.getElementById('news-preview-modal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // カテゴリー名を取得
    const categoryNames = {
      'announcement': 'お知らせ',
      'event': '体験会',
      'media': 'メディア',
      'important': '重要'
    };
    
    const categoryName = categoryNames[articleData.category] || articleData.category;
    const formattedDate = articleData.date ? 
      new Date(articleData.date).toLocaleDateString('ja-JP') : 
      new Date().toLocaleDateString('ja-JP');
    
    // モーダルHTMLを作成
    const modalHTML = `
      <div id="news-preview-modal" class="modal">
        <div class="modal-content article-preview">
          <div class="modal-header">
            <h2><i class="fas fa-eye"></i> 記事プレビュー</h2>
            <button class="modal-close" onclick="this.closest('.modal').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="preview-article">
              <div class="article-header">
                <div class="article-meta">
                  <span class="article-date">${formattedDate}</span>
                  <span class="article-category ${articleData.category}">${categoryName}</span>
                </div>
                <h1 class="article-title">${this.escapeHtml(articleData.title)}</h1>
                ${articleData.summary ? `<div class="article-summary">${this.escapeHtml(articleData.summary)}</div>` : ''}
              </div>
              <div class="article-content">
                ${this.#convertMarkdownToHtml(articleData.content)}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline" onclick="this.closest('.modal').remove()">
              閉じる
            </button>
          </div>
        </div>
      </div>
    `;
    
    // モーダルをDOMに追加
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // モーダルを表示
    const modal = document.getElementById('news-preview-modal');
    modal.style.display = 'flex';
    
    // ESCキーでモーダルを閉じる
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', handleEscape);
      }
    };
    document.addEventListener('keydown', handleEscape);
    
    // モーダル背景クリックで閉じる
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
        document.removeEventListener('keydown', handleEscape);
      }
    });
  }

  /**
   * 簡易Markdown→HTML変換
   * @private
   * @param {string} markdown - Markdownテキスト
   * @returns {string} HTMLテキスト
   */
  #convertMarkdownToHtml(markdown) {
    return markdown
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
      .replace(/^- (.*)$/gim, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/^(.*)$/gim, '<p>$1</p>')
      .replace(/<p><\/p>/g, '')
      .replace(/<p>(<h[1-6]>.*<\/h[1-6]>)<\/p>/g, '$1')
      .replace(/<p>(<ul>.*<\/ul>)<\/p>/g, '$1');
  }

  /**
   * HTMLエスケープ
   * @private
   * @param {string} text - エスケープするテキスト
   * @returns {string}
   */
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /**
   * 記事管理のサブタブを切り替え
   * @param {string} tabName - タブ名 (editor|list)
   */
  switchNewsTab(tabName) {
    try {
      console.log(`🔄 記事管理サブタブ切り替え: ${tabName}`);
      
      // 現在のアクティブタブを非アクティブに
      const currentActiveNavItem = document.querySelector('.sub-nav-item.active');
      const currentActiveTabContent = document.querySelector('.news-tab-content.active');
      
      if (currentActiveNavItem) {
        currentActiveNavItem.classList.remove('active');
      }
      if (currentActiveTabContent) {
        currentActiveTabContent.classList.remove('active');
      }
      
      // 新しいタブをアクティブに
      const newActiveNavItem = document.querySelector(`[data-tab="${tabName}"]`);
      let newActiveTabContent;
      
      if (tabName === 'editor') {
        newActiveTabContent = document.getElementById('news-editor-tab');
      } else if (tabName === 'list') {
        newActiveTabContent = document.getElementById('news-list-tab');
        // 記事一覧タブに切り替えたときは記事一覧を更新
        this.refreshNewsList();
      }
      
      if (newActiveNavItem) {
        newActiveNavItem.classList.add('active');
      }
      if (newActiveTabContent) {
        newActiveTabContent.classList.add('active');
      }
      
      const tabDisplayName = tabName === 'editor' ? '記事作成' : '記事一覧';
      this.#showFeedback(`${tabDisplayName}タブに切り替えました`);
      
    } catch (error) {
      console.error('❌ 記事管理サブタブ切り替えエラー:', error);
      this.#showFeedback('タブの切り替えに失敗しました', 'error');
    }
  }

  /**
   * フォームからニュースフォームデータを取得
   * @private
   * @returns {Object}
   */
  #getNewsFormData() {
    return {
      title: document.getElementById('news-title')?.value || '',
      category: document.getElementById('news-category')?.value || 'announcement',
      date: document.getElementById('news-date')?.value || '',
      status: document.getElementById('news-status')?.value || 'draft',
      summary: document.getElementById('news-summary')?.value || '',
      content: document.getElementById('news-content')?.value || '',
      featured: document.getElementById('news-featured')?.checked || false
    };
  }

  /**
   * レッスン状況のプレビュー表示
   * @private
   * @param {Object} statusData - レッスン状況データ
   */

  /**

  /**
   * フォームからレッスン状況データを取得
   * @private
   * @returns {Object}
   */
  #getLessonStatusFromForm() {
    // 今日の日付をデフォルトとして取得
    const today = new Date().toISOString().slice(0, 10);
    
    // フォームからの生の値を取得
    const globalStatusRaw = document.querySelector('input[name="global-status"]:checked')?.value || '通常開催';
    const basicLessonRaw = document.querySelector('input[name="basic-lesson"]:checked')?.value || '通常開催';
    const advanceLessonRaw = document.querySelector('input[name="advance-lesson"]:checked')?.value || '通常開催';
    
    // 日本語の値を英語キーにマッピング
    const globalStatus = this.#mapJapaneseStatusToKey(globalStatusRaw);
    const basicLessonStatus = this.#mapJapaneseStatusToKey(basicLessonRaw);
    const advanceLessonStatus = this.#mapJapaneseStatusToKey(advanceLessonRaw);
    
    return {
      date: document.getElementById('lesson-date')?.value || today,
      globalStatus: globalStatus,
      globalMessage: document.getElementById('global-message')?.value || '',
      courses: {
        basic: {
          name: 'ベーシックコース（年長〜小3）',
          time: '17:00-17:50',
          status: basicLessonStatus,
          message: document.getElementById('basic-lesson-note')?.value || ''
        },
        advance: {
          name: 'アドバンスコース（小4〜小6）',
          time: '18:00-18:50',
          status: advanceLessonStatus,
          message: document.getElementById('advance-lesson-note')?.value || ''
        }
      }
    };
  }

  /**
   * レッスン状況をフォームに読み込み
   * @private
   * @param {Object} status - レッスン状況
   */
  #loadLessonStatusToForm(status) {
    try {
      if (status.date) {
        const dateField = document.getElementById('lesson-date');
        if (dateField) dateField.value = status.date;
      }
      
      if (status.globalMessage) {
        const messageField = document.getElementById('global-message');
        if (messageField) messageField.value = status.globalMessage;
      }
      
      // ラジオボタンの設定（英語キーから日本語値にマッピング）
      if (status.globalStatus) {
        const globalJapanese = this.#mapStatusKeyToJapanese(status.globalStatus);
        const globalRadio = document.querySelector(`input[name="global-status"][value="${globalJapanese}"]`);
        if (globalRadio) globalRadio.checked = true;
      }
      
      // コースデータの処理
      if (status.courses?.basic?.status) {
        const basicJapanese = this.#mapStatusKeyToJapanese(status.courses.basic.status);
        const basicRadio = document.querySelector(`input[name="basic-lesson"][value="${basicJapanese}"]`);
        if (basicRadio) basicRadio.checked = true;
      }
      
      if (status.courses?.basic?.message) {
        const basicMessageField = document.getElementById('basic-lesson-note');
        if (basicMessageField) basicMessageField.value = status.courses.basic.message;
      }
      
      if (status.courses?.advance?.status) {
        const advanceJapanese = this.#mapStatusKeyToJapanese(status.courses.advance.status);
        const advanceRadio = document.querySelector(`input[name="advance-lesson"][value="${advanceJapanese}"]`);
        if (advanceRadio) advanceRadio.checked = true;
      }
      
      if (status.courses?.advance?.message) {
        const advanceMessageField = document.getElementById('advance-lesson-note');
        if (advanceMessageField) advanceMessageField.value = status.courses.advance.message;
      }
    } catch (error) {
      console.error('❌ レッスン状況フォーム読み込みエラー:', error);
      this.#showFeedback('データの読み込み中にエラーが発生しました', 'error');
    }
  }

  /**
   * フィードバックメッセージを表示
   * @private
   */

  /**
   * ダッシュボード統計更新
   */
  updateDashboardStats() {
    try {
      console.log('📊 ダッシュボード統計更新開始');
      
      // CONFIG.jsで定義されたキーを使用して記事データを取得
      const articlesKey = CONFIG.storage.keys.articles;
      const articlesData = localStorage.getItem(articlesKey);
      
      let publishedCount = 0;
      let draftCount = 0;
      let currentMonthCount = 0;
      
      if (articlesData) {
        try {
          const articles = JSON.parse(articlesData);
          if (Array.isArray(articles)) {
            // 有効な記事のみフィルタリング（Instagram管理コンテンツを除外）
            const validArticles = articles.filter(article => 
              article && 
              article.id && 
              article.title &&
              !article.title.includes('Instagram') &&
              !article.title.includes('instagram')
            );
            
            // 公開記事数をカウント
            publishedCount = validArticles.filter(article => 
              article.status === 'published'
            ).length;
            
            // 下書き記事数をカウント
            draftCount = validArticles.filter(article => 
              article.status === 'draft'
            ).length;
            
            // 今月の記事数をカウント
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            currentMonthCount = validArticles.filter(article => {
              const articleDate = new Date(article.createdAt || article.date);
              return articleDate.getMonth() === currentMonth && 
                     articleDate.getFullYear() === currentYear;
            }).length;
            
            console.log(`📈 統計データ: 公開=${publishedCount}, 下書き=${draftCount}, 今月=${currentMonthCount}`);
          }
        } catch (parseError) {
          console.error('記事データの解析エラー:', parseError);
          // データが破損している場合はクリア
          localStorage.removeItem(articlesKey);
        }
      }
      
      // DOM要素に値を設定
      const publishedElement = document.getElementById('stat-published');
      const draftsElement = document.getElementById('stat-drafts');
      const currentMonthElement = document.getElementById('stat-current-month');
      
      if (publishedElement) {
        publishedElement.textContent = publishedCount;
        publishedElement.style.animation = 'none';
        publishedElement.offsetHeight; // reflow
        publishedElement.style.animation = 'countUp 0.5s ease-out';
      }
      
      if (draftsElement) {
        draftsElement.textContent = draftCount;
        draftsElement.style.animation = 'none';
        draftsElement.offsetHeight; // reflow
        draftsElement.style.animation = 'countUp 0.5s ease-out';
      }
      
      if (currentMonthElement) {
        currentMonthElement.textContent = currentMonthCount;
        currentMonthElement.style.animation = 'none';
        currentMonthElement.offsetHeight; // reflow
        currentMonthElement.style.animation = 'countUp 0.5s ease-out';
      }
      
      console.log('✅ ダッシュボード統計更新完了');
      
    } catch (error) {
      console.error('❌ ダッシュボード統計更新エラー:', error);
      
      // エラー時は0を表示
      ['stat-published', 'stat-drafts', 'stat-current-month'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = '0';
        }
      });
    }
  }

  /**
   * 統計要素の更新
   * @private
   * @param {string} elementId - 統計要素のID
   * @param {number} value - 更新する値
   */
  #updateStatsElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value;
    }
  }

  /**
   * 管理画面統計情報の更新
   * @private
   */
  updateAdminStats() {
    try {
      const articleStats = this.articleDataService.getStats();
      
      // レッスンステータスの取得 - 適切なメソッドを使用
      let lessonCount = 0;
      try {
        if (this.lessonStatusService && typeof this.lessonStatusService.getStatus === 'function') {
          const lessonStatus = this.lessonStatusService.getStatus();
          lessonCount = lessonStatus.statusCount || 0; // statusData.sizeの値を使用
        } else if (this.lessonStatusService && typeof this.lessonStatusService.getCurrentStatus === 'function') {
          const lessonStatus = this.lessonStatusService.getCurrentStatus();
          lessonCount = lessonStatus ? 1 : 0;
        }
      } catch (lessonError) {
        this.warn('レッスン統計取得エラー:', lessonError);
        lessonCount = 0;
      }
      
      // Instagram統計の取得
      let instagramCount = 0;
      try {
        if (this.instagramDataService && Array.isArray(this.instagramDataService.posts)) {
          instagramCount = this.instagramDataService.posts.length;
        }
      } catch (instagramError) {
        this.warn('Instagram統計取得エラー:', instagramError);
        instagramCount = 0;
      }
      
      // UIManagerServiceを使って統計を更新
      if (this.uiManagerService && typeof this.uiManagerService.updateStats === 'function') {
        this.uiManagerService.updateStats({
          articles: articleStats,
          lessons: { total: lessonCount },
          instagram: { total: instagramCount }
        });
      }
      
    } catch (error) {
      this.warn('統計情報更新エラー:', error);
    }
  }

  /**
   * タブナビゲーションの設定
   * @private
   */
  setupTabNavigation() {
    console.log('🧭 タブナビゲーション設定開始');
    
    try {
      // 保存されたタブ状態を復元（統一ストレージキーを使用）
      const savedTab = localStorage.getItem(this.storageKeys.adminTab);
      const defaultTab = 'dashboard';
      const activeTab = (savedTab && this.#isValidTabName(savedTab)) ? savedTab : defaultTab;
      
      console.log('🔍 タブ状態:', {
        saved: savedTab,
        default: defaultTab,
        active: activeTab,
        isValid: this.#isValidTabName(activeTab)
      });
      
      // DOM要素の存在確認
      const navItems = document.querySelectorAll('.nav-item[data-tab]');
      const sections = document.querySelectorAll('.admin-section');
      
      console.log('🔍 DOM要素数:', {
        navItems: navItems.length,
        sections: sections.length
      });
      
      if (navItems.length === 0) {
        console.warn('⚠️ ナビゲーションアイテムが見つかりません');
      }
      
      if (sections.length === 0) {
        console.warn('⚠️ 管理画面セクションが見つかりません');
      }
      
      // 初期タブを設定
      this.switchAdminTab(activeTab);
      console.log(`✅ 初期タブ設定完了: ${activeTab}`);
      
      // ページロード時の記事管理タブのクラス状態を確認・修正
      const adminMain = document.querySelector('.admin-main');
      if (adminMain) {
        if (activeTab === 'news-management') {
          adminMain.classList.add('news-management-active');
          console.log('📄 初期化: 記事管理タブのため全体スクロールモード有効');
        } else {
          adminMain.classList.remove('news-management-active');
          console.log('📱 初期化: 他のタブのため固定高さモード');
        }
      }
      
      // デバッグ情報
      if (CONFIG.debug?.enabled || window.DEBUG) {
        console.log('🔍 利用可能なタブ:', Array.from(navItems).map(item => item.dataset.tab));
        console.log('🔍 利用可能なセクション:', Array.from(sections).map(section => section.id));
      }
      
    } catch (error) {
      console.error('❌ タブナビゲーション設定エラー:', error);
      
      // フォールバック: デフォルトタブを強制設定
      try {
        console.log('🔄 フォールバック: デフォルトタブを設定');
        this.switchAdminTab('dashboard');
      } catch (fallbackError) {
        console.error('❌ フォールバック失敗:', fallbackError);
        this.#showFeedback('タブナビゲーションの初期化に失敗しました', 'error');
      }
    }
  }

  // === ログメソッド ===

  /**
   * ログ出力（新通知システム統合版）
   * @private
   */
  log(...args) {
    const message = args.join(' ');
    
    // 新通知システムにログ記録
    if (window.adminLog) {
      window.adminLog(message, 'info', 'admin-action');
    } else {
      // フォールバック: コンソール出力
      console.log('🔧 AdminActionService:', ...args);
    }
  }

  /**
   * デバッグログ出力（新通知システム統合版）
   * @private
   */
  debug(...args) {
    const message = args.join(' ');
    
    // 新通知システムにデバッグログ記録
    if (window.adminLog) {
      window.adminLog(message, 'debug', 'admin-action');
    } else if (CONFIG.debug?.enabled || window.DEBUG) {
      console.debug('🔍 AdminActionService:', ...args);
    }
  }

  /**
   * 警告ログ出力（新通知システム統合版）
   * @private
   */
  warn(...args) {
    const message = args.join(' ');
    
    // 新通知システムに警告ログ記録
    if (window.adminLog) {
      window.adminLog(message, 'warning', 'admin-action');
    } else {
      console.warn('⚠️ AdminActionService:', ...args);
    }
    
    // 重要な警告は通知も表示
    if (window.adminNotify && message.includes('エラー') || message.includes('失敗')) {
      window.adminNotify({
        type: 'warning',
        title: '警告',
        message: message,
        duration: 5000
      });
    }
  }

  /**
   * エラーログ出力（新通知システム統合版）
   * @private
   */
  error(...args) {
    const message = args.join(' ');
    
    // 新通知システムにエラーログ記録
    if (window.adminLog) {
      window.adminLog(message, 'error', 'admin-action');
    } else {
      console.error('❌ AdminActionService:', ...args);
    }
    
    // エラー通知を表示
    if (window.adminNotify) {
      window.adminNotify({
        type: 'error',
        title: 'エラー',
        message: message,
        duration: 7000
      });
    }
  }

  /**
   * 成功メッセージの表示（新通知システム統合版）
   * @private
   */
  success(...args) {
    const message = args.join(' ');
    
    // 新通知システムにログ記録
    if (window.adminLog) {
      window.adminLog(message, 'info', 'admin-action');
    } else if (CONFIG.debug?.enabled || window.DEBUG) {
      console.log('✅ AdminActionService:', ...args);
    }
    
    // 成功通知を表示
    if (window.adminNotify) {
      window.adminNotify({
        type: 'success',
        title: '成功',
        message: message,
        duration: 4000
      });
    }
  }

  /**
   * 情報メッセージの表示（新通知システム統合版）
   * @private
   */
  info(...args) {
    const message = args.join(' ');
    
    // 新通知システムにログ記録
    if (window.adminLog) {
      window.adminLog(message, 'info', 'admin-action');
    } else if (CONFIG.debug?.enabled || window.DEBUG) {
      console.log('ℹ️ AdminActionService:', ...args);
    }
    
    // 情報通知を表示（控えめに）
    if (window.adminToast) {
      window.adminToast(message, 'info');
    }
  }

  /**
   * 新規記事作成を開始
   */
  startNewArticle() {
    try {
      // フォームをクリア
      this.clearNewsEditor();
      
      // 記事管理タブに切り替え
      this.switchAdminTab('news-management');
      
      // タイトルフィールドにフォーカス
      const titleField = document.getElementById('news-title');
      if (titleField) {
        titleField.focus();
      }
      
      this.#showFeedback('新規記事作成を開始しました');
      console.log('📝 新規記事作成開始');
      
    } catch (error) {
      console.error('❌ 新規記事作成開始エラー:', error);
      this.#showFeedback('新規記事作成の開始に失敗しました', 'error');
    }
  }

  /**
   * 記事作成ガイドを表示
   * @private
   */
  #showWritingGuide() {
    const guideContent = `
      <div class="writing-guide">
        <h3><i class="fas fa-lightbulb"></i> 記事執筆ガイド</h3>
        
        <div class="guide-section">
          <h4>📝 基本的な書き方</h4>
          <ul>
            <li>タイトルは分かりやすく簡潔に</li>
            <li>見出しを使って構造化する</li>
            <li>短い段落で読みやすく</li>
          </ul>
        </div>

        <div class="guide-section">
          <h4>🎨 マークダウン記法</h4>
          <div class="markdown-examples">
            <code># 大見出し</code>
            <code>## 中見出し</code>
            <code>**太字**</code>
            <code>*斜体*</code>
            <code>[リンク](URL)</code>
            <code>\`コード\`</code>
          </div>
        </div>

        <div class="guide-section">
          <h4>✅ チェックポイント</h4>
          <ul>
            <li>誤字脱字がないか確認</li>
            <li>プレビューで見た目を確認</li>
            <li>読者の立場で分かりやすいか</li>
          </ul>
        </div>
      </div>
    `;
    
    this.#createModal('記事執筆ガイド', guideContent);
  }

  /**
   * ニュースフォームデータを取得
   * @private
   */
  #getNewsFormData() {
    return {
      title: document.getElementById('news-title')?.value?.trim() || '',
      content: document.getElementById('news-content')?.value?.trim() || '',
      category: document.getElementById('news-category')?.value || 'announcement',
      priority: document.getElementById('news-priority')?.value || 'normal'
    };
  }

  /**
   * ニュースプレビューモーダルを表示
   * @private
   */
  #showNewsPreviewModal(formData) {
    const previewContent = `
      <div class="news-preview">
        <div class="news-preview-header">
          <div class="news-meta">
            <span class="news-category">${this.#getCategoryName(formData.category)}</span>
            <span class="news-date">${new Date().toLocaleDateString('ja-JP')}</span>
          </div>
          <h1 class="news-title">${formData.title}</h1>
        </div>
        <div class="news-preview-content">
          ${this.#formatMarkdown(formData.content)}
        </div>
      </div>
    `;
    
    this.#createModal('記事プレビュー', previewContent, 'large');
  }

  /**
   * フォームから記事データを取得
   * @private
   */
  #getArticleDataFromForm() {
    const formData = this.#getNewsFormData();
    return {
      id: `article_${Date.now()}`,
      title: formData.title,
      content: formData.content,
      category: formData.category,
      priority: formData.priority,
      author: 'admin',
      date: new Date().toISOString(),
      status: 'draft'
    };
  }

  /**
   * 記事データの検証
   * @private
   */
  #validateArticleData(articleData) {
    if (!articleData.title || articleData.title.length < 3) {
      this.#showFeedback('タイトルは3文字以上で入力してください', 'error');
      return false;
    }
    
    if (!articleData.content || articleData.content.length < 10) {
      this.#showFeedback('本文は10文字以上で入力してください', 'error');
      return false;
    }
    
    if (articleData.title.length > 100) {
      this.#showFeedback('タイトルは100文字以内で入力してください', 'error');
      return false;
    }
    
    return true;
  }

  /**
   * ニュース一覧をレンダリング
   * @private
   */
  #renderNewsList(filterValue = '') {
    const container = document.getElementById('news-list');
    if (!container) {
      console.warn('ニュース一覧コンテナが見つかりません');
      return;
    }
    
    const articles = this.articleDataService?.getAllArticles() || [];
    const filteredArticles = filterValue 
      ? articles.filter(article => 
          article.title.toLowerCase().includes(filterValue.toLowerCase()) ||
          article.content.toLowerCase().includes(filterValue.toLowerCase())
        )
      : articles;
    
    if (filteredArticles.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-newspaper"></i>
          <h3>記事がありません</h3>
          <p>新しい記事を作成してください</p>
        </div>
      `;
      return;
    }
    
    const html = filteredArticles.map(article => `
      <div class="news-item" data-article-id="${article.id}">
        <div class="news-item-header">
          <h4>${article.title}</h4>
          <span class="news-category">${this.#getCategoryName(article.category)}</span>
        </div>
        <div class="news-item-meta">
          <span class="news-date">${new Date(article.date).toLocaleDateString('ja-JP')}</span>
          <span class="news-status ${article.status}">${article.status === 'published' ? '公開済み' : '下書き'}</span>
        </div>
        <div class="news-item-actions">
          <button class="btn-sm" data-action="edit-article" data-article-id="${article.id}">編集</button>
          <button class="btn-sm secondary" data-action="preview-article" data-article-id="${article.id}">プレビュー</button>
          <button class="btn-sm danger" data-action="delete-article" data-article-id="${article.id}">削除</button>
        </div>
      </div>
    `).join('');
    
    container.innerHTML = html;
  }

  /**
   * カテゴリ名を取得
   * @private
   */
  #getCategoryName(category) {
    const categories = {
      announcement: 'お知らせ',
      lesson: 'レッスン情報',
      event: 'イベント',
      general: '一般'
    };
    return categories[category] || 'その他';
  }

  /**
   * 接続テスト結果HTML生成
   * @private
   */
  #generateConnectionTestResults(results) {
    return results.map(result => `
      <div class="connection-test-item ${result.success ? 'success' : 'error'}">
        <div class="test-icon">
          <i class="fas fa-${result.success ? 'check-circle' : 'times-circle'}"></i>
        </div>
        <div class="test-details">
          <h4>${result.name}</h4>
          <p class="test-url">${result.url}</p>
          <p class="test-status">${result.message}</p>
        </div>
      </div>
    `).join('');
  }

  /**
   * デバッグモーダルを作成
   * @private
   */
  #createDebugModal(title, content) {
    this.#createModal(title, content, 'large debug-modal');
  }

  /**
   * 汎用モーダル作成
   * @private
   */
  #createModal(title, content, className = '') {
    const modalId = `modal-${Date.now()}`;
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = `modal ${className}`;
    modal.innerHTML = `
      <div class="modal-overlay" onclick="this.closest('.modal').remove()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>${title}</h3>
          <button class="modal-close" onclick="this.closest('.modal').remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          ${content}
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // ESCキーでモーダルを閉じる
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', handleEscape);
      }
    };
    document.addEventListener('keydown', handleEscape);
  }

  /**
   * 統計情報を更新
   * @private
   */
  #updateStats() {
    try {
      const articles = this.articleDataService?.getAllArticles() || [];
      const publishedCount = articles.filter(a => a.status === 'published').length;
      const draftCount = articles.filter(a => a.status === 'draft').length;
      
      // 統計表示を更新
      const statsElements = {
        totalArticles: document.querySelector('.stat-total-articles'),
        publishedArticles: document.querySelector('.stat-published-articles'),
        draftArticles: document.querySelector('.stat-draft-articles')
      };
      
      if (statsElements.totalArticles) {
        statsElements.totalArticles.textContent = articles.length;
      }
      if (statsElements.publishedArticles) {
        statsElements.publishedArticles.textContent = publishedCount;
      }
      if (statsElements.draftArticles) {
        statsElements.draftArticles.textContent = draftCount;
      }
      
    } catch (error) {
      console.error('統計情報更新エラー:', error);
    }
  }

  /**
   * マークダウンフォーマット
   * @private
   */
  #formatMarkdown(text) {
    if (!text) return '';
    
    return text
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code>$1</code>')
      .replace(/^### (.*$)/gm, '<h3>$1</h3>')
      .replace(/^## (.*$)/gm, '<h2>$1</h2>')
      .replace(/^# (.*$)/gm, '<h1>$1</h1>');
  }

  // === Instagram 関連のプライベートメソッド ===

  /**
   * Instagram投稿データを取得
   * @private
   */
  #getInstagramPosts() {
    try {
      const stored = localStorage.getItem(this.storageKeys.instagram);
      return stored ? JSON.parse(stored) : [];
    } catch (error) {
      console.error('Instagram投稿データ取得エラー:', error);
      return [];
    }
  }

  /**
   * Instagram投稿データを保存
   * @private
   */
  #saveInstagramPosts(posts) {
    try {
      localStorage.setItem(this.storageKeys.instagram, JSON.stringify(posts));
      return true;
    } catch (error) {
      console.error('Instagram投稿データ保存エラー:', error);
      return false;
    }
  }

  /**
   * デバッグ用：タブナビゲーション状態を確認
   * @public
   */
  debugTabNavigation() {
    console.group('🐛 タブナビゲーション デバッグ情報');
    
    // ActionManagerの状態
    console.log('ActionManager:', {
      initialized: this.actionManager?.initialized,
      actionsCount: this.actionManager?._actions?.size || 0,
      hasSwitchTab: this.actionManager?._actions?.has('switch-tab') || false
    });
    
    // DOM要素の状態
    const navItems = document.querySelectorAll('.nav-item[data-tab]');
    const sections = document.querySelectorAll('.admin-section');
    const activeNavItem = document.querySelector('.nav-item.active');
    const activeSection = document.querySelector('.admin-section.active');
    
    console.log('DOM要素:', {
      navItems: navItems.length,
      sections: sections.length,
      activeNavItem: activeNavItem?.dataset?.tab,
      activeSection: activeSection?.id
    });
    
    // 利用可能なタブ
    const availableNavTabs = Array.from(navItems).map(item => ({
      tab: item.dataset.tab,
      active: item.classList.contains('active'),
      hasAction: item.hasAttribute('data-action')
    }));
    
    const availableSections = Array.from(sections).map(section => ({
      id: section.id,
      active: section.classList.contains('active')
    }));
    
    console.log('利用可能なナビタブ:', availableNavTabs);
    console.log('利用可能なセクション:', availableSections);
    
    // LocalStorage状態
    console.log('LocalStorage:', {
      adminTab: localStorage.getItem(this.storageKeys.adminTab),
      allRbsKeys: Object.keys(localStorage).filter(key => key.startsWith('rbs_'))
    });
    
    // サービス状態
    console.log('サービス状態:', {
      initialized: this.initialized,
      currentTab: this.currentTab,
      uiManagerService: !!this.uiManagerService,
      authService: !!this.authService
    });
    
    console.groupEnd();
  }

  /**
   * デバッグ用：タブを強制切り替え
   * @public
   * @param {string} tabName - タブ名
   */
  async forceTabSwitch(tabName) {
    console.log(`🔧 タブ強制切り替え: ${tabName}`);
    
    if (!this.#isValidTabName(tabName)) {
      console.error(`❌ 無効なタブ名: ${tabName}`);
      return;
    }
    
    try {
      // LocalStorageを即座に更新
      localStorage.setItem(this.storageKeys.adminTab, tabName);
      
      // 全ての.admin-sectionからactiveクラスを削除
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 全ての.nav-itemからactiveクラスを削除
      document.querySelectorAll('.nav-item').forEach(navItem => {
        navItem.classList.remove('active');
      });
      
      // 指定されたタブをアクティブにする
      const targetSection = document.getElementById(tabName);
      const targetNav = document.querySelector(`[data-tab="${tabName}"]`);
      
      if (targetSection) {
        targetSection.classList.add('active');
        console.log(`✅ セクション "${tabName}" をアクティブに設定`);
      } else {
        console.error(`❌ セクション "${tabName}" が見つかりません`);
      }
      
      if (targetNav) {
        targetNav.classList.add('active');
        console.log(`✅ ナビゲーション "${tabName}" をアクティブに設定`);
      } else {
        console.error(`❌ ナビゲーション "${tabName}" が見つかりません`);
      }
      
      // タブ固有の初期化処理
      await this.initializeTabContent(tabName);
      this.currentTab = tabName;
      
      console.log(`✅ タブ強制切り替え完了: ${tabName}`);
      
    } catch (error) {
      console.error(`❌ タブ強制切り替えエラー:`, error);
      // フォールバックとして通常の切り替えを試す
      this.switchAdminTab(tabName);
    }
  }
  
  /**
   * デバッグ用：アクション手動実行
   * @public
   * @param {string} actionName - アクション名
   * @param {Object} params - パラメータ
   */
  executeAction(actionName, params = {}) {
    console.log(`🎯 アクション手動実行: ${actionName}`, params);
    
    if (!this.actionManager || !this.actionManager._actions) {
      console.error('❌ ActionManagerが利用できません');
      return;
    }
    
    const action = this.actionManager._actions.get(actionName);
    if (!action) {
      console.error(`❌ アクション "${actionName}" が見つかりません`);
      return;
    }
    
    try {
      action(null, params);
      console.log(`✅ アクション "${actionName}" 実行完了`);
    } catch (error) {
      console.error(`❌ アクション "${actionName}" 実行エラー:`, error);
    }
  }

  /**
   * デバッグ用：Local Storage統合状況確認
   * @public
   */
  debugStorageIntegration() {
    console.group('🔍 Local Storage統合状況確認');
    
    console.log('📋 CONFIG.storage.keys設定:');
    Object.entries(CONFIG.storage.keys).forEach(([key, value]) => {
      console.log(`  ${key}: ${value}`);
    });
    
    console.log('\n🗄️ 実際のLocal Storage使用状況:');
    
    // AdminActionServiceのキー
    console.log('AdminActionService:');
    Object.entries(this.storageKeys).forEach(([key, value]) => {
      const hasData = !!localStorage.getItem(value);
      console.log(`  ${key}: ${value} ${hasData ? '✅ データあり' : '❌ データなし'}`);
    });
    
    // 全LocalStorageのRBS関連キーを表示
    console.log('\n📦 全RBS関連Local Storageキー:');
    const allKeys = Object.keys(localStorage);
    const rbsKeys = allKeys.filter(key => key.startsWith('rbs_') || key.includes('article') || key.includes('auth'));
    
    rbsKeys.forEach(key => {
      const value = localStorage.getItem(key);
      const size = value ? value.length : 0;
      const type = (() => {
        try {
          const parsed = JSON.parse(value);
          if (Array.isArray(parsed)) return `Array(${parsed.length})`;
          if (typeof parsed === 'object') return 'Object';
          return typeof parsed;
        } catch {
          return 'String';
        }
      })();
      
      console.log(`  ${key}: ${size}bytes (${type})`);
    });
    
    // 統合前後の比較
    console.log('\n🔄 統合状況サマリー:');
    const expectedKeys = Object.values(CONFIG.storage.keys);
    const actualKeys = allKeys.filter(key => key.startsWith('rbs_'));
    const unmatchedKeys = actualKeys.filter(key => !expectedKeys.includes(key));
    
    console.log(`  CONFIGで定義済みキー数: ${expectedKeys.length}`);
    console.log(`  実際のRBSキー数: ${actualKeys.length}`);
    console.log(`  未統合キー数: ${unmatchedKeys.length}`);
    
    if (unmatchedKeys.length > 0) {
      console.warn('  未統合キー:', unmatchedKeys);
    } else {
      console.log('  ✅ 全キーが統合されています');
    }
    
    console.groupEnd();
    
    return {
      configKeys: CONFIG.storage.keys,
      serviceKeys: this.storageKeys,
      actualKeys: rbsKeys,
      unmatchedKeys,
      isFullyIntegrated: unmatchedKeys.length === 0
    };
  }

  /**
   * デバッグ用：LP側との互換性確認
   * @public
   */
  debugLPCompatibility() {
    console.group('🌐 LP側との互換性確認');
    
    // 記事データの確認
    const articlesKey = CONFIG.storage.keys.articles;
    const articlesData = localStorage.getItem(articlesKey);
    
    console.log('📰 記事データ互換性:');
    console.log(`  キー: ${articlesKey}`);
    
    if (articlesData) {
      try {
        const articles = JSON.parse(articlesData);
        console.log(`  データ型: ${Array.isArray(articles) ? 'Array' : typeof articles}`);
        console.log(`  記事数: ${Array.isArray(articles) ? articles.length : 'N/A'}`);
        
        if (Array.isArray(articles) && articles.length > 0) {
          const sampleArticle = articles[0];
          console.log('  サンプル記事構造:', {
            id: !!sampleArticle.id,
            title: !!sampleArticle.title,
            status: sampleArticle.status,
            category: sampleArticle.category,
            createdAt: !!sampleArticle.createdAt
          });
        }
        
        console.log('  ✅ LP側で読み込み可能');
      } catch (error) {
        console.error('  ❌ JSON解析エラー:', error);
      }
    } else {
      console.log('  ⚠️ 記事データなし');
    }
    
    // レッスン状況データの確認
    const lessonKey = CONFIG.storage.keys.lessonStatus;
    const lessonData = localStorage.getItem(lessonKey);
    
    console.log('\n📅 レッスン状況データ互換性:');
    console.log(`  キー: ${lessonKey}`);
    
    if (lessonData) {
      try {
        const lessons = JSON.parse(lessonData);
        console.log(`  データ型: ${typeof lessons}`);
        console.log(`  今日のデータ: ${!!lessons[new Date().toISOString().split('T')[0]]}`);
        console.log('  ✅ LP側で読み込み可能');
      } catch (error) {
        console.error('  ❌ JSON解析エラー:', error);
      }
    } else {
      console.log('  ⚠️ レッスンデータなし');
    }
    
    // 設定データの確認
    const settingsKey = CONFIG.storage.keys.settings;
    const settingsData = localStorage.getItem(settingsKey);
    
    console.log('\n⚙️ 設定データ互換性:');
    console.log(`  キー: ${settingsKey}`);
    console.log(`  データ: ${settingsData ? '✅ あり' : '⚠️ なし'}`);
    
    console.groupEnd();
    
    return {
      articles: !!articlesData,
      lessons: !!lessonData,
      settings: !!settingsData,
      compatible: !!articlesData && !!lessonData
    };
  }

  // =============================================================================
  // ウィザード制御メソッド
  // =============================================================================

  /**
   * 前のステップに戻る
   */
  wizardPrevStep() {
    const currentStep = document.querySelector('.wizard-content.active');
    const prevStep = currentStep?.previousElementSibling;
    
    if (!prevStep || !prevStep.classList.contains('wizard-content')) {
      console.log('前のステップがありません');
      return;
    }
    
    // ステップ切り替え
    this.switchWizardStep(prevStep);
    this.updateWizardButtons();
  }

  /**
   * 次のステップに進む
   */
  wizardNextStep() {
    const currentStep = document.querySelector('.wizard-content.active');
    const nextStep = currentStep?.nextElementSibling;
    
    if (!nextStep || !nextStep.classList.contains('wizard-content')) {
      console.log('次のステップがありません');
      return;
    }
    
    // 現在のステップのバリデーション
    if (!this.validateCurrentWizardStep()) {
      return;
    }
    
    // ステップ切り替え
    this.#switchWizardStep(nextStep);
    this.#updateWizardButtons();
  }

  /**
   * ウィザードステップ切り替え
   * @param {Element} targetStep - 切り替え先のステップ
   */
  #switchWizardStep(targetStep) {
    // 全てのステップを非アクティブに
    document.querySelectorAll('.wizard-content').forEach(step => {
      step.classList.remove('active');
    });
    
    document.querySelectorAll('.step').forEach(step => {
      step.classList.remove('active');
    });
    
    // 対象ステップをアクティブに
    targetStep.classList.add('active');
    
    // ステップインジケーターを更新
    const stepNumber = targetStep.classList.contains('step-1') ? 1 : 2;
    const stepIndicator = document.querySelector(`[data-step="${stepNumber}"]`);
    if (stepIndicator) {
      stepIndicator.classList.add('active');
    }
    
    console.log(`ウィザードステップ ${stepNumber} に切り替えました`);
  }

  /**
   * ウィザードボタンの状態更新
   */
  #updateWizardButtons() {
    const currentStep = document.querySelector('.wizard-content.active');
    const prevBtn = document.querySelector('.wizard-prev');
    const nextBtn = document.querySelector('.wizard-next');
    
    if (!currentStep || !prevBtn || !nextBtn) return;
    
    // 前へボタンの状態
    if (currentStep.classList.contains('step-1')) {
      prevBtn.disabled = true;
      prevBtn.style.opacity = '0.6';
    } else {
      prevBtn.disabled = false;
      prevBtn.style.opacity = '1';
    }
    
    // 次へボタンの状態
    if (currentStep.classList.contains('step-2')) {
      nextBtn.style.display = 'none';
    } else {
      nextBtn.style.display = 'flex';
    }
  }

  /**
   * 現在のウィザードステップのバリデーション
   * @returns {boolean}
   */
  validateCurrentWizardStep() {
    const currentStep = document.querySelector('.wizard-content.active');
    
    if (currentStep?.classList.contains('step-1')) {
      // ステップ1: グローバルステータスの選択確認
      const selectedStatus = document.querySelector('input[name="global-status"]:checked');
      if (!selectedStatus) {
        this.#showFeedback('全体ステータスを選択してください', 'error');
        return false;
      }
      
      // 日付の確認
      const dateInput = document.getElementById('lesson-date');
      if (!dateInput?.value) {
        this.#showFeedback('対象日を選択してください', 'error');
        return false;
      }
      
      return true;
    }
    
    return true;
  }

  /**
   * フィードバックメッセージを表示
   * @param {string} message - メッセージ
   * @param {string} type - メッセージタイプ
   */
  showFeedbackMessage(message, type = 'success') {
    console.log(`${type === 'error' ? '❌' : '✅'} ${message}`);
    
    if (this.uiManagerService?.showNotification) {
      this.uiManagerService.showNotification(type, message);
    } else if (typeof window.showFeedback === 'function') {
      window.showFeedback(message, type);
    }
  }

  // === Instagram管理機能 ===

  /**
   * Instagram管理: タブ切り替え
   * @param {string} tabName - 切り替え先のタブ名 ('posts' または 'settings')
   */
  switchInstagramTab(tabName = null) {
    console.log('🔄 Instagram タブ切り替え開始:', tabName);
    
    try {
      // パラメータの検証
      const targetTab = tabName || 'posts';
      const validTabs = ['posts', 'settings'];
      if (!validTabs.includes(targetTab)) {
        console.warn('⚠️ 無効なタブ名:', targetTab);
        return;
      }
      
      console.log('✅ タブ切り替え対象:', targetTab);
      
      // タブボタンの状態更新
      const tabButtons = document.querySelectorAll('.sub-nav-item[data-action="switch-instagram-tab"]');
      console.log('📋 タブボタン検索結果:', tabButtons.length, '個');
      
      if (tabButtons.length === 0) {
        console.warn('⚠️ タブボタンが見つかりません');
        return;
      }
      
      let targetButtonFound = false;
      tabButtons.forEach((btn, index) => {
        const isTarget = btn.dataset.tab === targetTab;
        btn.classList.toggle('active', isTarget);
        
        if (isTarget) {
          targetButtonFound = true;
          console.log(`🎯 ターゲットボタン発見 (インデックス: ${index}):`, btn.dataset.tab);
        }
        
        console.log(`📝 ボタン${index + 1}(${btn.dataset.tab}): ${isTarget ? 'アクティブ' : '非アクティブ'}`);
      });
      
      if (!targetButtonFound) {
        console.warn('⚠️ ターゲットボタンが見つかりませんでした:', targetTab);
      }
      
      // タブコンテンツの表示切り替え
      const tabContents = document.querySelectorAll('.instagram-tab-content');
      console.log('📄 タブコンテンツ検索結果:', tabContents.length, '個');
      
      if (tabContents.length === 0) {
        console.warn('⚠️ タブコンテンツが見つかりません');
        return;
      }
      
      let targetContentFound = false;
      tabContents.forEach((content, index) => {
        const expectedId = `instagram-${targetTab}-tab`;
        const isTarget = content.id === expectedId;
        
        // クラスの更新
        content.classList.toggle('active', isTarget);
        
        // 表示状態の直接制御も追加
        content.style.display = isTarget ? 'flex' : 'none';
        
        if (isTarget) {
          targetContentFound = true;
          console.log(`🎯 ターゲットコンテンツ発見 (インデックス: ${index}):`, content.id);
        }
        
        console.log(`📄 コンテンツ${index + 1}(${content.id}): ${isTarget ? '表示' : '非表示'}`);
      });
      
      if (!targetContentFound) {
        console.warn('⚠️ ターゲットコンテンツが見つかりませんでした:', `instagram-${targetTab}-tab`);
      }
      
      // タブ固有の初期化
      if (targetTab === 'posts') {
        console.log('📸 投稿管理タブの初期化');
        this.refreshInstagramPosts();
      } else if (targetTab === 'settings') {
        console.log('⚙️ 連携設定タブの初期化');
        this.#loadInstagramSettings();
      }
      
      const tabDisplayName = targetTab === 'posts' ? '投稿管理' : '連携設定';
      this.success(`${tabDisplayName}タブに切り替えました`);
      
      console.log('✅ Instagram タブ切り替え完了:', targetTab);
      
    } catch (error) {
      console.error('❌ Instagram タブ切り替えエラー:', error);
      this.error('タブの切り替えに失敗しました');
    }
  }

  /**
   * Instagram管理: 投稿一覧更新
   */
  refreshInstagramPosts() {
    console.log('🔄 Instagram投稿一覧を更新中...');
    
    try {
      const container = document.getElementById('instagram-posts-list');
      if (!container) {
        console.warn('⚠️ Instagram投稿リストコンテナが見つかりません');
        return;
      }
      
      // ローディング状態表示
      container.innerHTML = `
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          Instagram投稿を読み込み中...
        </div>
      `;
      
      // LocalStorageからInstagram投稿データを取得
      const instagramPosts = this.#getInstagramPosts();
      
      // 投稿グリッドの生成
      const postsHTML = this.#generateInstagramPostsHTML(instagramPosts);
      
      // 少し遅延してローディング感を演出
      setTimeout(() => {
        container.innerHTML = postsHTML;
        this.success(`${instagramPosts.length}件のInstagram投稿を読み込みました`);
      }, 500);
      
    } catch (error) {
      console.error('❌ Instagram投稿読み込みエラー:', error);
      const container = document.getElementById('instagram-posts-list');
      if (container) {
        container.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Instagram投稿の読み込みに失敗しました</p>
          </div>
        `;
      }
      this.error('Instagram投稿の読み込みに失敗しました');
    }
  }

  /**
   * Instagram管理: 新規投稿追加
   */
  addInstagramPost() {
    console.log('➕ Instagram投稿追加モーダルを開く');
    
    try {
      // フォームをリセット
      const form = document.querySelector('.instagram-form');
      if (form) {
        form.reset();
        document.getElementById('instagram-post-id').value = '';
        document.getElementById('instagram-modal-title').innerHTML = 
          '<i class="fab fa-instagram"></i> Instagram投稿追加';
      }
      
      // 今日の日付をデフォルトに設定
      const dateInput = document.getElementById('instagram-post-date');
      if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
      
      // モーダルを表示
      const modal = document.getElementById('instagram-modal');
      if (modal) {
        modal.classList.add('modal-visible');
        modal.classList.remove('modal-hidden');
        modal.style.display = 'flex';
        
        // フォーカスをURLフィールドに移動
        const urlInput = document.getElementById('instagram-post-url');
        if (urlInput) {
          setTimeout(() => urlInput.focus(), 100);
        }
      }
      
    } catch (error) {
      console.error('❌ Instagram投稿追加モーダルエラー:', error);
      this.error('モーダルの表示に失敗しました');
    }
  }

  /**
   * Instagram管理: 投稿保存
   */
  saveInstagramPost() {
    console.log('💾 Instagram投稿を保存中...');
    
    try {
      // フォームデータの取得
      const postData = {
        id: document.getElementById('instagram-post-id').value || this.#generateId(),
        url: document.getElementById('instagram-post-url').value.trim(),
        caption: document.getElementById('instagram-post-caption').value.trim(),
        date: document.getElementById('instagram-post-date').value,
        type: document.getElementById('instagram-post-type').value,
        featured: document.getElementById('instagram-post-featured').checked,
        createdAt: new Date().toISOString(),
        status: 'active'
      };
      
      // バリデーション
      if (!postData.url) {
        this.error('Instagram投稿URLは必須です');
        return;
      }
      
      if (!this.#isValidInstagramURL(postData.url)) {
        this.error('有効なInstagram投稿URLを入力してください');
        return;
      }
      
      // LocalStorageに保存
      const posts = this.#getInstagramPosts();
      const existingIndex = posts.findIndex(post => post.id === postData.id);
      
      if (existingIndex >= 0) {
        posts[existingIndex] = { ...posts[existingIndex], ...postData, updatedAt: new Date().toISOString() };
      } else {
        posts.unshift(postData);
      }
      
      localStorage.setItem(this.storageKeys.instagram, JSON.stringify(posts));
      
      // モーダルを閉じる
      this.closeInstagramModal();
      
      // 投稿一覧を更新
      this.refreshInstagramPosts();
      
      this.success(existingIndex >= 0 ? 'Instagram投稿を更新しました' : 'Instagram投稿を追加しました');
      
    } catch (error) {
      console.error('❌ Instagram投稿保存エラー:', error);
      this.error('Instagram投稿の保存に失敗しました');
    }
  }

  /**
   * Instagram管理: モーダルを閉じる
   */
  closeInstagramModal() {
    console.log('✖️ Instagram投稿モーダルを閉じる');
    
    const modal = document.getElementById('instagram-modal');
    if (modal) {
      modal.classList.remove('modal-visible');
      modal.classList.add('modal-hidden');
      modal.classList.remove('active', 'show');
      
      // モーダル内容をクリア
      const modalBody = modal.querySelector('#modal-body, .modal-body');
      if (modalBody) {
        modalBody.innerHTML = '';
      }
      
      this.debug('標準モーダルを閉じました');
    }
  }

  /**
   * Instagram管理: 設定保存
   */
  saveInstagramSettings() {
    console.log('⚙️ Instagram設定を保存中...');
    
    try {
      const settings = {
        username: document.getElementById('instagram-username').value.trim(),
        displayCount: parseInt(document.getElementById('instagram-display-count').value),
        autoSync: document.getElementById('instagram-auto-sync').checked,
        syncInterval: parseInt(document.getElementById('instagram-sync-interval').value),
        updatedAt: new Date().toISOString()
      };
      
      localStorage.setItem(`${this.storageKeys.instagram}_settings`, JSON.stringify(settings));
      
      this.success('Instagram設定を保存しました');
      
    } catch (error) {
      console.error('❌ Instagram設定保存エラー:', error);
      this.error('Instagram設定の保存に失敗しました');
    }
  }

  /**
   * Instagram管理: 投稿編集
   */
  editInstagramPost(postId) {
    console.log('✏️ Instagram投稿編集:', postId);
    
    try {
      const posts = this.#getInstagramPosts();
      const post = posts.find(p => p.id === postId);
      
      if (!post) {
        this.error('投稿が見つかりません');
        return;
      }
      
      // フォームに投稿データを設定
      document.getElementById('instagram-post-id').value = post.id;
      document.getElementById('instagram-post-url').value = post.url || '';
      document.getElementById('instagram-post-caption').value = post.caption || '';
      document.getElementById('instagram-post-date').value = post.date || '';
      document.getElementById('instagram-post-type').value = post.type || 'photo';
      document.getElementById('instagram-post-featured').checked = post.featured || false;
      
      // モーダルタイトルを更新
      document.getElementById('instagram-modal-title').innerHTML = 
        '<i class="fab fa-instagram"></i> Instagram投稿編集';
      
      // モーダルを表示
      const modal = document.getElementById('instagram-modal');
      if (modal) {
        modal.classList.add('modal-visible');
        modal.classList.remove('modal-hidden');
        modal.style.display = 'flex';
      }
      
    } catch (error) {
      console.error('❌ Instagram投稿編集エラー:', error);
      this.error('投稿の編集に失敗しました');
    }
  }

  /**
   * Instagram管理: 投稿ステータス切り替え
   */
  toggleInstagramPostStatus(postId) {
    console.log('👁️ Instagram投稿ステータス切り替え:', postId);
    
    try {
      const posts = this.#getInstagramPosts();
      const postIndex = posts.findIndex(p => p.id === postId);
      
      if (postIndex === -1) {
        this.error('投稿が見つかりません');
        return;
      }
      
      const post = posts[postIndex];
      post.status = post.status === 'hidden' ? 'active' : 'hidden';
      post.updatedAt = new Date().toISOString();
      
      localStorage.setItem(this.storageKeys.instagram, JSON.stringify(posts));
      
      // 投稿一覧を更新
      this.refreshInstagramPosts();
      
      this.success(`投稿を${post.status === 'hidden' ? '非表示' : '表示'}に変更しました`);
      
    } catch (error) {
      console.error('❌ Instagram投稿ステータス切り替えエラー:', error);
      this.error('投稿ステータスの変更に失敗しました');
    }
  }

  /**
   * Instagram管理: 投稿削除
   */
  async deleteInstagramPost(postId) {
    console.log('🗑️ Instagram投稿削除:', postId);
    
    try {
      const posts = this.#getInstagramPosts();
      const filteredPosts = posts.filter(post => post.id !== postId);
      
      if (posts.length === filteredPosts.length) {
        this.error('投稿が見つかりません');
        return;
      }
      
      localStorage.setItem(this.storageKeys.instagram, JSON.stringify(filteredPosts));
      
      // 投稿一覧を更新
      this.refreshInstagramPosts();
      
      this.success('Instagram投稿を削除しました');
      
    } catch (error) {
      console.error('❌ Instagram投稿削除エラー:', error);
      this.error('投稿の削除に失敗しました');
    }
  }

  // プライベートメソッド - Instagram管理

  /**
   * LocalStorageからInstagram投稿を取得（移行機能付き）
   * @private
   */
  #getInstagramPosts() {
    try {
      // 現在のキーでデータを確認
      const currentKey = this.storageKeys.instagram;
      console.log('🔍 Instagram投稿データ確認:', currentKey);
      
      let stored = localStorage.getItem(currentKey);
      let posts = stored ? JSON.parse(stored) : [];
      
      console.log(`📊 現在のキー (${currentKey}) で見つかった投稿数:`, posts.length);
      
      // データが見つからない場合、古い可能性のあるキーを確認
      if (posts.length === 0) {
        const oldPossibleKeys = [
          'rbs_instagram',
          'instagram_posts', 
          'instagram_data',
          'admin_instagram',
          'rbs_instagram_posts'
        ];
        
        console.log('🔄 古いキーでInstagram投稿を検索中...');
        
        for (const oldKey of oldPossibleKeys) {
          try {
            const oldStored = localStorage.getItem(oldKey);
            if (oldStored) {
              const oldPosts = JSON.parse(oldStored);
              if (oldPosts && oldPosts.length > 0) {
                console.log(`✅ 古いキー (${oldKey}) で${oldPosts.length}件の投稿を発見`);
                
                // 新しいキーに移行
                localStorage.setItem(currentKey, oldStored);
                posts = oldPosts;
                
                // 古いキーを削除
                localStorage.removeItem(oldKey);
                
                this.success(`Instagram投稿データを移行しました (${oldPosts.length}件)`);
                console.log('🚀 データ移行完了:', oldKey, '->', currentKey);
                break;
              }
            }
          } catch (error) {
            console.warn(`⚠️ 古いキー ${oldKey} の読み込みエラー:`, error);
          }
        }
      }
      
      // デバッグ情報を追加
      if (posts.length > 0) {
        console.log('📝 Instagram投稿サンプル:', posts[0]);
        console.log('📅 投稿日時範囲:', {
          oldest: posts.length > 0 ? Math.min(...posts.map(p => new Date(p.date || p.createdAt).getTime())) : null,
          newest: posts.length > 0 ? Math.max(...posts.map(p => new Date(p.date || p.createdAt).getTime())) : null
        });
      } else {
        console.log('📭 Instagram投稿データが見つかりません');
      }
      
      return posts;
      
    } catch (error) {
      console.error('❌ Instagram投稿データ読み込みエラー:', error);
      this.error('Instagram投稿の読み込みでエラーが発生しました');
      return [];
    }
  }

  /**
   * Instagram投稿HTMLの生成
   * @private
   */
  #generateInstagramPostsHTML(posts) {
    if (!posts || posts.length === 0) {
      return `
        <div class="instagram-post-card add-new" data-action="add-instagram-post">
          <div class="add-new-content">
            <i class="fab fa-instagram"></i>
            <h4>最初の投稿を追加</h4>
            <p>Instagram投稿のリンクを追加して管理を始めましょう</p>
          </div>
        </div>
      `;
    }
    
    let html = `
      <div class="instagram-post-card add-new" data-action="add-instagram-post">
        <div class="add-new-content">
          <i class="fas fa-plus"></i>
          <h4>新規投稿追加</h4>
          <p>新しいInstagram投稿を追加</p>
        </div>
      </div>
    `;
    
    posts.forEach(post => {
      const postDate = new Date(post.date || post.createdAt);
      const thumbnailUrl = this.#getInstagramThumbnail(post.url);
      
      html += `
        <div class="instagram-post-card" data-post-id="${post.id}">
          <div class="instagram-post-image">
            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
              <i class="fab fa-instagram"></i>
            </div>
            <div class="instagram-post-overlay">
              <div class="instagram-post-stats">
                <span><i class="fas fa-heart"></i> --</span>
                <span><i class="fas fa-comment"></i> --</span>
              </div>
            </div>
          </div>
          <div class="instagram-post-content">
            <div class="instagram-post-header">
              <div class="instagram-post-info">
                <div class="instagram-post-date">
                  <i class="fas fa-calendar-alt"></i>
                  ${this.#formatDate(postDate)}
                </div>
                <a href="${post.url}" target="_blank" class="instagram-post-url">
                  <i class="fab fa-instagram"></i>
                  投稿を開く
                </a>
              </div>
              <div class="instagram-post-actions">
                <button class="btn-icon" data-action="edit-instagram-post" data-post-id="${post.id}" title="編集">
                  <i class="fas fa-edit"></i>
                </button>
                <div class="dropdown">
                  <button class="btn-icon dropdown-toggle" title="メニュー">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu">
                    <button class="dropdown-item" data-action="toggle-instagram-post" data-post-id="${post.id}">
                      <i class="fas fa-eye${post.status === 'hidden' ? '' : '-slash'}"></i>
                      ${post.status === 'hidden' ? '表示' : '非表示'}
                    </button>
                    <button class="dropdown-item danger" data-action="delete-instagram-post" data-post-id="${post.id}">
                      <i class="fas fa-trash"></i>
                      削除
                    </button>
                  </div>
                </div>
              </div>
            </div>
            ${post.caption ? `<div class="instagram-post-caption">${post.caption}</div>` : ''}
            <div class="instagram-post-meta">
              <div class="instagram-post-type">
                <i class="fas fa-${this.#getPostTypeIcon(post.type)}"></i>
                ${this.#getPostTypeLabel(post.type)}
              </div>
              <div class="instagram-post-status ${post.status || 'active'}">
                ${post.status === 'hidden' ? '非表示' : '表示中'}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    return html;
  }

  /**
   * Instagram設定を読み込み
   * @private
   */
  #loadInstagramSettings() {
    try {
      const stored = localStorage.getItem(`${this.storageKeys.instagram}_settings`);
      const settings = stored ? JSON.parse(stored) : {
        username: '',
        displayCount: 9,
        autoSync: false,
        syncInterval: 30
      };
      
      document.getElementById('instagram-username').value = settings.username || '';
      document.getElementById('instagram-display-count').value = settings.displayCount || 9;
      document.getElementById('instagram-auto-sync').checked = settings.autoSync || false;
      document.getElementById('instagram-sync-interval').value = settings.syncInterval || 30;
      
    } catch (error) {
      console.error('❌ Instagram設定読み込みエラー:', error);
    }
  }

  /**
   * Instagram URL バリデーション
   * @private
   */
  #isValidInstagramURL(url) {
    try {
      const urlObj = new URL(url);
      return urlObj.hostname === 'www.instagram.com' && urlObj.pathname.includes('/p/');
    } catch {
      return false;
    }
  }

  /**
   * Instagram サムネイル取得（プレースホルダー）
   * @private
   */
  #getInstagramThumbnail(url) {
    // 実際の実装では Instagram Graph API などを使用
    return 'https://via.placeholder.com/400x400/833ab4/ffffff?text=Instagram';
  }

  /**
   * 投稿タイプのアイコン取得
   * @private
   */
  #getPostTypeIcon(type) {
    const icons = {
      photo: 'image',
      video: 'video',
      carousel: 'images'
    };
    return icons[type] || 'image';
  }

  /**
   * 投稿タイプのラベル取得
   * @private
   */
  #getPostTypeLabel(type) {
    const labels = {
      photo: '写真',
      video: '動画',
      carousel: '複数投稿'
    };
    return labels[type] || '写真';
  }

  /**
   * ユニークIDの生成
   * @private
   */
  #generateId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * 日付フォーマット
   * @private
   */
  #formatDate(date) {
    try {
      const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        timeZone: 'Asia/Tokyo'
      };
      return new Intl.DateTimeFormat('ja-JP', options).format(date);
    } catch (error) {
      console.error('日付フォーマットエラー:', error);
      return new Date(date).toLocaleDateString('ja-JP');
    }
  }

  /**
   * 相対時間のフォーマット
   * @private
   */
  #formatRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60 * 1000) {
      return 'たった今';
    } else if (diff < 60 * 60 * 1000) {
      const minutes = Math.floor(diff / (60 * 1000));
      return `${minutes}分前`;
    } else if (diff < 24 * 60 * 60 * 1000) {
      const hours = Math.floor(diff / (60 * 60 * 1000));
      return `${hours}時間前`;
    } else if (diff < 7 * 24 * 60 * 60 * 1000) {
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      return `${days}日前`;
    } else if (diff < 30 * 24 * 60 * 60 * 1000) {
      const weeks = Math.floor(diff / (7 * 24 * 60 * 60 * 1000));
      return `${weeks}週間前`;
    } else if (diff < 365 * 24 * 60 * 60 * 1000) {
      const months = Math.floor(diff / (30 * 24 * 60 * 60 * 1000));
      return `${months}ヶ月前`;
    } else {
      const years = Math.floor(diff / (365 * 24 * 60 * 60 * 1000));
      return `${years}年前`;
    }
  }

  /**
   * 文字数のカウント
   * @private
   */
  #getWordCount(article) {
    return article.content.trim().split(/\s+/).length;
  }

  /**
   * 記事をフィルタリング
   * @private
   */
  #filterArticles(articles, filter) {
    if (!filter || !filter.query) {
      return articles;
    }
    
    const query = filter.query.toLowerCase();
    return articles.filter(article => 
      article.title.toLowerCase().includes(query) ||
      article.content.toLowerCase().includes(query) ||
      article.category.toLowerCase().includes(query)
    );
  }

  /**
   * 記事リストHTMLを生成
   * @private
   */
  #generateArticleListHTML(articles, options = {}) {
    if (!articles || articles.length === 0) {
      return `
        <div class="empty-state">
          <i class="fas fa-newspaper"></i>
          <h3>記事がありません</h3>
          <p>新しい記事を作成してください</p>
        </div>
      `;
    }

    return articles.map(article => {
      const date = new Date(article.date);
      const categoryName = this.#getCategoryName(article.category);
      
      return `
        <div class="article-item" data-article-id="${article.id}">
          <div class="article-header">
            <h4 class="article-title">${article.title}</h4>
            <span class="article-category ${article.category}">${categoryName}</span>
          </div>
          <div class="article-meta">
            <span class="article-date">${date.toLocaleDateString('ja-JP')}</span>
            <span class="article-status ${article.status}">
              ${article.status === 'published' ? '公開済み' : '下書き'}
            </span>
            <span class="article-words">${this.#getWordCount(article)} 文字</span>
          </div>
          <div class="article-actions">
            <button class="btn-sm" data-action="edit-article" data-article-id="${article.id}">
              <i class="fas fa-edit"></i> 編集
            </button>
            <button class="btn-sm secondary" data-action="preview-article" data-article-id="${article.id}">
              <i class="fas fa-eye"></i> プレビュー
            </button>
            <div class="dropdown">
              <button class="btn-sm dropdown-toggle">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="dropdown-menu">
                <button class="dropdown-item" data-action="duplicate-article" data-article-id="${article.id}">
                  <i class="fas fa-copy"></i> 複製
                </button>
                <button class="dropdown-item danger" data-action="delete-article" data-article-id="${article.id}">
                  <i class="fas fa-trash"></i> 削除
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * ドロップダウンメニューを初期化
   * @private
   */
  #initializeDropdownMenus(container) {
    const dropdowns = container.querySelectorAll('.dropdown');
    
    dropdowns.forEach(dropdown => {
      const toggle = dropdown.querySelector('.dropdown-toggle');
      const menu = dropdown.querySelector('.dropdown-menu');
      
      if (!toggle || !menu) return;
      
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // 他のドロップダウンを閉じる
        dropdowns.forEach(otherDropdown => {
          if (otherDropdown !== dropdown) {
            otherDropdown.classList.remove('active');
          }
        });
        
        // このドロップダウンをトグル
        dropdown.classList.toggle('active');
      });
    });
    
    // 外部クリックで全てのドロップダウンを閉じる
    document.addEventListener('click', () => {
      dropdowns.forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    });
  }

  /**
   * 記事をエディターに読み込み
   * @private
   */
  #loadArticleToEditor(article, articleId) {
    try {
      // フォーム要素の取得
      const titleField = document.getElementById('news-title');
      const contentField = document.getElementById('news-content');
      const categoryField = document.getElementById('news-category');
      const priorityField = document.getElementById('news-priority');
      const hiddenIdField = document.getElementById('edit-article-id');
      
      // フィールドが存在しない場合はエラー
      if (!titleField || !contentField) {
        throw new Error('エディターフォームが見つかりません');
      }
      
      // 記事データを取得（詳細データが必要な場合）
      const articleContent = this.articleDataService.getArticleContent(articleId);
      
      // フォームに値をセット
      titleField.value = article.title || '';
      contentField.value = articleContent || article.content || '';
      
      if (categoryField) {
        categoryField.value = article.category || 'announcement';
      }
      
      if (priorityField) {
        priorityField.value = article.priority || 'normal';
      }
      
      // 編集対象記事IDを保存（隠しフィールドまたはデータ属性）
      if (hiddenIdField) {
        hiddenIdField.value = articleId;
      } else {
        // 隠しフィールドがない場合は作成
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'edit-article-id';
        hiddenInput.value = articleId;
        titleField.parentNode.appendChild(hiddenInput);
      }
      
      // エディターにフォーカス
      if (titleField) {
        titleField.focus();
        titleField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // ニュースタブに切り替え
      this.switchAdminTab('news');
      
      this.#showFeedback(`記事「${article.title}」をエディターに読み込みました`);
      
    } catch (error) {
      console.error('記事読み込みエラー:', error);
      this.#showFeedback('記事データの読み込みに失敗しました', 'error');
    }
  }
}

// シングルトンインスタンス
export const adminActionService = new AdminActionService();
