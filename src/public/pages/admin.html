<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理画面 - RBS陸上教室</title>
  <meta name="description" content="RBS陸上教室の管理画面">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- CSS -->
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/admin.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="../assets/images/rds-logo.png">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="page-admin">
  <!-- ヘッダー -->
  <header class="admin-header">
    <div class="header-left">
      <i class="fas fa-running admin-logo-icon"></i>
      <span class="admin-logo-text">RBS陸上教室 管理画面</span>
    </div>
    <div class="header-right">
      <div class="notification-settings">
        <button class="notification-toggle-btn" id="notification-toggle" 
                title="通知設定を切り替え" 
                data-action="toggle-notification-mode">
          <i class="fas fa-bell-slash"></i>
          <span class="toggle-text">通知OFF</span>
        </button>
      </div>
      <div class="session-info" id="session-info">
        <i class="fas fa-clock"></i>
        <span id="session-remaining">初期化中...</span>
      </div>
      <button class="logout-btn" data-action="logout" title="ログアウト">
        <i class="fas fa-sign-out-alt"></i>
        ログアウト
      </button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <div class="admin-container">
    <!-- サイドバー -->
    <aside class="admin-sidebar">
      <nav class="sidebar-nav">
        <div class="nav-item active" data-tab="dashboard" data-action="switch-tab">
          <i class="fas fa-chart-bar"></i>
          <span>ダッシュボード</span>
        </div>
        <div class="nav-item" data-tab="news-management" data-action="switch-tab">
          <i class="fas fa-newspaper"></i>
          <span>記事管理</span>
        </div>
        <div class="nav-item" data-tab="lesson-status" data-action="switch-tab">
          <i class="fas fa-calendar-check"></i>
          <span>レッスン状況</span>
        </div>
        <div class="nav-item" data-tab="settings" data-action="switch-tab">
          <i class="fas fa-cog"></i>
          <span>設定</span>
        </div>
      </nav>
    </aside>

    <!-- メインエリア -->
    <main class="admin-main">
      <!-- ダッシュボード -->
      <section id="dashboard" class="admin-section active">
        <div class="section-header">
          <h1><i class="fas fa-chart-bar"></i> ダッシュボード</h1>
        </div>
        
        <!-- 統計カード -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="total-articles">0</div>
              <div class="stat-label">総記事数</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon published">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="published-articles">0</div>
              <div class="stat-label">公開済み</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon draft">
              <i class="fas fa-edit"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="draft-articles">0</div>
              <div class="stat-label">下書き</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon current-month">
              <i class="fas fa-calendar"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="current-month-articles">0</div>
              <div class="stat-label">今月の記事</div>
            </div>
          </div>
        </div>

        <!-- 最近の記事 -->
        <div class="dashboard-widgets">
          <div class="widget">
            <div class="widget-header">
              <h2><i class="fas fa-newspaper"></i> 最近の記事</h2>
              <div class="widget-header-actions">
                <button class="btn-icon" data-action="refresh-recent-articles" title="更新">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
            <div class="widget-content">
              <div id="recent-articles">
                <div class="loading-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  記事を読み込み中...
                </div>
              </div>
            </div>
          </div>

          <!-- クイックアクション -->
          <div class="widget quick-actions">
            <div class="widget-header">
              <h2><i class="fas fa-bolt"></i> クイックアクション</h2>
            </div>
            <div class="widget-content">
              <div class="action-buttons">
                <button class="action-btn primary" data-action="new-news-article">
                  <i class="fas fa-plus"></i>
                  新しい記事を作成
                </button>
                <button class="action-btn success" data-action="switch-tab" data-tab="lesson-status">
                  <i class="fas fa-calendar-check"></i>
                  レッスン状況を更新
                </button>
                <button class="action-btn secondary" data-action="open-external" data-url="index.html">
                  <i class="fas fa-external-link-alt"></i>
                  サイトを確認
                </button>
                <button class="action-btn info" data-action="open-external" data-url="news.html">
                  <i class="fas fa-newspaper"></i>
                  ニュース一覧を確認
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 記事管理 -->
      <section id="news-management" class="admin-section">
        <div class="section-header">
          <h1><i class="fas fa-newspaper"></i> 記事管理</h1>
        </div>
        
        <!-- 記事管理用のタブナビゲーション -->
        <div class="sub-nav">
          <div class="sub-nav-item active" data-action="switch-news-tab" data-tab="editor">
            <i class="fas fa-edit"></i>
            新規記事作成
          </div>
          <div class="sub-nav-item" data-action="switch-news-tab" data-tab="list">
            <i class="fas fa-list"></i>
            記事一覧
          </div>
        </div>
        
        <!-- エディタータブ -->
        <div id="news-editor-tab" class="news-tab-content active">
          <div class="editor-panel">
            <div class="panel-header">
              <h2><i class="fas fa-edit"></i> <span id="editor-title">新規記事作成</span></h2>
              <div class="panel-actions">
                <button class="btn btn-outline" data-action="clear-news-editor">
                  クリア
                </button>
                <button class="btn btn-secondary" data-action="preview-news">
                  <i class="fas fa-eye"></i>
                  プレビュー
                </button>
                <button class="btn btn-primary" data-action="save-news">
                  <i class="fas fa-save"></i>
                  保存
                </button>
                <button class="btn btn-success" data-action="publish-news">
                  <i class="fas fa-globe"></i>
                  公開
                </button>
              </div>
            </div>
            
            <form class="editor-form">
              <input type="hidden" id="news-id">
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="news-title">
                    タイトル <span class="required">*</span>
                  </label>
                  <input type="text" id="news-title" class="form-input" placeholder="記事のタイトルを入力してください" required>
                </div>
                <div class="form-group">
                  <label for="news-category">
                    カテゴリー
                  </label>
                  <select id="news-category" class="form-select">
                    <option value="announcement">お知らせ</option>
                    <option value="event">体験会</option>
                    <option value="media">メディア</option>
                    <option value="important">重要</option>
                  </select>
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="news-date">
                    公開日
                  </label>
                  <input type="date" id="news-date" class="form-input">
                </div>
                <div class="form-group">
                  <label for="news-status">
                    ステータス
                  </label>
                  <select id="news-status" class="form-select">
                    <option value="draft">下書き</option>
                    <option value="published">公開</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label for="news-summary">
                  概要
                </label>
                <textarea id="news-summary" class="form-textarea" rows="3" placeholder="記事の概要を入力してください（記事一覧で表示されます）"></textarea>
              </div>
              
              <div class="form-group">
                <label for="news-content">
                  本文 <span class="required">*</span>
                </label>
                <div class="editor-toolbar">
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="**" data-end="**" title="太字">
                    <strong>B</strong>
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="## " data-end="" title="見出し">
                    H2
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="- " data-end="" title="リスト">
                    List
                  </button>
                  <button type="button" class="toolbar-btn" data-action="insert-markdown" data-start="[" data-end="](URL)" title="リンク">
                    Link
                  </button>
                  <div class="toolbar-separator"></div>
                  <button type="button" class="toolbar-btn help-btn" data-action="show-writing-guide" title="記事作成ガイド">
                    <i class="fas fa-question-circle"></i>
                    ガイド
                  </button>
                </div>
                <textarea id="news-content" class="form-textarea editor-content" placeholder="記事の本文をMarkdown形式で入力してください" required></textarea>
                <div class="form-help">
                  <small>Markdown記法: **太字**、## 見出し、- リスト、[リンク](URL) | <a href="#" data-action="show-writing-guide" class="help-link">📖 詳細な記事作成ガイドを見る</a></small>
                </div>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="news-featured"> 注目記事として表示する
                </label>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 記事一覧タブ -->
        <div id="news-list-tab" class="news-tab-content">
          <div class="list-panel full-width">
            <div class="panel-header">
              <h2><i class="fas fa-list"></i> 記事一覧</h2>
              <div class="panel-filters">
                <select id="news-filter" class="form-select" data-action="filter-news-list" data-target="news-filter">
                  <option value="all">すべて</option>
                  <option value="published">公開中</option>
                  <option value="draft">下書き</option>
                </select>
                <button class="btn btn-outline" data-action="refresh-news-list">
                  更新
                </button>
              </div>
            </div>
            <div id="news-list" class="list-content">
              <!-- 記事一覧がここに表示される -->
              <div class="loading-state">
                記事を読み込み中...
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- レッスン状況 -->
      <section id="lesson-status" class="admin-section">
        <div class="section-header">
          <h1><i class="fas fa-calendar-check"></i> レッスン開催状況</h1>
          <p class="section-description">本日のレッスン開催状況を設定・管理できます</p>
        </div>
        
        <!-- ステップガイド -->
        <div class="lesson-status-wizard">
          <div class="wizard-steps">
            <div class="step active" data-step="1">
              <div class="step-number">1</div>
              <span>全体ステータス</span>
            </div>
            <div class="step" data-step="2">
              <div class="step-number">2</div>
              <span>詳細設定</span>
            </div>
            <div class="step" data-step="3">
              <div class="step-number">3</div>
              <span>コース別設定</span>
            </div>
          </div>
          
          <!-- ステップ1: 全体ステータス -->
          <div class="wizard-content step-1 active">
            <div class="step-panel">
              <div class="step-header">
                <h3><i class="fas fa-broadcast-tower"></i> 全体開催ステータス</h3>
                <p>すべてのコースに適用される基本的な開催状況を選択してください</p>
              </div>
              
              <div class="status-selector-grid">
                <label class="status-option scheduled" for="global-scheduled">
                  <input type="radio" id="global-scheduled" name="global-status" value="通常開催" checked>
                  <div class="option-card">
                    <div class="option-icon">
                      <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="option-content">
                      <h4>通常開催</h4>
                      <p>予定通り屋外で実施</p>
                    </div>
                    <div class="option-check">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                </label>
                
                <label class="status-option cancelled" for="global-cancelled">
                  <input type="radio" id="global-cancelled" name="global-status" value="中止">
                  <div class="option-card">
                    <div class="option-icon">
                      <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="option-content">
                      <h4>中止</h4>
                      <p>本日は開催中止</p>
                    </div>
                    <div class="option-check">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                </label>
                
                <label class="status-option indoor" for="global-indoor">
                  <input type="radio" id="global-indoor" name="global-status" value="室内開催">
                  <div class="option-card">
                    <div class="option-icon">
                      <i class="fas fa-home"></i>
                    </div>
                    <div class="option-content">
                      <h4>室内開催</h4>
                      <p>室内で実施します</p>
                    </div>
                    <div class="option-check">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                </label>
                
                <label class="status-option postponed" for="global-postponed">
                  <input type="radio" id="global-postponed" name="global-status" value="延期">
                  <div class="option-card">
                    <div class="option-icon">
                      <i class="fas fa-clock"></i>
                    </div>
                    <div class="option-content">
                      <h4>延期</h4>
                      <p>別日程に変更</p>
                    </div>
                    <div class="option-check">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- ステップ2: 詳細設定 -->
          <div class="wizard-content step-2">
            <div class="step-panel">
              <div class="step-header">
                <h3><i class="fas fa-cog"></i> 詳細設定</h3>
                <p>開催日とメッセージを設定してください</p>
              </div>
              
              <div class="detail-settings-grid">
                <div class="setting-card">
                  <div class="setting-header">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>対象日</h4>
                  </div>
                  <div class="setting-content">
                    <input type="date" id="lesson-date" class="date-input" value="">
                  </div>
                </div>
                
                <div class="setting-card full-width">
                  <div class="setting-header">
                    <i class="fas fa-comment-alt"></i>
                    <h4>メッセージ（任意）</h4>
                  </div>
                  <div class="setting-content">
                    <textarea id="global-message" class="message-textarea" rows="3" placeholder="例：雨天のため室内で実施いたします。体育館シューズをお持ちください。"></textarea>
                    <div class="textarea-help">
                      <small><i class="fas fa-info-circle"></i> このメッセージはトップページに表示されます</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ステップ3: コース別設定 -->
          <div class="wizard-content step-3">
            <div class="step-panel">
              <div class="step-header">
                <h3><i class="fas fa-users"></i> コース別設定</h3>
                <p>各コースの個別設定（必要に応じて全体設定から変更）</p>
              </div>
              
              <div class="courses-settings">
                <div class="course-setting-card">
                  <div class="course-setting-header">
                    <div class="course-info">
                      <h4>ベーシックコース</h4>
                      <span class="course-detail">年長〜小3対象 / 17:00-17:50</span>
                    </div>
                    <div class="course-status-indicator">
                      <span class="status-badge scheduled">通常開催</span>
                    </div>
                  </div>
                  
                  <div class="course-status-options">
                    <label class="mini-status-option">
                      <input type="radio" name="basic-lesson" value="通常開催" checked>
                      <span class="option-text">
                        <i class="fas fa-check-circle"></i>
                        通常開催
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="basic-lesson" value="中止">
                      <span class="option-text">
                        <i class="fas fa-times-circle"></i>
                        中止
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="basic-lesson" value="室内開催">
                      <span class="option-text">
                        <i class="fas fa-home"></i>
                        室内開催
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="basic-lesson" value="延期">
                      <span class="option-text">
                        <i class="fas fa-clock"></i>
                        延期
                      </span>
                    </label>
                  </div>
                </div>
                
                <div class="course-setting-card">
                  <div class="course-setting-header">
                    <div class="course-info">
                      <h4>アドバンスコース</h4>
                      <span class="course-detail">小4〜小6対象 / 18:00-18:50</span>
                    </div>
                    <div class="course-status-indicator">
                      <span class="status-badge scheduled">通常開催</span>
                    </div>
                  </div>
                  
                  <div class="course-status-options">
                    <label class="mini-status-option">
                      <input type="radio" name="advance-lesson" value="通常開催" checked>
                      <span class="option-text">
                        <i class="fas fa-check-circle"></i>
                        通常開催
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="advance-lesson" value="中止">
                      <span class="option-text">
                        <i class="fas fa-times-circle"></i>
                        中止
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="advance-lesson" value="室内開催">
                      <span class="option-text">
                        <i class="fas fa-home"></i>
                        室内開催
                      </span>
                    </label>
                    <label class="mini-status-option">
                      <input type="radio" name="advance-lesson" value="延期">
                      <span class="option-text">
                        <i class="fas fa-clock"></i>
                        延期
                      </span>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- プレビューボタン -->
              <div class="course-preview-actions">
                <button class="btn btn-outline" id="show-preview-btn">
                  <i class="fas fa-eye"></i>
                  プレビューを表示
                </button>
              </div>
            </div>
          </div>
          
          <!-- ナビゲーションとアクション -->
          <div class="wizard-actions">
            <div class="nav-buttons">
              <button class="btn btn-outline wizard-prev" disabled>
                <i class="fas fa-chevron-left"></i>
                前へ
              </button>
              <button class="btn btn-primary wizard-next">
                次へ
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            
            <div class="action-buttons">
              <button class="btn btn-outline" data-action="load-lesson-status">
                <i class="fas fa-download"></i>
                現在の状況を読み込み
              </button>
              <button class="btn btn-success" data-action="update-lesson-status">
                <i class="fas fa-save"></i>
                保存して公開
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 設定 -->
      <section id="settings" class="admin-section">
        <div class="section-header">
          <h1><i class="fas fa-cog"></i> 設定</h1>
        </div>
        
        <div class="settings-panel">
          <div class="setting-group">
            <h3><i class="fas fa-database"></i> データ管理</h3>
            <p>記事、Instagram投稿、レッスン状況データの統合管理とバックアップ</p>
            <div class="setting-actions">
              <button class="btn btn-outline" data-action="export-data">
                <i class="fas fa-download"></i> 全データをエクスポート
              </button>
              <button class="btn btn-outline" data-action="clear-all-data">
                <i class="fas fa-trash"></i> 全データクリア
              </button>
            </div>
            <small class="setting-note">
              <i class="fas fa-info-circle"></i>
              エクスポート機能が改善されました。ファイル名、メタデータ、エラーハンドリングが強化されています。
            </small>
          </div>
          
          <div class="setting-group">
            <h3><i class="fas fa-link"></i> サイト連携</h3>
            <p>フロントエンドサイトとの連携状況</p>
            <div class="setting-actions">
              <button class="btn btn-primary" data-action="test-site-connection">
                <i class="fas fa-link"></i> 連携テスト
              </button>
              <div id="site-connection-test-results" class="test-results" style="margin-top: 10px;"></div>
              <button class="btn btn-secondary" data-action="open-external" data-url="news.html">
                <i class="fas fa-external-link-alt"></i> ニュースページを開く
              </button>
            </div>
          </div>
          
          <div class="setting-group">
            <h3><i class="fas fa-tools"></i> 開発者ツール</h3>
            <p>開発・デバッグ機能（本番環境では非表示）</p>
            <div class="setting-actions">
              <button class="btn btn-info" data-action="show-debug-info">
                <i class="fas fa-info-circle"></i> システム情報表示
              </button>
              <button class="btn btn-info" data-action="show-news-debug">
                <i class="fas fa-bug"></i> ニュース連携デバッグ
              </button>
              <button class="btn btn-warning" data-action="reset-local-storage">
                <i class="fas fa-redo"></i> LocalStorage リセット
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- モーダル -->
  <div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button class="modal-close" data-action="close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- プレビュー内容がここに表示される -->
      </div>
    </div>
  </div>

  <!-- 通知エリア -->
  <div id="notification-container" class="notification-container">
    <!-- 通知がここに表示される -->
  </div>

  <!-- アプリケーション初期化 -->
  <script type="module">
    import { app } from '../js/core/Application.js';
    
    // 標準的なApplication.jsを使った初期化
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('🚀 RBS管理画面 - Application初期化開始');
        await app.init();
        console.log('✅ RBS管理画面 - Application初期化完了');
      } catch (error) {
        console.error('❌ Application初期化エラー:', error);
        
        // エラー時はログイン画面にリダイレクト
        const shouldRedirect = confirm(
          `管理画面の初期化に失敗しました。\n\nエラー: ${error.message}\n\nログイン画面に戻りますか？`
        );
        if (shouldRedirect) {
          window.location.href = 'admin-login.html';
        }
      }
    });
  </script>

  <!-- 通知システムヘルパー -->
  <script>
    // グローバル通知ヘルパー関数
    window.showNotification = function(type, message, duration = 4000, options = {}) {
      if (window.uiManagerService) {
        return window.uiManagerService.showNotification(type, message, duration, options);
      } else {
        // フォールバック: シンプルな通知
        console.log(`${type.toUpperCase()}: ${message}`);
        
        // 簡易通知要素を作成
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 24px;
          padding: 16px 20px;
          border-radius: 12px;
          color: white;
          font-weight: 600;
          z-index: 9999;
          max-width: 400px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
          background: ${type === 'success' ? '#22c55e' : 
                      type === 'error' ? '#ef4444' : 
                      type === 'warning' ? '#f59e0b' : '#3b82f6'};
          transform: translateX(100%);
          transition: all 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // アニメーション
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 10);
        
        // 自動削除
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, duration);
      }
    };
    
    // 便利なヘルパー関数
    window.showSuccess = (message, duration, options) => 
      window.showNotification('success', message, duration, options);
    
    window.showError = (message, duration, options) => 
      window.showNotification('error', message, duration, options);
    
    window.showWarning = (message, duration, options) => 
      window.showNotification('warning', message, duration, options);
    
    window.showInfo = (message, duration, options) => 
      window.showNotification('info', message, duration, options);
    
    // ActionManager アクセスヘルパー
    window.registerAction = function(actionName, handler) {
      if (window.app && window.app.actionManager) {
        window.app.actionManager.register(actionName, handler);
        console.log(`✅ アクション登録: ${actionName}`);
      } else {
        console.warn(`⚠️ ActionManagerが利用できません: ${actionName}`);
      }
    };
    
    // デバッグ用: 登録済みアクション一覧表示
    window.listActions = function() {
      if (window.app && window.app.actionManager) {
        console.log('📋 登録済みアクション:', Array.from(window.app.actionManager._actions.keys()));
      } else {
        console.warn('⚠️ ActionManagerが利用できません');
      }
    };
    
    // console.logを通知でも表示するオーバーライド（デバッグモード時のみ）
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;
      
      // 管理画面での重要なログのみ通知として表示
      console.log = function(...args) {
        originalLog.apply(console, args);
        
        const message = args.join(' ');
        if (message.includes('✅') && message.length < 100 && !message.includes('ActionManager')) {
          window.showSuccess(message.replace(/✅|🎯|📱|🔧/g, '').trim(), 2000);
        }
      };
      
      console.warn = function(...args) {
        originalWarn.apply(console, args);
        
        const message = args.join(' ');
        if (message.includes('⚠️') && message.length < 100 && !message.includes('未登録')) {
          window.showWarning(message.replace(/⚠️/g, '').trim(), 4000);
        }
      };
      
      console.error = function(...args) {
        originalError.apply(console, args);
        
        const message = args.join(' ');
        if (message.includes('❌') && message.length < 100) {
          window.showError(message.replace(/❌/g, '').trim(), 6000);
        }
      };
    }
  </script>

  <!-- レッスン状況フォーム用デフォルト日付設定 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // デフォルト日付設定
      const lessonDateField = document.getElementById('lesson-date');
      if (lessonDateField && !lessonDateField.value) {
        lessonDateField.value = new Date().toISOString().slice(0, 10);
      }
      
      // ウィザードナビゲーション
      let currentStep = 1;
      const maxSteps = 3;
      
      const steps = document.querySelectorAll('.step');
      const wizardContents = document.querySelectorAll('.wizard-content');
      const prevBtn = document.querySelector('.wizard-prev');
      const nextBtn = document.querySelector('.wizard-next');
      
      function updateStep(stepNumber) {
        // ステップインジケーターの更新
        steps.forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.toggle('active', stepNum === stepNumber);
          step.classList.toggle('completed', stepNum < stepNumber);
        });
        
        // コンテンツの更新
        wizardContents.forEach((content, index) => {
          content.classList.toggle('active', index + 1 === stepNumber);
        });
        
        // ボタンの状態更新
        prevBtn.disabled = stepNumber === 1;
        if (stepNumber === maxSteps) {
          nextBtn.style.display = 'none';
        } else {
          nextBtn.style.display = 'flex';
        }
        
        currentStep = stepNumber;
      }
      
      // ナビゲーションボタンのイベントリスナー
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentStep > 1) {
            updateStep(currentStep - 1);
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (currentStep < maxSteps) {
            updateStep(currentStep + 1);
          }
        });
      }
      
      // ステップクリックでのナビゲーション
      steps.forEach((step, index) => {
        step.addEventListener('click', () => {
          updateStep(index + 1);
        });
      });
    });
    
    // プレビュー機能（グローバルスコープ）
    function showPreviewModal() {
      console.log('🎯 プレビューモーダルを表示');
      
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');
      
      if (!modal || !modalTitle || !modalBody) {
        console.error('❌ モーダル要素が見つかりません');
        return;
      }
      
      // 入力値を取得
      const selectedStatus = document.querySelector('input[name="global-status"]:checked');
      const dateInput = document.getElementById('lesson-date');
      const messageInput = document.getElementById('global-message');
      const basicStatus = document.querySelector('input[name="basic-lesson"]:checked');
      const advanceStatus = document.querySelector('input[name="advance-lesson"]:checked');
      
      if (!selectedStatus) {
        alert('全体ステータスを選択してください');
        return;
      }
      
      // ステータスに応じた設定を取得
      const statusConfig = getStatusConfig(selectedStatus.value);
      
      // 日付をフォーマット
      let dateText = '日付未設定';
      if (dateInput && dateInput.value) {
        const date = new Date(dateInput.value);
        dateText = date.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'short'
        });
      }
      
      // プレビューHTMLを生成
      const previewHTML = generatePreviewHTML({
        status: statusConfig,
        dateText: dateText,
        message: messageInput ? messageInput.value : '',
        basicStatus: basicStatus ? basicStatus.value : '通常開催',
        advanceStatus: advanceStatus ? advanceStatus.value : '通常開催'
      });
      
      // モーダルに内容を設定
      modalTitle.innerHTML = '<i class="fas fa-eye"></i> レッスン状況プレビュー';
      modalBody.innerHTML = previewHTML;
      
      // モーダルを表示
      modal.style.display = 'flex';
      modal.classList.add('show');
      
      console.log('✅ プレビューモーダル表示完了');
    }
    
    function getStatusConfig(statusValue) {
      const configs = {
        '通常開催': {
          text: '通常開催',
          icon: 'fas fa-check-circle',
          color: '#27ae60'
        },
        '中止': {
          text: '中止',
          icon: 'fas fa-times-circle',
          color: '#e74c3c'
        },
        '室内開催': {
          text: '室内開催',
          icon: 'fas fa-home',
          color: '#f39c12'
        },
        '延期': {
          text: '延期',
          icon: 'fas fa-clock',
          color: '#9b59b6'
        }
      };
      
      return configs[statusValue] || configs['通常開催'];
    }
    
    function generatePreviewHTML(data) {
      return `
        <div class="lesson-status-preview">
          <div class="preview-status-display">
            <div class="preview-icon" style="background: ${data.status.color};">
              <i class="${data.status.icon}"></i>
            </div>
            <div class="preview-text">
              <h4>${data.status.text}</h4>
              <p class="preview-date">${data.dateText}</p>
              ${data.message ? `<div class="preview-message">${data.message}</div>` : ''}
            </div>
          </div>
          
          <div class="preview-courses">
            <div class="preview-course">
              <span class="preview-course-name">ベーシック</span>
              <span class="preview-course-status">${data.basicStatus}</span>
            </div>
            <div class="preview-course">
              <span class="preview-course-name">アドバンス</span>
              <span class="preview-course-status">${data.advanceStatus}</span>
            </div>
          </div>
          
          <div class="preview-info">
            <p>
              <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
              この内容がトップページに表示されます
            </p>
          </div>
        </div>
      `;
    }
    
    // モーダル制御
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
      }
    }
    
    // イベントリスナーの設定
    document.addEventListener('DOMContentLoaded', function() {
      // プレビューボタン
      const showPreviewBtn = document.getElementById('show-preview-btn');
      if (showPreviewBtn) {
        showPreviewBtn.addEventListener('click', showPreviewModal);
        console.log('✅ プレビューボタンのイベントリスナー設定完了');
      } else {
        console.warn('⚠️ プレビューボタンが見つかりません');
      }
      
      // モーダル閉じるボタン
      const modalClose = document.querySelector('.modal-close');
      if (modalClose) {
        modalClose.addEventListener('click', closeModal);
      }
      
      // モーダル背景クリックで閉じる
      const modal = document.getElementById('modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeModal();
          }
        });
      }
    });
  </script>
</body>
</html> 