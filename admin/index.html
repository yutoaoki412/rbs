<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RBS陸上教室 - 管理画面</title>
  <link rel="stylesheet" href="../css/admin-style.css">
</head>
<body>
  <!-- ローディング画面 -->
  <div id="loading-screen" class="loading">
    <div class="loading-spinner"></div>
    <p>管理画面を読み込み中...</p>
  </div>

  <!-- メイン画面 -->
  <div id="main-content" style="display: none;">
    <div class="header">
      <div class="header-content">
        <h1>🏃‍♂️ RBS陸上教室 管理画面</h1>
        <button class="logout-btn" id="logout-btn">ログアウト</button>
      </div>
    </div>

    <div class="container">
      <!-- アラート表示エリア -->
      <div id="alert-area"></div>

      <!-- タブナビゲーション -->
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard">📊 ダッシュボード</button>
        <button class="nav-tab" data-tab="articles">📝 記事管理</button>
        <button class="nav-tab" data-tab="status">📅 レッスン状況</button>
        <button class="nav-tab" data-tab="settings">⚙️ 設定</button>
      </div>

      <!-- ダッシュボードタブ -->
      <div id="dashboard" class="tab-content active">
        <div class="card">
          <h2>📊 統計情報</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="total-articles">0</div>
              <div class="stat-label">総記事数</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="published-articles">0</div>
              <div class="stat-label">公開済み</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="draft-articles">0</div>
              <div class="stat-label">下書き</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="this-month-articles">0</div>
              <div class="stat-label">今月の記事</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>📝 最近の記事</h2>
          <div id="recent-articles">
            <p>記事を読み込み中...</p>
          </div>
        </div>

        <div class="card">
          <h2>🔗 クイックアクション</h2>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="btn btn-primary" id="quick-new-article">新しい記事を作成</button>
            <button class="btn btn-success" id="quick-lesson-status">レッスン状況を更新</button>
            <a href="../index.html" target="_blank" class="btn btn-secondary">サイトを確認</a>
          </div>
        </div>
      </div>

      <!-- 記事管理タブ -->
      <div id="articles" class="tab-content">
        <div class="card">
          <h2>📝 記事管理</h2>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <button class="btn btn-primary" id="new-article-btn">新しい記事を作成</button>
            </div>
            <div>
              <input type="text" id="search-input" placeholder="記事を検索..." class="form-control" style="width: 300px; margin: 0;">
            </div>
          </div>
          <div id="articles-content">
            <p>記事を読み込み中...</p>
          </div>
        </div>
      </div>

      <!-- レッスン状況タブ -->
      <div id="status" class="tab-content">
        <div class="card">
          <h2>📅 レッスン開催状況</h2>
          <form id="status-form">
            <!-- 全体開催状況 -->
            <div class="form-group">
              <label>本日の開催状況</label>
              <div class="radio-group">
                <label class="radio-item">
                  <input type="radio" name="overallStatus" value="running" checked>
                  <span>開催中</span>
                </label>
                <label class="radio-item">
                  <input type="radio" name="overallStatus" value="scheduled">
                  <span>開催予定</span>
                </label>
                <label class="radio-item">
                  <input type="radio" name="overallStatus" value="cancelled">
                  <span>中止</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="overall-note">補足メッセージ（任意）</label>
              <input type="text" id="overall-note" name="overallNote" class="form-control" 
                     placeholder="例：雨天のため屋内で実施">
            </div>

            <!-- 個別レッスン状況 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
              <!-- ベーシックコース -->
              <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">ベーシックコース（17:00-17:50）</h3>
                <div class="form-group">
                  <label>開催状況</label>
                  <div class="radio-group" style="flex-direction: column; gap: 10px;">
                    <label class="radio-item">
                      <input type="radio" name="basicStatus" value="running" checked>
                      <span>開催中</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="basicStatus" value="scheduled">
                      <span>開催予定</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="basicStatus" value="cancelled">
                      <span>中止</span>
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="basic-note">補足メッセージ</label>
                  <input type="text" id="basic-note" name="basicNote" class="form-control" 
                         placeholder="例：時間変更あり">
                </div>
              </div>

              <!-- アドバンスコース -->
              <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">アドバンスコース（18:00-18:50）</h3>
                <div class="form-group">
                  <label>開催状況</label>
                  <div class="radio-group" style="flex-direction: column; gap: 10px;">
                    <label class="radio-item">
                      <input type="radio" name="advanceStatus" value="running">
                      <span>開催中</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="advanceStatus" value="scheduled" checked>
                      <span>開催予定</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="advanceStatus" value="cancelled">
                      <span>中止</span>
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="advance-note">補足メッセージ</label>
                  <input type="text" id="advance-note" name="advanceNote" class="form-control" 
                         placeholder="例：時間変更あり">
                </div>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
              <button type="submit" class="btn btn-success" id="save-status-btn">💾 保存して公開</button>
            </div>
          </form>
        </div>
      </div>

      <!-- 設定タブ -->
      <div id="settings" class="tab-content">
        <div class="card">
          <h2>⚙️ システム設定</h2>
          <div class="form-group">
            <label>データエクスポート</label>
            <button class="btn btn-secondary" id="export-btn">記事データをエクスポート</button>
          </div>
          <div class="form-group">
            <label>データインポート</label>
            <input type="file" id="import-file" accept=".json" class="form-control">
            <button class="btn btn-secondary" id="import-btn" style="margin-top: 10px;">記事データをインポート</button>
          </div>
          <div class="form-group">
            <label>デバッグ機能</label>
            <button class="btn btn-secondary" id="debugBtn">デバッグ情報を出力</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScriptファイルを読み込み -->
  <script src="../js/admin/admin-auth.js"></script>
  <script src="../js/admin/admin-manager.js"></script>
  <!-- admin-dashboard.js is not directly referenced in the provided index.html structure, but if it were, its path would also need updating. -->
  <!-- For example: <script src="../js/admin/admin-dashboard.js"></script> -->

  <script>
    // グローバル変数
    let adminAuth;
    let adminManager;
    let currentTab = 'dashboard';

    // 初期化
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('管理画面を初期化中...');
        
        // 認証システムを初期化
        adminAuth = new AdminAuth();
        
        // 認証チェック
        if (!adminAuth.isAuthenticated()) {
          console.log('認証されていません。ログイン画面にリダイレクトします。');
          window.location.href = 'login.html';
          return;
        }

        console.log('認証OK');

        // 管理システムを初期化
        adminManager = new AdminManager();
        await adminManager.loadArticles();

        console.log('記事データを読み込みました:', adminManager.articles.length, '件');
        console.log('記事データ詳細:', adminManager.articles);

        // UI初期化
        setupEventListeners();
        setupRadioButtons();
        
        // 初期表示
        await renderDashboard();
        
        // ローディング画面を非表示にしてメイン画面を表示
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        console.log('管理画面の初期化が完了しました');
      } catch (error) {
        console.error('初期化エラー:', error);
        showAlert('管理画面の初期化に失敗しました: ' + error.message, 'error');
        
        // エラーが発生した場合もメイン画面を表示
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
      }
    });

    // イベントリスナーを設定
    function setupEventListeners() {
      console.log('イベントリスナーを設定中...');
      
      // ログアウトボタン
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }

      // タブ切り替え
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          const tabName = this.getAttribute('data-tab');
          console.log('タブ切り替え:', tabName);
          switchTab(tabName);
        });
      });

      // クイックアクションボタン
      const quickNewArticle = document.getElementById('quick-new-article');
      if (quickNewArticle) {
        quickNewArticle.addEventListener('click', () => switchTab('articles'));
      }

      const quickLessonStatus = document.getElementById('quick-lesson-status');
      if (quickLessonStatus) {
        quickLessonStatus.addEventListener('click', () => switchTab('status'));
      }

      // 記事管理ボタン
      const newArticleBtn = document.getElementById('new-article-btn');
      if (newArticleBtn) {
        newArticleBtn.addEventListener('click', createNewArticle);
      }

      // 検索機能
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          handleSearch(e.target.value);
        });
      }

      // レッスン状況フォーム
      const statusForm = document.getElementById('status-form');
      if (statusForm) {
        statusForm.addEventListener('submit', handleStatusSubmit);
      }

      // 設定ボタン
      const exportBtn = document.getElementById('export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', exportData);
      }

      const importBtn = document.getElementById('import-btn');
      if (importBtn) {
        importBtn.addEventListener('click', importData);
      }

      console.log('イベントリスナーの設定が完了しました');
    }

    // ラジオボタンの見た目を設定
    function setupRadioButtons() {
      document.querySelectorAll('.radio-item').forEach(item => {
        const radio = item.querySelector('input[type="radio"]');
        
        if (radio && radio.checked) {
          item.classList.add('selected');
        }
        
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const name = radio.name;
          document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
            r.closest('.radio-item').classList.remove('selected');
          });
          
          radio.checked = true;
          item.classList.add('selected');
        });
      });
    }

    // タブ切り替え
    function switchTab(tabName) {
      console.log('タブを切り替え:', tabName);
      
      // すべてのタブを非アクティブに
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // 選択されたタブをアクティブに
      const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
      const targetContent = document.getElementById(tabName);
      
      if (targetTab && targetContent) {
        targetTab.classList.add('active');
        targetContent.classList.add('active');
        currentTab = tabName;

        // タブ固有の処理
        if (tabName === 'articles') {
          renderArticleList();
        } else if (tabName === 'dashboard') {
          renderDashboard();
        } else if (tabName === 'status') {
          loadCurrentStatus();
        }
      }
    }

    // ダッシュボードを表示
    async function renderDashboard() {
      if (!adminManager) {
        console.log('adminManagerが初期化されていません');
        return;
      }

      try {
        console.log('ダッシュボードを表示中...', adminManager.articles);
        
        const stats = adminManager.getStats();
        
        console.log('統計情報をDOMに設定:', stats);
        
        // 統計情報を更新
        document.getElementById('total-articles').textContent = stats.total;
        document.getElementById('published-articles').textContent = stats.published;
        document.getElementById('draft-articles').textContent = stats.draft;
        document.getElementById('this-month-articles').textContent = stats.thisMonth;

        // 最近の記事を表示
        renderRecentArticles();
      } catch (error) {
        console.error('ダッシュボード表示エラー:', error);
        showAlert('ダッシュボードの表示に失敗しました', 'error');
      }
    }

    // 最近の記事を表示
    function renderRecentArticles() {
      const container = document.getElementById('recent-articles');
      if (!container || !adminManager) return;

      console.log('最近の記事を表示中...', adminManager.articles);

      const articles = adminManager.articles
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

      console.log('ソート・フィルタ後の記事:', articles);

      if (articles.length === 0) {
        container.innerHTML = '<p>記事がありません</p>';
        return;
      }

      const html = articles.map(article => `
        <div style="padding: 10px; border-bottom: 1px solid #dee2e6;">
          <strong>${escapeHtml(article.title)}</strong>
          <span class="category-badge category-${article.category}" style="margin-left: 10px;">
            ${escapeHtml(article.categoryName)}
          </span>
          <span class="status-badge status-${article.status || 'published'}" style="margin-left: 5px;">
            ${article.status === 'draft' ? '下書き' : '公開済み'}
          </span>
          <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
            ${adminManager.formatDate(article.date)}
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // 記事一覧を表示
    function renderArticleList() {
      const container = document.getElementById('articles-content');
      if (!container || !adminManager) return;

      const articles = adminManager.getFilteredArticles();

      if (articles.length === 0) {
        container.innerHTML = '<p>記事がありません</p>';
        return;
      }

      const html = `
        <table class="articles-table">
          <thead>
            <tr>
              <th>タイトル</th>
              <th>カテゴリー</th>
              <th>日付</th>
              <th>ステータス</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            ${articles.map(article => `
              <tr>
                <td>
                  <strong>${escapeHtml(article.title)}</strong>
                  <br>
                  <small style="color: #6c757d;">${escapeHtml(article.excerpt)}</small>
                </td>
                <td>
                  <span class="category-badge category-${article.category}">
                    ${escapeHtml(article.categoryName)}
                  </span>
                </td>
                <td>${adminManager.formatDate(article.date)}</td>
                <td>
                  <span class="status-badge status-${article.status || 'published'}">
                    ${article.status === 'draft' ? '下書き' : '公開済み'}
                  </span>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="editArticle(${article.id})">編集</button>
                  <button class="btn btn-secondary btn-sm" onclick="toggleStatus(${article.id})">
                    ${article.status === 'draft' ? '公開' : '下書きに戻す'}
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="deleteArticle(${article.id})">削除</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // 検索処理
    function handleSearch(query) {
      if (!adminManager) return;
      
      adminManager.searchQuery = query;
      if (currentTab === 'articles') {
        renderArticleList();
      }
    }

    // 現在のレッスン状況を読み込み (APIから)
    async function loadCurrentStatus() {
      console.log('APIからレッスン状況を読み込み中...');
      try {
        const response = await fetch('/api/status');
        if (!response.ok) {
          if (response.status === 404) {
            console.log('レッスン状況データがAPIにありません。デフォルト値を表示します。');
            // フォームはデフォルト値のまま or クリアする
            // ここでは特に何もしない（HTMLのデフォルトcheckedが適用される）
            showAlert('現在保存されているレッスン状況はありません。', 'info');
            return;
          }
          const errorData = await response.json().catch(() => ({ message: response.statusText }));
          throw new Error(`APIエラー: ${response.status} - ${errorData.message || errorData.error}`);
        }
        
        const statusData = await response.json();
        console.log('APIからレッスン状況を読み込みました:', statusData);
        
        // フォームに値を設定
        const form = document.getElementById('status-form');
        if (form) {
          // 全体開催状況
          const overallRadio = form.querySelector(`input[name="overallStatus"][value="${statusData.overallStatus}"]`);
          if (overallRadio) overallRadio.checked = true;
          
          const overallNote = form.querySelector('#overall-note');
          if (overallNote) overallNote.value = statusData.overallNote || '';
          
          // 個別レッスン状況 (APIレスポンスのlessons配列を期待)
          if (statusData.lessons && Array.isArray(statusData.lessons)) {
            // ベーシックコース (最初のレッスンと仮定)
            const basicLessonData = statusData.lessons.find(l => l.courseName && l.courseName.includes('ベーシック'));
            if (basicLessonData) {
              const basicRadio = form.querySelector(`input[name="basicStatus"][value="${basicLessonData.status}"]`);
              if (basicRadio) basicRadio.checked = true;
              const basicNote = form.querySelector('#basic-note');
              if (basicNote) basicNote.value = basicLessonData.note || '';
            }

            // アドバンスコース (次のレッスンと仮定, より堅牢なマッピングが必要な場合あり)
            const advanceLessonData = statusData.lessons.find(l => l.courseName && l.courseName.includes('アドバンス'));
            if (advanceLessonData) {
              const advanceRadio = form.querySelector(`input[name="advanceStatus"][value="${advanceLessonData.status}"]`);
              if (advanceRadio) advanceRadio.checked = true;
              const advanceNote = form.querySelector('#advance-note');
              if (advanceNote) advanceNote.value = advanceLessonData.note || '';
            }
          }
          // Update radio button UI
          setupRadioButtons();
        }
      } catch (error) {
        console.error('レッスン状況の読み込みに失敗:', error);
        showAlert(`レッスン状況の読み込みに失敗しました: ${error.message}`, 'error');
      }
    }

    // レッスン状況フォーム送信 (APIへ)
    async function handleStatusSubmit(e) {
      e.preventDefault();
      const saveButton = document.getElementById('save-status-btn');
      saveButton.disabled = true;
      saveButton.textContent = '保存中...';
      
      try {
        const formData = new FormData(e.target);
        const statusData = {
          overallStatus: formData.get('overallStatus'),
          overallNote: formData.get('overallNote') || '',
          lessons: [ // APIに送信するレッスンの詳細。courseNameはAPI側で設定/参照されることを期待。
            {
              id: 'basic', // 識別子、API側でこれを使って更新や作成を行う
              courseName: 'ベーシックコース（年長〜小3）', // 参考情報として送信
              status: formData.get('basicStatus'),
              note: formData.get('basicNote') || ''
            },
            {
              id: 'advance', // 識別子
              courseName: 'アドバンスコース（小4〜小6）', // 参考情報として送信
              status: formData.get('advanceStatus'),
              note: formData.get('advanceNote') || ''
            }
          ],
          // lastUpdatedはAPI側で設定されるべき
        };

        const response = await fetch('/api/status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(statusData),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: response.statusText }));
          throw new Error(`APIエラー: ${response.status} - ${errorData.message || errorData.error}`);
        }
        
        const result = await response.json();
        console.log('レッスン状況をAPIに保存しました:', result);
        showAlert('✅ レッスン状況が正常に更新されました！', 'success');
        
      } catch (error) {
        console.error('保存エラー:', error);
        showAlert(`❌ 保存に失敗しました: ${error.message}`, 'error');
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = '💾 保存して公開';
      }
    }

    // 記事操作関数
    function createNewArticle() {
      window.location.href = 'editor.html';
    }

    function editArticle(id) {
      window.location.href = `editor.html?id=${id}`;
    }

    async function toggleStatus(id) {
      if (!adminManager) return;
      
      try {
        await adminManager.toggleArticleStatus(id);
        await renderDashboard();
        if (currentTab === 'articles') {
          renderArticleList();
        }
        showAlert('ステータスを更新しました', 'success');
      } catch (error) {
        console.error('ステータス更新エラー:', error);
        showAlert('ステータスの更新に失敗しました', 'error');
      }
    }

    async function deleteArticle(id) {
      if (!adminManager) return;
      
      if (!confirm('この記事を削除してもよろしいですか？')) return;
      
      try {
        await adminManager.deleteArticle(id);
        await renderDashboard();
        if (currentTab === 'articles') {
          renderArticleList();
        }
        showAlert('記事を削除しました', 'success');
      } catch (error) {
        console.error('削除エラー:', error);
        showAlert('記事の削除に失敗しました', 'error');
      }
    }

    // データ操作関数
    function exportData() {
      if (adminManager) {
        adminManager.exportData();
      }
    }

    async function importData() {
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('ファイルを選択してください。');
        return;
      }

      if (adminManager) {
        try {
          await adminManager.importData(file);
          showAlert('✅ データのインポートが完了しました！', 'success');
          await renderDashboard();
        } catch (error) {
          console.error('インポートエラー:', error);
          showAlert(`❌ インポートに失敗しました: ${error.message}`, 'error');
        }
      }
    }

    // ログアウト
    function handleLogout() {
      if (confirm('ログアウトしますか？')) {
        if (adminAuth) {
          adminAuth.logout();
        } else {
          window.location.href = 'login.html';
        }
      }
    }

    // アラート表示
    function showAlert(message, type) {
      const alertArea = document.getElementById('alert-area');
      const alertClass = `alert-${type}`;
      const alertHtml = `
        <div class="alert ${alertClass}">
          ${escapeHtml(message)}
        </div>
      `;
      
      alertArea.innerHTML = alertHtml;
      
      setTimeout(() => {
        alertArea.innerHTML = '';
      }, 5000);
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html> 