<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- メタデータは動的に設定されます -->
  <title>ニュース詳細 - RBS陸上教室</title>
  <meta name="description" content="RBS陸上教室のニュース詳細ページ">
  <meta name="keywords" content="RBS,陸上教室,Running,Brain,School,子ども,スポーツ,ニュース">
  <meta name="robots" content="index, follow">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./assets/images/rds-logo.png">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="./css/header.css">
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="stylesheet" href="./css/components.css">
  <link rel="stylesheet" href="./css/layout.css">
  <link rel="stylesheet" href="./css/news.css">
  <link rel="stylesheet" href="./css/news-detail.css">
  <link rel="stylesheet" href="./css/responsive.css">
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase統合設定 -->
  <script src="./js/config/supabase-config.js"></script>
</head>
<body class="page-news-detail">
  <!-- ヘッダーコンテナ -->
  <div id="header-container"></div>

  <main class="news-detail-content">
    <!-- パンくずナビ -->
    <section class="breadcrumb-section">
      <div class="container">
        <nav class="breadcrumb card-base">
          <ul class="breadcrumb-list">
            <li><a href="./index.html">ホーム</a></li>
            <li><span class="breadcrumb-separator">&gt;</span></li>
            <li><a href="news.html">ニュース</a></li>
            <li><span class="breadcrumb-separator">&gt;</span></li>
            <li><span id="breadcrumb-title">記事詳細</span></li>
          </ul>
        </nav>
      </div>
    </section>

    <!-- 記事ヘッダー（タイトル部分） -->
    <section class="article-header-section">
      <div class="container">
        <div class="article-header-card card-base">
          <div class="article-meta">
            <span class="news-date" id="article-date">
              <i class="fas fa-calendar"></i> 読み込み中...
            </span>
            <span class="news-category" id="article-category">読み込み中...</span>
          </div>
          <h1 class="article-title" id="article-title">記事を読み込み中...</h1>
        </div>
      </div>
    </section>

    <!-- 記事概要セクション -->
    <section id="article-summary-section" class="article-summary-section hidden">
      <div class="container">
        <div class="article-summary-card card-base">
          <div class="summary-header">
            <h2 class="summary-title">
              <i class="fas fa-info-circle"></i>
              記事の概要
            </h2>
          </div>
          <div class="summary-content" id="article-summary">
            <!-- 概要は動的に生成されます -->
          </div>
        </div>
      </div>
    </section>

    <!-- 記事コンテンツ -->
    <section class="article-content-section">
      <div class="container">
        <div class="article-content-card card-base">
          <div class="article-content" id="article-content">
            <div class="loading-message">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <h3>記事を読み込み中...</h3>
              <p>しばらくお待ちください</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- シェアセクション -->
    <section id="share-section" class="share-section hidden">
      <div class="container">
        <div class="share-container card-base">
          <h3 class="section-title">この記事をシェア</h3>
          <div class="share-buttons">
            <button data-action="share-twitter" class="share-btn twitter">
              <img src="./assets/images/sns/x.png" alt="X (Twitter)" width="20" height="20">
              <span>X でシェア</span>
            </button>
            <button data-action="share-facebook" class="share-btn facebook">
              <img src="./assets/images/sns/facebook.png" alt="Facebook" width="20" height="20">
              <span>Facebook でシェア</span>
            </button>
            <button data-action="share-line" class="share-btn line">
              <img src="./assets/images/sns/line.png" alt="LINE" width="20" height="20">
              <span>LINE で送る</span>
            </button>
            <button data-action="copy-url" class="share-btn copy">
              <i class="fas fa-link"></i>
              <span>URL をコピー</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- 関連記事セクション -->
    <section id="related-articles" class="related-articles-section hidden">
      <div class="container">
        <div class="related-articles-container">
          <h2 class="section-title">関連記事</h2>
          <div class="news-grid" id="related-articles-container">
            <!-- 関連記事は動的に生成されます -->
          </div>
        </div>
      </div>
    </section>

    <!-- ナビゲーション -->
    <section class="article-navigation-section">
      <div class="container">
        <div class="article-nav">
          <a href="news.html" class="btn-primary nav-btn">
            <i class="fas fa-arrow-left"></i>
            ニュース一覧に戻る
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- フッターコンテナ -->
  <div id="footer-container"></div>

  <!-- メインアプリケーション（ES6モジュール） -->
  <script type="module" src="./js/app/main.js?v=1.0.3"></script>
  
  <!-- GitHub Pages対応: 非モジュール版フォールバック -->
  <script>
    // ニュース記事の読み込み
    async function loadNewsArticle() {
      try {
        // URLパラメータから記事IDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        
        if (!articleId) {
          showArticleError('記事IDが指定されていません');
          return;
        }
        
        // LPNewsSupabaseServiceを使用
        const { getLPNewsSupabaseService } = await import('./js/features/news/services/LPNewsSupabaseService.js');
        const newsService = await getLPNewsSupabaseService();
        
        const result = await newsService.getArticleById(articleId);
        
        if (result.success && result.data) {
          const article = result.data;
          console.log('記事読み込み成功:', article.title);
          
          displayArticle(article);
        } else {
          console.error('記事読み込み失敗:', result.error);
          showArticleError('記事が見つかりません');
        }
        
      } catch (error) {
        console.error('記事読み込みエラー:', error);
        showArticleError('記事の読み込み中にエラーが発生しました');
      }
    }

    // 記事の表示処理
    function displayArticle(article) {
      // タイトル設定
      document.title = `${article.title} - RBS陸上教室`;
      
      // 記事内容の表示
      const articleContainer = document.getElementById('article-container');
      if (articleContainer) {
        const categoryInfo = getCategoryInfo(article.category);
        const formattedDate = formatDate(article.publishedAt || article.createdAt);
        
        articleContainer.innerHTML = `
          <article class="news-article">
            <header class="article-header">
              <div class="article-meta">
                <span class="article-category ${categoryInfo.class}">${categoryInfo.name}</span>
                <time class="article-date">${formattedDate}</time>
              </div>
              <h1 class="article-title">${article.title}</h1>
            </header>
            <div class="article-content">
              ${article.content}
            </div>
          </article>
        `;
      }
      
      // ローディング状態を非表示
      const loadingStatus = document.getElementById('article-loading-status');
      if (loadingStatus) {
        loadingStatus.style.display = 'none';
      }
    }

    // エラー表示処理
    function showArticleError(message) {
      const articleContainer = document.getElementById('article-container');
      const loadingStatus = document.getElementById('article-loading-status');
      
      if (articleContainer) {
        articleContainer.innerHTML = `
          <div class="article-error">
            <h2>エラー</h2>
            <p>${message}</p>
            <a href="index.html" class="btn-back">トップページに戻る</a>
          </div>
        `;
      }
      
      if (loadingStatus) {
        loadingStatus.style.display = 'none';
      }
    }

    // ヘルパー関数
    function getCategoryInfo(categoryId) {
      const categories = {
        'announcement': { label: 'お知らせ', color: '#4a90e2' },
        'event': { label: '体験会', color: '#50c8a3' },
        'media': { label: 'メディア', color: '#f5a623' },
        'important': { label: '重要', color: '#e74c3c' }
      };
      return categories[categoryId] || { label: 'その他', color: '#6c757d' };
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }
    
    function showRelatedArticles(allArticles, currentArticle) {
      const relatedSection = document.getElementById('related-articles');
      const relatedContainer = document.getElementById('related-articles-container');
      
      if (!relatedSection || !relatedContainer) return;
      
      // 関連記事を検索（同じカテゴリーで異なる記事）
      const relatedArticles = allArticles
        .filter(article => 
          article.id !== currentArticle.id && 
          article.category === currentArticle.category &&
          article.status === 'published'
        )
        .slice(0, 3);
        
      if (relatedArticles.length > 0) {
        const relatedHTML = relatedArticles.map(article => {
          const categoryInfo = getCategoryInfo(article.category);
          const formattedDate = formatDate(article.publishedAt || article.createdAt);
          
          return `
            <article class="news-card related-card">
              <div class="news-card-header">
                <div class="news-meta">
                  <div class="news-date">${formattedDate}</div>
                  <div class="related-category ${article.category}">${categoryInfo.label}</div>
                </div>
                <h3 class="news-title">
                  <a href="news-detail.html?id=${article.id}">${article.title}</a>
                </h3>
              </div>
              <div class="news-card-body">
                <p class="news-excerpt">${(article.summary || generateSummary(article.content)) + '...'}</p>
                <div class="news-actions">
                  <a href="news-detail.html?id=${article.id}" class="news-read-more">続きを読む</a>
                </div>
              </div>
            </article>
          `;
        }).join('');
        
        relatedContainer.innerHTML = relatedHTML;
        relatedSection.classList.remove('hidden');
      }
    }
    
    function generateSummary(content, maxLength = 200) {
      if (!content) return '';
      
      // HTMLタグとマークダウン記法を除去
      let textContent = content
        .replace(/<[^>]*>/g, '') // HTMLタグを除去
        .replace(/#{1,6}\s+/g, '') // マークダウンのヘッダーを除去
        .replace(/\*\*(.*?)\*\*/g, '$1') // 太字マークダウンを除去
        .replace(/\*(.*?)\*/g, '$1') // イタリックマークダウンを除去
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // リンクマークダウンを除去
        .replace(/```[\s\S]*?```/g, '') // コードブロックを除去
        .replace(/`([^`]+)`/g, '$1') // インラインコードを除去
        .replace(/^\s*[-*+]\s+/gm, '') // リスト記号を除去
        .replace(/^\s*\d+\.\s+/gm, '') // 数字リスト記号を除去
        .replace(/^\s*>\s+/gm, '') // 引用記号を除去
        .replace(/^---$|^\*\*\*$|^___$/gm, '') // 水平線を除去
        .replace(/\n\s*\n/g, ' ') // 改行を空白に変換
        .replace(/\s+/g, ' ') // 複数の空白を1つに
        .trim();
      
      if (textContent.length <= maxLength) return textContent;
      
      // 単語境界で切り詰め（日本語対応）
      const truncated = textContent.substring(0, maxLength);
      
      // 最後の句読点や空白で区切る
      const lastPunctuation = Math.max(
        truncated.lastIndexOf('。'),
        truncated.lastIndexOf('、'),
        truncated.lastIndexOf('！'),
        truncated.lastIndexOf('？'),
        truncated.lastIndexOf(' ')
      );
      
      if (lastPunctuation > maxLength * 0.7) {
        return truncated.substring(0, lastPunctuation + 1);
      }
      
      return truncated + '...';
    }
  </script>
  
  <!-- シェア機能 -->
  <script>
    document.addEventListener('click', function(e) {
      const shareBtn = e.target.closest('[data-action^="share"]');
      if (!shareBtn) return;
      
      e.preventDefault();
      
      const action = shareBtn.dataset.action;
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent(document.title);
      
      switch (action) {
        case 'share-twitter':
          window.open(`https://twitter.com/intent/tweet?url=${url}&text=${title}`, '_blank');
          break;
        case 'share-facebook':
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
          break;
        case 'share-line':
          window.open(`https://social-plugins.line.me/lineit/share?url=${url}`, '_blank');
          break;
        case 'copy-url':
          navigator.clipboard.writeText(window.location.href).then(() => {
            const originalText = shareBtn.querySelector('span').textContent;
            shareBtn.querySelector('span').textContent = 'コピーしました！';
            setTimeout(() => {
              shareBtn.querySelector('span').textContent = originalText;
            }, 2000);
          });
          break;
      }
    });
  </script>
</body>
</html> 