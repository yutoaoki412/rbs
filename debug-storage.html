<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalStorage デバッグツール</title>
  <style>
    body { font-family: 'Courier New', monospace; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h2 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
    .key-item { margin: 10px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007acc; }
    .key-name { font-weight: bold; color: #d63384; }
    .key-size { color: #6c757d; font-size: 0.9em; }
    .key-content { margin-top: 10px; max-height: 200px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 4px; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .stat-card { background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-number { font-size: 2em; font-weight: bold; color: #007acc; }
    .stat-label { color: #666; margin-top: 5px; }
    .actions { margin: 20px 0; }
    .btn { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .btn.danger { background: #dc3545; }
    .btn.danger:hover { background: #c82333; }
    .article-preview { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; }
    .article-meta { font-size: 0.8em; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 RBS LocalStorage デバッグツール</h1>
    
    <!-- 統計情報 -->
    <div class="section">
      <h2>📊 ストレージ統計</h2>
      <div class="stats" id="storage-stats">
        <!-- 動的に生成 -->
      </div>
    </div>

    <!-- アクション -->
    <div class="section">
      <h2>⚡ クイックアクション</h2>
      <div class="actions">
        <button class="btn" onclick="refreshData()">🔄 データ更新</button>
        <button class="btn" onclick="createTestData()">🧪 テストデータ作成</button>
        <button class="btn" onclick="exportData()">💾 データエクスポート</button>
        <button class="btn danger" onclick="clearRbsData()">🗑️ RBSデータクリア</button>
      </div>
    </div>

    <!-- 記事データ詳細 -->
    <div class="section">
      <h2>📰 記事データ詳細</h2>
      <div id="articles-detail">
        <!-- 動的に生成 -->
      </div>
    </div>

    <!-- 全LocalStorageキー -->
    <div class="section">
      <h2>🗂️ 全LocalStorageキー</h2>
      <div id="all-keys">
        <!-- 動的に生成 -->
      </div>
    </div>
  </div>

  <script>
    // CONFIG設定（簡易版）
    const CONFIG_KEYS = {
      articles: 'rbs_articles',
      instagram: 'rbs_instagram_posts',
      lessons: 'rbs_lessons',
      settings: 'rbs_settings',
      adminSettings: 'rbs_admin_settings'
    };

    // データ更新
    function refreshData() {
      updateStorageStats();
      updateArticlesDetail();
      updateAllKeys();
    }

    // ストレージ統計更新
    function updateStorageStats() {
      const statsContainer = document.getElementById('storage-stats');
      
      // 基本統計
      const totalKeys = localStorage.length;
      const rbsKeys = getRbsKeys();
      
      // 記事統計
      const articlesData = getStorageData(CONFIG_KEYS.articles);
      const articles = articlesData ? articlesData.data : [];
      const publishedCount = articles.filter(a => a.status === 'published').length;
      const draftCount = articles.filter(a => a.status === 'draft').length;
      
      // Instagram統計
      const instagramData = getStorageData(CONFIG_KEYS.instagram);
      const instagramPosts = instagramData ? instagramData.data : [];
      const activeInstagram = instagramPosts.filter(p => p.status === 'active').length;
      
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${totalKeys}</div>
          <div class="stat-label">総キー数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${rbsKeys.length}</div>
          <div class="stat-label">RBSキー数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${articles.length}</div>
          <div class="stat-label">総記事数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${publishedCount}</div>
          <div class="stat-label">公開記事</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${draftCount}</div>
          <div class="stat-label">下書き</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${instagramPosts.length}</div>
          <div class="stat-label">Instagram投稿</div>
        </div>
      `;
    }

    // 記事詳細更新
    function updateArticlesDetail() {
      const container = document.getElementById('articles-detail');
      const articlesData = getStorageData(CONFIG_KEYS.articles);
      
      if (!articlesData || !articlesData.data || articlesData.data.length === 0) {
        container.innerHTML = '<p style="color: #dc3545;">❌ 記事データが見つかりません</p>';
        return;
      }
      
      const articles = articlesData.data;
      const publishedArticles = articles.filter(a => a.status === 'published');
      
      container.innerHTML = `
        <div style="margin-bottom: 20px;">
          <strong>✅ 記事データ発見:</strong> ${articles.length}件 (公開: ${publishedArticles.length}件)
        </div>
        
        <h4>📋 最新5件の記事:</h4>
        ${articles.slice(0, 5).map(article => `
          <div class="article-preview">
            <strong>${article.title || '無題'}</strong>
            <div class="article-meta">
              ID: ${article.id} | 
              ステータス: <span style="color: ${article.status === 'published' ? 'green' : 'orange'}">${article.status}</span> | 
              カテゴリ: ${article.category} | 
              作成: ${article.createdAt ? new Date(article.createdAt).toLocaleString('ja-JP') : '不明'}
            </div>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
              ${(article.summary || article.content || '').substring(0, 100)}...
            </div>
          </div>
        `).join('')}
        
        <details style="margin-top: 20px;">
          <summary style="cursor: pointer; color: #007acc;">🔍 生データを表示</summary>
          <div class="key-content">
            <pre>${JSON.stringify(articles, null, 2)}</pre>
          </div>
        </details>
      `;
    }

    // 全キー更新
    function updateAllKeys() {
      const container = document.getElementById('all-keys');
      const allKeys = getAllStorageKeys();
      const rbsKeys = allKeys.filter(key => key.startsWith('rbs_'));
      
      container.innerHTML = `
        <h4>🎯 RBS関連キー (${rbsKeys.length}件):</h4>
        ${rbsKeys.map(key => {
          const data = getStorageData(key);
          return `
            <div class="key-item">
              <div class="key-name">${key}</div>
              <div class="key-size">サイズ: ${data.size} | タイプ: ${data.type}</div>
              <details>
                <summary style="cursor: pointer; color: #007acc;">内容を表示</summary>
                <div class="key-content">
                  <pre>${data.preview}</pre>
                </div>
              </details>
            </div>
          `;
        }).join('')}
        
        <h4>🔧 その他のキー (${allKeys.length - rbsKeys.length}件):</h4>
        <div style="font-size: 0.9em; color: #666;">
          ${allKeys.filter(key => !key.startsWith('rbs_')).join(', ')}
        </div>
      `;
    }

    // ヘルパー関数
    function getRbsKeys() {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('rbs_')) {
          keys.push(key);
        }
      }
      return keys;
    }

    function getAllStorageKeys() {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key) keys.push(key);
      }
      return keys.sort();
    }

    function getStorageData(key) {
      try {
        const rawData = localStorage.getItem(key);
        if (!rawData) return null;
        
        const parsed = JSON.parse(rawData);
        return {
          data: parsed,
          size: `${(rawData.length / 1024).toFixed(1)} KB`,
          type: Array.isArray(parsed) ? `Array(${parsed.length})` : typeof parsed,
          preview: JSON.stringify(parsed, null, 2).substring(0, 500) + (rawData.length > 500 ? '...' : '')
        };
      } catch (error) {
        return {
          data: null,
          size: '不明',
          type: 'エラー',
          preview: `パースエラー: ${error.message}`
        };
      }
    }

    // テストデータ作成
    function createTestData() {
      const testArticles = [
        {
          id: `test-${Date.now()}-1`,
          title: 'デバッグ用テスト記事1',
          content: '## テスト記事1\n\nこれはデバッグ用のテスト記事です。',
          category: 'announcement',
          status: 'published',
          summary: 'デバッグ用のテスト記事1です。',
          publishedAt: new Date().toISOString(),
          createdAt: new Date().toISOString(),
          featured: false
        },
        {
          id: `test-${Date.now()}-2`,
          title: 'デバッグ用テスト記事2',
          content: '## テスト記事2\n\nこれもデバッグ用のテスト記事です。',
          category: 'event',
          status: 'published',
          summary: 'デバッグ用のテスト記事2です。',
          publishedAt: new Date(Date.now() - 86400000).toISOString(),
          createdAt: new Date(Date.now() - 86400000).toISOString(),
          featured: true
        }
      ];
      
      localStorage.setItem(CONFIG_KEYS.articles, JSON.stringify(testArticles));
      console.log('✅ テストデータを作成しました:', testArticles);
      
      refreshData();
      alert('✅ テストデータを作成しました！');
    }

    // データエクスポート
    function exportData() {
      const allData = {};
      Object.entries(CONFIG_KEYS).forEach(([name, key]) => {
        const data = getStorageData(key);
        if (data) {
          allData[name] = data.data;
        }
      });
      
      const dataStr = JSON.stringify(allData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `rbs-debug-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
    }

    // RBSデータクリア
    function clearRbsData() {
      if (!confirm('⚠️ RBS関連の全データを削除しますか？この操作は取り消せません。')) {
        return;
      }
      
      const rbsKeys = getRbsKeys();
      rbsKeys.forEach(key => localStorage.removeItem(key));
      
      console.log('🗑️ 削除されたキー:', rbsKeys);
      refreshData();
      alert('🗑️ RBSデータを削除しました！');
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', refreshData);
  </script>
</body>
</html> 